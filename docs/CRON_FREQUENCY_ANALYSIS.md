# 定期同期の頻度設定と制限分析

## 📊 Google Apps Script の制限

### 1. トリガー実行回数制限

| アカウント種別 | 1日の最大実行回数 |
|--------------|----------------|
| **無料アカウント** | 20,000回 |
| **Google Workspace** | 20,000回 |

**結論**: 15分おき（1日96回）でも余裕があります ✅

### 2. 実行時間制限

| アカウント種別 | 1回あたりの最大実行時間 | 1日の合計実行時間 |
|--------------|---------------------|----------------|
| **無料アカウント** | 6分 | 6時間 |
| **Google Workspace** | 30分 | 6時間 |

**注意**: 同期処理が1回あたり6分を超える場合はエラーになります

### 3. Google Calendar API のクォータ

| 項目 | 制限値 |
|------|--------|
| **1日のクォータ** | 1,000,000クォータ単位 |
| **1分あたりのクォータ** | 600クォータ単位 |

**クォータ消費の目安**:
- イベント取得（list）: 1回あたり約1-5クォータ
- イベント更新（update）: 1回あたり約5-10クォータ
- イベント作成（create）: 1回あたり約50クォータ

---

## 🔢 頻度別の実行回数計算

### パターン1: 1時間おき + 高頻度同期（推奨）

| 項目 | 実行回数 |
|------|---------|
| **通常時（1時間おき）** | 1日24回 |
| **土日13時前後（5分おき）** | 週8回（土日 × 4回/日） |
| **合計（週）** | 週176回（24回/日 × 7日 + 8回） |
| **合計（月）** | 約760回 |

**評価**: ✅ **非常に安全** - 制限の約4%のみ使用

### パターン2: 15分おき + 高頻度同期

| 項目 | 実行回数 |
|------|---------|
| **通常時（15分おき）** | 1日96回 |
| **土日13時前後（5分おき）** | 週8回（土日 × 4回/日） |
| **合計（週）** | 週680回（96回/日 × 7日 + 8回） |
| **合計（月）** | 約2,920回 |

**評価**: ⚠️ **制限内だが注意が必要** - 制限の約15%を使用

### パターン3: 30分おき + 高頻度同期

| 項目 | 実行回数 |
|------|---------|
| **通常時（30分おき）** | 1日48回 |
| **土日13時前後（5分おき）** | 週8回（土日 × 4回/日） |
| **合計（週）** | 週344回（48回/日 × 7日 + 8回） |
| **合計（月）** | 約1,480回 |

**評価**: ✅ **安全** - 制限の約7%のみ使用

---

## ⚠️ リスク分析

### 15分おき + 高頻度同期のリスク

#### 1. 実行時間制限のリスク

**リスク**: 同期処理が1回あたり6分を超える場合、エラーになる

**対策**:
- 表示期間を設定して同期対象を絞る（既に実装済み）
- イベント数が多い場合は、30分おきに変更を検討

**判定**: ⚠️ **中リスク** - イベント数が多い場合に注意が必要

#### 2. API呼び出し制限のリスク

**リスク**: Google Calendar APIのクォータを超過する可能性

**計算例**（1回の同期で）:
- イベント数: 50件
- イベント取得: 50件 × 2クォータ = 100クォータ
- イベント更新: 50件 × 5クォータ = 250クォータ
- **合計**: 約350クォータ/回

**15分おきの場合**:
- 1日: 96回 × 350クォータ = 33,600クォータ/日
- **1日のクォータ**: 1,000,000クォータ
- **使用率**: 約3.4% ✅

**判定**: ✅ **低リスク** - 通常の使用量では問題なし

#### 3. 実行回数制限のリスク

**リスク**: 1日の実行回数が20,000回を超える

**15分おきの場合**:
- 1日: 96回
- **制限**: 20,000回/日
- **使用率**: 約0.5% ✅

**判定**: ✅ **非常に低リスク** - 余裕あり

---

## 💡 推奨設定

### 推奨1: 1時間おき + 高頻度同期 ⭐⭐⭐

**メリット**:
- ✅ 最も安全（制限の約4%のみ使用）
- ✅ API呼び出しを最小化
- ✅ 実行時間制限のリスクが低い
- ✅ 通常時は1時間遅延で十分

**デメリット**:
- ⚠️ 通常時の反映がやや遅い（最大1時間）

**判定**: ✅ **最も推奨** - 安全で効率的

### 推奨2: 30分おき + 高頻度同期 ⭐⭐

**メリット**:
- ✅ 安全（制限の約7%のみ使用）
- ✅ 通常時の反映が速い（最大30分）

**デメリット**:
- ⚠️ API呼び出しがやや多い

**判定**: ✅ **推奨** - バランスが良い

### 推奨3: 15分おき + 高頻度同期 ⭐

**メリット**:
- ✅ 通常時の反映が速い（最大15分）
- ✅ 制限内ではある

**デメリット**:
- ⚠️ API呼び出しが多い（制限の約15%）
- ⚠️ 実行時間制限のリスクがやや高い
- ⚠️ イベント数が多い場合に注意が必要

**判定**: ⚠️ **条件付き推奨** - イベント数が少ない場合のみ

---

## 🎯 最終推奨

### イベント数による推奨設定

| イベント数 | 推奨設定 | 理由 |
|-----------|---------|------|
| **50件以下** | 15分おき + 高頻度 | 実行時間が短く、安全 |
| **50-100件** | 30分おき + 高頻度 | バランスが良い |
| **100件以上** | 1時間おき + 高頻度 | 実行時間制限のリスクを回避 |

### 一般的な推奨

**推奨: 1時間おき + 高頻度同期**

**理由**:
1. **安全性**: 制限の約4%のみ使用で最も安全
2. **効率性**: API呼び出しを最小化
3. **実用性**: 通常時は1時間遅延で十分
4. **練習前**: 土日13時前後は5分おきで即座に対応

---

## 📝 設定変更方法

### トリガーの頻度を変更する場合

1. GASエディタを開く
2. 「トリガー」タブを開く
3. `scheduledSync` のトリガーを編集
4. 「時間ベースのトリガー」を変更
5. 「保存」をクリック

### 頻度変更の影響

| 変更前 | 変更後 | 影響 |
|--------|--------|------|
| 1時間おき | 15分おき | API呼び出しが4倍に増加 |
| 15分おき | 1時間おき | API呼び出しが1/4に減少 |

---

## 🔍 モニタリング方法

### 実行ログの確認

1. GASエディタの「実行数」タブを開く
2. 実行時間を確認
3. 6分を超える場合は頻度を下げる

### エラーログの確認

1. GASエディタの「実行数」タブを開く
2. エラーが発生している場合は確認
3. 実行時間制限エラーの場合は頻度を下げる

---

## ✅ 結論

### 15分おき + 高頻度同期について

**判定**: ⚠️ **制限内だが、推奨しない**

**理由**:
1. 実行回数制限: ✅ 問題なし（0.5%使用）
2. API呼び出し: ✅ 問題なし（約3.4%使用）
3. 実行時間制限: ⚠️ **注意が必要**（イベント数が多い場合）

**推奨**: **1時間おき + 高頻度同期** が最も安全で効率的

**理由**:
- 通常時は1時間遅延で十分
- 練習前（土日13時前後）は5分おきで即座に対応
- 制限のリスクを最小化

