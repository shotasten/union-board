# 定期同期（cron）セットアップガイド

## 概要

Google Apps Script のトリガー機能を使用して、カレンダーとアプリ間のイベント同期を自動化します。

---

## 実装内容

### 1. 同期関数の実装

#### `scheduledSync()` - cron用の定期同期関数

**場所:** `src/main.ts`

**機能:**
- 表示期間（`DISPLAY_START_DATE` ～ `DISPLAY_END_DATE`）のイベントのみを同期
- カレンダー → アプリの同期を実行
- アプリ → カレンダーの説明欄同期を実行

**呼び出し方法:**
Google Apps Script のトリガーで自動実行

---

### 2. 同期範囲の制御

#### `syncAll(limitToDisplayPeriod: boolean = false)`

**パラメータ:**
- `limitToDisplayPeriod`: 表示期間のみに制限するか
  - `true`: 表示期間（`DISPLAY_START_DATE` ～ `DISPLAY_END_DATE`）のみ
  - `false`: 全期間（デフォルト：30日前～1年後）

#### `pullFromCalendar(calendarId?, startDate?, endDate?)`

**パラメータ:**
- `startDate`: 取得開始日時（省略時：30日前）
- `endDate`: 取得終了日時（省略時：1年後）

#### `syncAllEvents(userKey?, adminToken?, limitToDisplayPeriod: boolean = true)`

**パラメータ:**
- `limitToDisplayPeriod`: 表示期間のみに制限するか（デフォルト: `true`）

---

## 同期動作の整理

### ✅ アプリのsyncボタン（手動）

**動作:**
- 表示期間（`DISPLAY_START_DATE` ～ `DISPLAY_END_DATE`）のイベントのみを同期
- `syncAllEvents(userKey, adminToken, true)` を呼び出し

**理由:**
- ユーザーは表示期間内のイベントのみを管理する想定
- 不要な期間の同期を避けることで処理時間を短縮

---

### ✅ cronで実行する定期同期（自動）

**動作:**
- 表示期間（`DISPLAY_START_DATE` ～ `DISPLAY_END_DATE`）のイベントのみを同期
- `scheduledSync()` を呼び出し

**理由:**
- カレンダー側で直接編集された変更を自動でアプリに反映
- 表示期間外のイベントは同期不要

---

### ⚠️ 手動で関数を直接呼び出した場合

**動作:**
- 全期間（デフォルト：30日前～1年後）のイベントを同期
- `syncAll(false)` または `syncAll()` を呼び出し

**理由:**
- デバッグや特殊な運用のため
- 明示的に全期間を同期したい場合に使用

---

## トリガーの設定方法

### 手順

1. **Google Apps Script エディタを開く**
   - スプレッドシートから `拡張機能` → `Apps Script` を選択

2. **トリガーを追加**
   - 左側メニューから `トリガー` （時計アイコン）をクリック
   - 右下の `+ トリガーを追加` をクリック

3. **トリガーの設定**
   - **実行する関数:** `scheduledSync`
   - **イベントのソース:** `時間主導型`
   - **時間ベースのトリガー:** 以下から選択
     - **推奨: 15分おき** （バランス良い）
     - 高頻度: 5分おき（カレンダーAPI呼び出しが増える）
     - 低頻度: 1時間おき（反映が遅い）

4. **保存**
   - `保存` をクリック
   - 初回実行時に権限の承認が求められる場合があります

---

## 推奨設定

### トリガー頻度

| 頻度 | メリット | デメリット |
|-----|---------|----------|
| **5分おき** | カレンダーの変更が即座に反映 | API呼び出しが多い |
| **15分おき** ⭐ | バランスが良い | 標準的な反映速度 |
| **1時間おき** | API呼び出しが少ない | 反映が遅い |

**推奨: 15分おき**
- カレンダー側の変更が15分以内に反映される
- API呼び出し回数も適切（1日96回）
- Google Apps Script の実行時間制限にも余裕

---

## 表示期間の設定

### 管理者画面から設定

1. アプリにアクセス
2. 管理者ログイン
3. 設定パネル → 表示期間を設定
4. `DISPLAY_START_DATE`: 例 `2025-04-01`
5. `DISPLAY_END_DATE`: 例 `2026-03-31`

### スプレッドシートから直接設定

1. `Config` シートを開く
2. `DISPLAY_START_DATE` 行の値を編集（例: `2025-04-01`）
3. `DISPLAY_END_DATE` 行の値を編集（例: `2026-03-31`）

---

## ログの確認

### 実行ログの確認方法

1. Google Apps Script エディタを開く
2. 左側メニューから `実行数` をクリック
3. `scheduledSync` の実行履歴を確認

### ログの内容

```
=== 定期同期開始（表示期間のみ） ===
=== 全イベント同期開始 ===
📅 表示期間に制限: 2025-04-01T00:00:00.000Z ～ 2026-03-31T23:59:59.999Z
=== カレンダー → アプリ同期開始 ===
カレンダーイベント取得範囲: 2025-04-01T00:00:00.000Z ～ 2026-03-31T23:59:59.999Z
✅ カレンダーイベント取得: 15件
📋 カレンダー → アプリ同期完了: 成功 15件, 失敗 0件
=== アプリ → カレンダー説明欄同期開始 ===
📋 説明欄同期対象イベント数: 15件
📋 説明欄同期完了: 成功 15件, 失敗 0件
✅ 定期同期完了: 成功 30件, 失敗 0件
```

---

## トラブルシューティング

### トリガーが実行されない

**原因:**
- トリガーが正しく設定されていない
- 関数名が間違っている

**対処法:**
1. トリガー設定を確認（関数名: `scheduledSync`）
2. トリガーを削除して再度追加

---

### 同期エラーが発生する

**原因:**
- 表示期間の設定が不正
- カレンダーへのアクセス権限がない

**対処法:**
1. 実行ログを確認してエラー内容を特定
2. `Config` シートの設定を確認
3. 権限を再承認

---

### カレンダー側の変更が反映されない

**原因:**
- トリガーが停止している
- 表示期間外のイベントを編集している

**対処法:**
1. トリガーが有効になっているか確認
2. 編集したイベントが表示期間内か確認
3. 手動で同期ボタンを押して確認

---

## まとめ

### 設定後の動作

✅ **アプリのsyncボタン（手動）:**
- 表示期間内のイベントのみ同期
- ユーザーが手動で実行

✅ **cronの定期同期（自動）:**
- 表示期間内のイベントのみ同期
- 15分おき（推奨）に自動実行

✅ **個別のイベント操作:**
- 出欠登録・コメント → その予定だけリアルタイム同期
- イベント編集・削除 → その予定だけリアルタイム同期

### 性能最適化

- 表示期間に制限することで、不要な期間の同期を避ける
- 処理時間の短縮
- API呼び出し回数の削減

