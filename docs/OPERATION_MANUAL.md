# 運用マニュアル

UnionBoard（出欠管理アプリ）の日常的な運用方法を説明します。

---

## 📋 目次

1. [基本操作](#基本操作)
2. [メンバー管理](#メンバー管理)
3. [カレンダー連携](#カレンダー連携)
4. [表示期間管理](#表示期間管理)
5. [管理者機能](#管理者機能)
6. [トラブルシューティング](#トラブルシューティング)
7. [データ管理](#データ管理)

---

## 基本操作

### イベントの作成

1. Webアプリにアクセス
2. 管理者ログイン（右上の「🔐 管理者ログイン」）
3. ヘッダーの「+ 新しいイベントを作成」ボタンをクリック
4. イベント情報を入力：
   - **タイトル**: イベント名（例: "練習"、"演奏会"）
   - **開始日時** / **終了日時**: イベントの日時
   - **終日**: チェックすると終日イベントになります
   - **場所**: 練習場所（履歴から選択可能）
   - **説明**: イベントの詳細説明
5. 「保存」をクリック

**注意**:
- イベント作成には管理者権限が必要です
- 作成と同時にGoogleカレンダーにも登録されます

### イベントの編集

1. イベントカードまたは詳細画面の「編集」ボタン（✏️）をクリック
2. イベント情報を編集
3. 「保存」をクリック

**注意**:
- 編集と同時にGoogleカレンダーも更新されます
- 終日⇔時間指定の変更も可能です

### イベントの削除

1. イベントカードまたは詳細画面の「削除」ボタン（🗑️）をクリック
2. 確認ダイアログで「削除」をクリック

**注意**:
- 削除は論理削除（status: 'deleted'）で、Spreadsheetにはデータが残ります
- Googleカレンダーからは完全に削除されます
- 出欠データは保持されます（監査目的）

### 出欠登録

#### 個別登録

1. イベントカードの「○ 出席」「△ 遅刻/早退」「× 欠席」ボタンをクリック
2. 初回の場合、表示名を入力（例: "Fl田中"、"Tp佐藤"）
3. 必要に応じてコメントを入力
4. 「送信」をクリック

**注意**:
- 表示名は「パート名 + 名前」の形式を推奨
- 登録後、即座にカレンダーに反映されます

#### 一括登録

1. 複数のイベントの出欠を選択
2. まとめて「保存」をクリック
3. 高速バッチ処理で一括登録

### 出欠状況の確認

#### イベントカード
- イベントカードの下部に集計が表示されます
- 「○: X人」「△: Y人」「×: Z人」「合計: N人」

#### イベント詳細
1. イベントカードをクリック
2. イベント詳細モーダルが表示
3. 表示内容：
   - **イベント情報**: 日時、場所、説明
   - **コメント一覧**: 各メンバーのコメント
   - **パート別内訳**: パートごとの出欠状況

---

## メンバー管理

### メンバー登録

**自動登録**:
- 初回出欠登録時に自動でMembersシートに登録されます
- 表示名から「パート」と「名前」を自動判別

**パート一覧**:
- Fl, Ob, Cl, Sax, Hr, Tp, Tb, Bass, Perc, その他

**表示名の形式**:
```
推奨: Fl田中、Tp.佐藤、Bass山田
自動認識: パート名（Fl, Ob等）を先頭に配置
```

### メンバー情報の確認

1. GASエディタでSpreadsheetを開く
2. 「Members」シートを選択
3. メンバー一覧を確認

**列構成**:
- userKey: ユーザー識別子
- part: パート（Fl, Tp等）
- name: 名前
- displayName: 表示名（パート + 名前）
- createdAt: 登録日時
- updatedAt: 更新日時

### メンバー情報の修正

1. Membersシートで直接編集
2. 次回の出欠登録時に反映されます

**注意**:
- userKeyは変更しないでください
- partは既定のパート名を使用してください

---

## カレンダー連携

### カレンダー同期の仕組み

#### 自動同期（リアルタイム）

以下の操作時に自動でカレンダーに反映されます：

| 操作 | 同期内容 | 同期範囲 |
|-----|---------|---------|
| **イベント作成** | イベント情報 | その予定だけ |
| **イベント編集** | イベント情報 | その予定だけ |
| **イベント削除** | カレンダーから削除 | その予定だけ |
| **出欠登録** | 出欠状況 + コメント | その予定だけ |
| **コメント更新** | コメント | その予定だけ |

#### カレンダーの説明欄

Googleカレンダーのイベント説明欄には以下が自動で表示されます：

```
（ユーザーが入力した説明）

【出欠状況】
○ 参加: 30人
△ 遅早: 5人
× 欠席: 2人
- 未定: 0人
合計: 37人

【コメント】
○ [Fl] 田中: よろしくお願いします
△ [Tp] 佐藤: 遅刻します
× [Cl] 山田: 欠席します
（コメントなし）

最終更新: 2025-11-12 15:30
```

※ アプリ上のボタンや表示は「△ 遅刻/早退」ですが、カレンダー説明欄ではスペースの都合で「△ 遅早」と省略表記されます。

### 手動同期

#### イベント同期ボタン

1. 管理者ログイン
2. ヘッダーの「🔄」（同期）ボタンをクリック
3. 表示期間内のイベントが一括同期されます

**同期内容**:
- カレンダー → アプリ: カレンダー側の変更を取り込み
- アプリ → カレンダー: 出欠状況・コメントを反映

### 定期同期（cron）

カレンダー側で直接編集した変更を自動でアプリに反映します。

#### 設定方法

詳細は [定期同期設定ガイド](CRON_SYNC_SETUP_GUIDE.md) を参照してください。

**設定手順**:
1. GASエディタを開く
2. トリガーを追加
3. 関数: `scheduledSyncResponsesToCalendar`
4. イベントソース: 時間主導型
5. 頻度: 15分おき（推奨）

**同期範囲**:
- 表示期間（DISPLAY_START_DATE ～ DISPLAY_END_DATE）のみ
- 表示期間外のイベントは同期対象外

### カレンダー → アプリ同期

**カレンダーで編集した場合**:
- タイトル、日時、場所、説明の変更がアプリに反映
- 次回の同期時（手動同期または定期同期）に取り込まれます

**注意**:
- 出欠情報はアプリ側が優先されます
- カレンダー側で削除したイベントは、アプリ側でも削除（論理削除）されます

---

## 表示期間管理

### 表示期間とは

アプリに表示するイベントの期間を制限する機能です。

**用途**:
- 年度単位の管理（例: 2025年4月1日 ～ 2026年3月31日）
- 過去の不要なイベントを非表示にする
- 同期処理の効率化

### 表示期間の設定

#### 管理者画面から設定

1. 管理者ログイン
2. 設定パネルを開く
3. 「表示期間」セクションで設定
   - **開始日**: 例 `2025-04-01`
   - **終了日**: 例 `2026-03-31`
4. 「保存」をクリック

#### Spreadsheetから直接設定

1. GASエディタでSpreadsheetを開く
2. 「Config」シートを選択
3. 以下の行を編集：
   - `DISPLAY_START_DATE`: 例 `2025-04-01`
   - `DISPLAY_END_DATE`: 例 `2026-03-31`

### 表示期間の効果

**アプリ画面**:
- 表示期間内のイベントのみ表示
- 過去・未来問わず、期間内であれば全て表示

**カレンダー同期**:
- イベント同期ボタン: 表示期間のみ同期
- 定期同期（cron）: 表示期間のみ同期
- 個別のイベント操作: 表示期間に関わらず同期

**表示期間が未指定の場合**:
- `DISPLAY_START_DATE` と `DISPLAY_END_DATE` が両方とも空の場合、デフォルト期間が適用されます
- **デフォルト期間**: 現在日時から **30日前** ～ **1年後**
- 例: 2025年11月12日の場合 → 2025年10月13日 ～ 2026年11月12日
- このデフォルト期間は、カレンダー同期の効率化のため設定されています

**年度切り替え時**:
1. 新年度の開始前に表示期間を更新
2. 例: 4月1日に `2025-04-01` ～ `2026-03-31` に設定
3. 旧年度のイベントは自動的に非表示になります

---

## 管理者機能

### 管理者ログイン

#### 初回ログイン

1. GASエディタで `getAllConfig` 関数を実行（または `getConfig('ADMIN_TOKEN', '')` を実行）
2. 実行ログから `ADMIN_TOKEN` の値をコピー
3. WebアプリのURLに以下を追加：
   ```
   https://script.google.com/.../exec?admin=YOUR_ADMIN_TOKEN
   ```
4. アクセスすると管理者としてログイン

#### 2回目以降

1. Webアプリにアクセス
2. 右上の「🔐 管理者ログイン」をクリック
3. 管理者トークンを入力
4. 「ログイン」をクリック

**注意**:
- トークンはブラウザのlocalStorageに保存されます
- 次回アクセス時は自動でログイン状態になります

### 管理者機能一覧

| 機能 | 説明 |
|-----|------|
| **イベント作成** | 新しいイベントを作成 |
| **イベント編集** | 既存イベントの編集 |
| **イベント削除** | イベントの削除 |
| **イベント同期** | カレンダーとの一括同期 |
| **表示期間設定** | 表示期間の設定 |
| **全データ削除** | 全イベント・出欠データの削除（注意） |

### 場所履歴機能

**使用方法**:
1. イベント作成・編集フォームで「場所」入力欄の横の「📋」ボタンをクリック
2. 直近の場所履歴が表示されます
3. 場所をクリックすると、入力欄に自動入力されます

**場所履歴の仕組み**:
- 過去のイベントの場所を自動収集
- 使用頻度の高い順に表示
- 重複は自動で削除

---

## トラブルシューティング

### イベントが表示されない

**原因1**: 表示期間外のイベント

**対処法**:
1. Configシートの `DISPLAY_START_DATE`、`DISPLAY_END_DATE` を確認
2. 表示期間を調整するか、該当イベントの日時を確認

**原因2**: status が deleted

**対処法**:
1. Eventsシートでイベントを確認
2. status列が 'deleted' の場合は削除済み
3. 復元する場合は status を 'active' に変更

**原因3**: ブラウザキャッシュ

**対処法**:
- ブラウザをリロード（Ctrl + F5 または Cmd + Shift + R）

### 出欠登録ができない

**原因1**: 表示名が未設定

**対処法**:
- 初回登録時に表示名を入力してください
- 形式: 「パート名 + 名前」（例: Fl田中）

**原因2**: レート制限

**対処法**:
- 1分に5回以上の登録を行うと制限されます
- しばらく待ってから再試行してください

**原因3**: JavaScriptエラー

**対処法**:
1. ブラウザのコンソールを開く（F12）
2. エラーメッセージを確認
3. 開発者に報告

### カレンダー同期が失敗する

**原因1**: カレンダーIDが未設定

**対処法**:
1. Configシートの `CALENDAR_ID` を確認
2. 専用カレンダーのIDを設定
3. カレンダーIDの取得方法:
   - Googleカレンダーで該当カレンダーの設定を開く
   - 「カレンダーの統合」→「カレンダーID」をコピー

**原因2**: アクセス権限がない

**対処法**:
1. カレンダーの共有設定を確認
2. スクリプト実行者にオーナー権限を付与

**原因3**: notesHashの不一致

**対処法**:
1. Eventsシートの `notesHash` 列をクリア
2. イベント同期ボタンを押して再同期

### 管理者機能が使えない

**原因1**: トークンが間違っている

**対処法**:
1. `localStorage.getItem('adminToken')` で確認
2. 正しいトークンを再入力
3. `getAllConfig` 関数を実行してトークンを確認（または `getConfig('ADMIN_TOKEN', '')` を実行）

**原因2**: localStorageがクリアされた

**対処法**:
- 管理者ログイン画面から再度ログイン

### 定期同期が実行されない

**原因1**: トリガーが設定されていない

**対処法**:
1. GASエディタの「トリガー」を確認
2. `scheduledSync` 関数のトリガーを追加
3. [定期同期設定ガイド](CRON_SYNC_SETUP_GUIDE.md) を参照

**原因2**: 実行時エラー

**対処法**:
1. GASエディタの「実行数」タブを確認
2. エラーログを確認
3. 表示期間の設定を確認

---

## データ管理

### Spreadsheetの確認

#### アクセス方法

**方法1**: GASエディタから
1. GASエディタを開く
2. `getAllConfig` 関数を実行（または `getConfig('ADMIN_TOKEN', '')` を実行）
3. 実行ログから Spreadsheet URL を取得

**方法2**: Script Propertiesから
1. GASエディタの「プロジェクトの設定」
2. 「スクリプト プロパティ」
3. `SPREADSHEET_ID` の値を確認
4. `https://docs.google.com/spreadsheets/d/[SPREADSHEET_ID]/edit` にアクセス

#### シート構成

| シート名 | 説明 | 主要列 |
|---------|------|--------|
| **Events** | イベント情報 | id, title, start, end, location, calendarEventId, status |
| **Members** | メンバー情報 | userKey, part, name, displayName |
| **Responses** | 出欠情報 | eventId, userKey, status, comment |
| **Config** | 設定情報 | key, value |

### データのバックアップ

#### 手動バックアップ

1. Spreadsheetを開く
2. 「ファイル」→「コピーを作成」
3. コピー名に日付を含める（例: UnionBoard_backup_20251112）

#### 自動バックアップ（推奨）

**設定方法**:
1. GASエディタでトリガーを追加
2. 関数: `backupData`（カスタム関数を作成）
3. イベントソース: 時間主導型
4. 頻度: 週1回（例: 日曜日 AM 3:00）

### データの復元

#### Spreadsheetから復元

1. バックアップSpreadsheetを開く
2. 必要なシートをコピー
3. 本番Spreadsheetに貼り付け

**注意**:
- 列の順序を変更しないでください
- ヘッダー行は削除しないでください

#### カレンダーから復元

1. イベント同期ボタンを押す
2. カレンダー側のイベント情報がアプリに取り込まれます

### データのクリーンアップ

#### 古いイベントの削除

**手動削除**:
1. Eventsシートで該当イベントを選択
2. status列を 'deleted' に変更

**一括削除**（管理者機能）:
1. 管理者ログイン
2. 「全データ削除」ボタン（危険！）
3. 確認ダイアログで「削除」

**注意**:
- 全データ削除は復元できません
- 実行前に必ずバックアップを取ってください

---

## パフォーマンス

### 最適化のヒント

#### 表示期間を設定する
- 過去の不要なイベントを表示期間外に設定
- 処理時間が短縮されます

#### 定期同期の頻度を調整する
- 頻度を下げると API呼び出しが減ります
- 推奨: 15分おき

#### ブラウザキャッシュをクリアする
- 定期的にキャッシュをクリア
- ハードリロード: Ctrl + F5（Windows）、Cmd + Shift + R（Mac）

### 処理時間の目安

| 操作 | 処理時間（目安） |
|-----|---------------|
| 初回読み込み | 2-3秒 |
| 出欠登録（1件） | 0.5-1秒 |
| 出欠一括登録（10件） | 1-2秒 |
| イベント同期（15件） | 5-10秒 |

---

## セキュリティ

### 管理者トークンの管理

**保管方法**:
- 安全な場所に保管（パスワード管理アプリ推奨）
- 他人に共有しない

**漏洩時の対応**:
1. `getAllConfig` 関数を再実行（または `getConfig('ADMIN_TOKEN', '')` を実行）
2. 新しいトークンを確認（既存のトークンが表示されます）
3. トークンを変更する場合は、Configシートで直接編集するか、`setConfig('ADMIN_TOKEN', '新しいトークン')` を実行

### レート制限

**匿名モードの制限**:
- 同一ユーザーで1分以内に5回まで
- 超過時は60秒のクールダウン

**対処法**:
- 短時間に大量の操作をしない
- 一括登録機能を活用する

---

## サポート

問題が発生した場合は、以下を確認してください：

1. **ブラウザのコンソール**:
   - F12を押してコンソールを開く
   - エラーメッセージを確認

2. **GASエディタの実行ログ**:
   - 「実行数」タブでエラーを確認
   - Logger.log() の出力を確認

3. **Spreadsheetのデータ**:
   - 各シートのデータを確認
   - 不正なデータがないかチェック

4. **ドキュメントを確認**:
   - [仕様書](SPECIFICATION.md)
   - [セットアップ手順](SETUP_GUIDE.md)
   - [定期同期設定ガイド](CRON_SYNC_SETUP_GUIDE.md)

それでも解決しない場合は、開発者に連絡してください。
