<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>UnionBoard</title>
  <!-- Updated: 2025-11-08 Phase 3.7: èªè¨¼UIå®Ÿè£…ï¼ˆGoogleèªè¨¼æ©Ÿèƒ½ã¯å‰Šé™¤æ¸ˆã¿ï¼‰ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #fafafa;
      min-height: 100vh;
      padding: 20px;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      width: 100%;
    }

    header {
      background: #F5F5F5;
      color: #333;
      padding: 20px 30px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      width: 100%;
    }

    .header-action-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    header h1 {
      font-size: 1.8rem;
      font-weight: bold;
      color: #333;
      margin: 0;
    }

    header p {
      font-size: 0.95rem;
      color: #888;
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .admin-login-btn {
      background: transparent;
      color: #666;
      border: 1px solid #ddd;
      padding: 8px 16px;
      font-size: 0.9rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: normal;
      white-space: nowrap;
    }

    .admin-login-btn:hover {
      background: #f5f5f5;
      border-color: #bbb;
    }

    /* ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€åŒæœŸã€å‰Šé™¤ï¼‰ */
    .icon-action-btn {
      background: transparent;
      border: 1px solid #00796B;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }

    .icon-action-btn i {
      color: #00796B;
      font-size: 1.1rem;
    }

    .icon-action-btn:hover {
      background: #E0F2F1;
    }

    .cleanup-btn.icon-action-btn {
      border-color: #f44336;
    }

    .cleanup-btn.icon-action-btn i {
      color: #f44336;
    }

    .cleanup-btn.icon-action-btn:hover {
      background: #ffebee;
    }

    /* ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¼ãƒœã‚¿ãƒ³ï¼ˆæ–°è¦ä½œæˆï¼‰ã¯ãã®ã¾ã¾ç¶­æŒ */
    .primary-btn {
      background: #00796B;
      color: white;
      border: 1px solid #00796B;
      padding: 8px 16px;
      font-size: 0.9rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      white-space: nowrap;
    }

    .primary-btn:hover {
      background: #00695C;
      border-color: #00695C;
    }

    .create-event-btn {
      background: #00796B;
      color: white;
      border: 1px solid #00796B;
      padding: 8px 16px;
      font-size: 0.9rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      white-space: nowrap;
    }

    .create-event-btn:hover {
      background: #00695C;
      border-color: #00695C;
    }

    /* ç®¡ç†è€…å°‚ç”¨æ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    /* .admin-feature ã‚¯ãƒ©ã‚¹ã¯ç®¡ç†è€…å°‚ç”¨æ©Ÿèƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒãƒ¼ã‚«ãƒ¼ã¨ã—ã¦ä½¿ç”¨ */

    main {
      padding: 30px;
      background: #fafafa;
    }

    .container {
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      margin: 20px auto;
      max-width: 1400px;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
    .loading {
      text-align: center;
      padding: 40px;
      color: #00796B;
      font-size: 1.2rem;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #00796B;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
    .error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    /* è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
    .view-toggle {
      display: flex;
      gap: 0;
      justify-content: flex-end;
      margin-bottom: 30px;
      background: #f5f5f5;
      border-radius: 8px;
      padding: 4px;
      width: fit-content;
      margin-left: auto;
    }

    .view-btn {
      padding: 8px 20px;
      border: none;
      background: transparent;
      color: #666;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      font-weight: 500;
    }

    .view-btn:hover {
      background: rgba(0, 121, 107, 0.1);
      color: #00796B;
    }

    .view-btn.active {
      background: #00796B;
      color: white;
    }

    /* è¡¨å½¢å¼UI */
    .attendance-grid-wrapper {
      position: relative;
      width: 100%;
    }

    .attendance-grid-container {
      overflow-x: auto;
      overflow-y: visible;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      width: 100%;
      position: relative;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç›®ç«‹ãŸã›ã‚‹ */
      scrollbar-width: thin;
      scrollbar-color: #00796B #f0f0f0;
    }

    /* ä¸Šéƒ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    .attendance-grid-scrollbar-top {
      overflow-x: auto;
      overflow-y: hidden;
      height: 12px;
      width: 100%;
      margin-bottom: 4px;
      border: 1px solid #e0e0e0;
      border-radius: 8px 8px 0 0;
      background: #f0f0f0;
      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç›®ç«‹ãŸã›ã‚‹ */
      scrollbar-width: thin;
      scrollbar-color: #667eea #f0f0f0;
      display: none; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªå ´åˆã®ã¿è¡¨ç¤º */
    }

    .attendance-grid-scrollbar-top.visible {
      display: block;
    }

    .attendance-grid-scrollbar-top::-webkit-scrollbar {
      height: 12px;
    }

    .attendance-grid-scrollbar-top::-webkit-scrollbar-track {
      background: #f0f0f0;
      border-radius: 6px;
    }

    .attendance-grid-scrollbar-top::-webkit-scrollbar-thumb {
      background: #00796B;
      border-radius: 6px;
    }

    .attendance-grid-scrollbar-top::-webkit-scrollbar-thumb:hover {
      background: #00695C;
    }

    /* Webkitç³»ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
    .attendance-grid-container::-webkit-scrollbar {
      height: 12px;
    }

    .attendance-grid-container::-webkit-scrollbar-track {
      background: #f0f0f0;
      border-radius: 6px;
    }

    .attendance-grid-container::-webkit-scrollbar-thumb {
      background: #00796B;
      border-radius: 6px;
    }

    .attendance-grid-container::-webkit-scrollbar-thumb:hover {
      background: #00695C;
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªå ´åˆã®å·¦å³ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆåŠ¹æœ */
    .attendance-grid-container::before,
    .attendance-grid-container::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      width: 30px;
      pointer-events: none;
      z-index: 2;
      transition: opacity 0.2s ease;
      opacity: 0;
    }

    .attendance-grid-container::before {
      left: 0;
      background: linear-gradient(to right, rgba(255, 255, 255, 0.95), transparent);
    }

    .attendance-grid-container::after {
      right: 0;
      background: linear-gradient(to left, rgba(255, 255, 255, 0.95), transparent);
    }

    .attendance-grid-container.scrollable-left::before {
      opacity: 1;
    }

    .attendance-grid-container.scrollable-right::after {
      opacity: 1;
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ’ãƒ³ãƒˆ */
    .scroll-hint {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(102, 126, 234, 0.9);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 10;
      pointer-events: none;
      animation: fadeInOut 3s ease-in-out;
    }

    @keyframes fadeInOut {
      0%, 100% { opacity: 0; }
      10%, 90% { opacity: 1; }
    }

    .attendance-grid {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
      table-layout: fixed;
    }

    @media (max-width: 768px) {
      .attendance-grid {
        min-width: 600px;
      }
    }

    @media (max-width: 480px) {
      .attendance-grid {
        min-width: 500px;
      }
    }

    .attendance-grid th,
    .attendance-grid td {
      padding: 8px 12px;
      text-align: center;
      border: none;
      border-bottom: 1px solid #f0f0f0;
      line-height: 1.4;
      vertical-align: middle;
    }

    .attendance-grid tbody tr:nth-child(even) {
      background-color: #FAFAFA;
    }

    .attendance-grid tbody tr:nth-child(odd) {
      background-color: white;
    }

    .attendance-grid th {
      background: #F5F5F5;
      color: #333;
      font-weight: bold;
      font-size: 0.85rem;
      position: sticky;
      top: 0;
      z-index: 10;
      border: none;
      border-bottom: 1px solid #DDDDDD;
      vertical-align: middle;
    }

    .attendance-grid th:first-child {
      position: sticky;
      left: 0;
      top: 0;
      z-index: 30;
      background: #F5F5F5;
      color: #333;
      font-weight: bold;
      min-width: 200px;
      width: 200px;
      max-width: 200px;
      border-right: 1px solid #DDDDDD;
      vertical-align: middle;
    }

    /* 2è¡Œç›®ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆãƒ¡ãƒ³ãƒãƒ¼åï¼‰ã®z-indexã‚’æ˜ç¤ºçš„ã«ä½ãè¨­å®š */
    .attendance-grid thead tr:nth-child(2) th {
      z-index: 9;
    }

    .attendance-grid tbody tr:nth-child(even) td:first-child {
      background-color: #F5F5F5;
    }

    .attendance-grid tbody tr:nth-child(odd) td:first-child {
      background-color: #F5F5F5;
    }

    .attendance-grid td:first-child {
      position: sticky;
      left: 0;
      z-index: 1;
      font-weight: 600;
      min-width: 200px;
      width: 200px;
      max-width: 200px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      border-right: 1px solid #DDDDDD;
      vertical-align: middle;
      background-color: #F5F5F5;
    }

    .status-cell {
      cursor: pointer;
      min-width: 50px;
      height: 32px;
      padding: 4px 6px;
      transition: background-color 0.2s;
    }

    .status-cell:hover {
      background-color: #f0f0f0;
    }

    .status-cell.status-attend {
      background-color: #E8F5E9;
    }

    .status-cell.status-maybe {
      background-color: #FFFDE7;
    }

    .status-cell.status-absent {
      background-color: #FFEBEE;
    }

    .status-cell.status-none {
      background-color: #f5f5f5;
      color: #999;
    }

    .status-cell.status-unregistered {
      background-color: white;
      color: #333;
    }

    .status-icon {
      font-size: 1.1rem;
      font-weight: 500;
    }

    .grid-controls {
      position: relative;
      margin-bottom: 30px;
    }

    /* ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ï¼ˆã‚«ãƒ¼ãƒ‰å½¢å¼ï¼‰ */
    .events-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .event-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 25px;
      border: 1px solid #e0e0e0;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .event-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .event-card h3 {
      color: #00796B;
      margin-bottom: 10px;
      font-size: 1.3rem;
    }

    .event-meta {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 15px;
    }

    .event-meta .date {
      font-weight: bold;
      color: #333;
    }

    .event-meta .location {
      margin-top: 5px;
    }

    /* å‡ºæ¬ ãƒ•ã‚©ãƒ¼ãƒ  */
    .response-form {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .response-form label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: #333;
    }

    .response-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .response-btn {
      flex: 1;
      min-width: 70px;
      padding: 6px 12px;
      border: 2px solid #00796B;
      background: white;
      color: #00796B;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.2s;
    }

    .response-btn:hover {
      background: #00796B;
      color: white;
    }

    .response-btn.active {
      background: #00796B;
      color: white;
    }

    .response-btn.attend {
      border-color: #4caf50;
      color: #4caf50;
    }

    .response-btn.attend.active {
      background: #4caf50;
      color: white;
    }

    .response-btn.maybe {
      border-color: #ff9800;
      color: #ff9800;
    }

    .response-btn.maybe.active {
      background: #ff9800;
      color: white;
    }

    .response-btn.absent {
      border-color: #f44336;
      color: #f44336;
    }

    .response-btn.absent.active {
      background: #f44336;
      color: white;
    }

    .comment-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      margin-bottom: 15px;
      font-family: inherit;
    }

    .submit-btn {
      width: 100%;
      background: #00796B;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }

    .submit-btn:hover {
      background: #00695C;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 121, 107, 0.4);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* é›†è¨ˆè¡¨ç¤º */
    .tally {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .tally h4 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .tally-stats {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .tally-stat {
      flex: 1;
      min-width: 80px;
      text-align: center;
      padding: 10px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }

    .tally-stat .label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }

    .tally-stat .value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }

    .tally-stat.attend .value {
      color: #4caf50;
    }

    .tally-stat.maybe .value {
      color: #ff9800;
    }

    .tally-stat.absent .value {
      color: #f44336;
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      z-index: 10000; /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆz-index: 2000ï¼‰ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
      animation: slideIn 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      background: #2196F3; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯è‰²ï¼ˆinfoç”¨ï¼‰ */
    }

    .toast.success {
      background: #4caf50;
    }

    .toast.error {
      background: #f44336;
    }

    .toast.info {
      background: #2196F3;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* ç©ºã®çŠ¶æ…‹ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state h3 {
      color: #667eea;
      margin-bottom: 10px;
    }

    /* ç®¡ç†ãƒœã‚¿ãƒ³ */
    .admin-actions {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
    }

    .admin-btn {
      flex: 1;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .admin-btn.edit {
      background: #2196F3;
      color: white;
    }

    .admin-btn.edit:hover {
      background: #1976D2;
    }

    .admin-btn.delete {
      background: #f44336;
      color: white;
    }

    .admin-btn.delete:hover {
      background: #d32f2f;
    }

    .admin-btn.sync {
      background: #4caf50;
      color: white;
    }

    .admin-btn.sync:hover {
      background: #45a049;
    }

    .admin-btn.sync:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ã§ãªã„å ´åˆã®sync-all-btnã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ãªã©ã§ä½¿ç”¨ï¼‰ */
    .sync-all-btn:not(.icon-action-btn) {
      background: #4caf50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sync-all-btn:not(.icon-action-btn):hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
    }

    .sync-all-btn:not(.icon-action-btn):disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
    }

    /* ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ã®å ´åˆã®disabledçŠ¶æ…‹ */
    .icon-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .icon-action-btn:disabled i {
      opacity: 0.5;
    }


    .sync-icon {
      display: inline-block;
      animation: none;
    }

    .sync-icon.spinning {
      animation: spin 1s linear infinite;
    }

    /* ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³å†…ã®ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .icon-action-btn i.spinning {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .sync-status {
      font-size: 0.85rem;
      color: #666;
      margin-top: 8px;
      padding: 4px 8px;
      background: #f5f5f5;
      border-radius: 4px;
    }

    /* å…¨ç”»é¢ãƒ­ãƒ¼ãƒ€ãƒ¼ */
    .fullscreen-loader {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .fullscreen-loader.active {
      display: flex;
    }

    .fullscreen-loader .loader-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .fullscreen-loader .loader-text {
      color: white;
      font-size: 1.2rem;
      font-weight: 500;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      overflow: auto;
    }

    .modal-content {
      background-color: #ffffff;
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .modal-header h2 {
      color: #667eea;
      margin: 0;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 2rem;
      color: #999;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    .close-btn:hover {
      color: #333;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }

    .form-group .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 0;
      font-weight: normal;
      cursor: pointer;
    }

    .form-group .checkbox-label input[type="checkbox"] {
      width: auto;
      margin: 0;
      padding: 0;
      border: none;
      border-radius: 0;
      cursor: pointer;
      flex-shrink: 0;
    }

    .form-group .checkbox-label span {
      user-select: none;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* å ´æ‰€å±¥æ­´ */
    .location-history-btn {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .location-history-btn:hover {
      background: #f5f5f5;
      border-color: #667eea;
    }

    .location-history {
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      max-height: 200px;
      overflow-y: auto;
    }

    .location-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #e0e0e0;
      background: #f9f9f9;
      font-weight: bold;
      font-size: 0.9rem;
      color: #666;
    }

    .location-history-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .location-history-close:hover {
      color: #333;
    }

    .location-history-list {
      padding: 5px;
    }

    .location-history-item {
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
      font-size: 0.95rem;
    }

    .location-history-item:hover {
      background: #f0f0f0;
    }

    .location-history-item:active {
      background: #e0e0e0;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 30px;
    }

    .form-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .form-btn.primary {
      background: #00796B;
      color: white;
    }

    .form-btn.primary:hover {
      background: #00695C;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 121, 107, 0.4);
    }

    .form-btn.secondary {
      background: #e0e0e0;
      color: #333;
    }

    .form-btn.secondary:hover {
      background: #d0d0d0;
    }

    .form-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
    .confirm-dialog {
      display: none;
      position: fixed;
      z-index: 2100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: auto;
    }

    .confirm-dialog-content {
      background-color: white;
      margin: 15% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideDown 0.3s ease-out;
      text-align: center;
    }

    .confirm-dialog-content h3 {
      color: #f44336;
      margin-bottom: 15px;
    }

    .confirm-dialog-content p {
      margin-bottom: 25px;
      color: #666;
    }

    .confirm-dialog-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .confirm-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .confirm-btn.danger {
      background: #f44336;
      color: white;
    }

    .confirm-btn.danger:hover {
      background: #d32f2f;
    }

    .confirm-btn.cancel {
      background: #e0e0e0;
      color: #333;
    }

    .confirm-btn.cancel:hover {
      background: #d0d0d0;
    }

    footer {
      background: #f8f9fa;
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 0.9rem;
      border-top: 1px solid #e0e0e0;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        border-radius: 8px;
        max-width: 100%;
        width: 100%;
      }

      header {
        padding: 15px;
      }

      .header-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 8px;
      }

      header h1 {
        font-size: 1.5rem;
      }

      .header-actions {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }

      header p {
        font-size: 0.9rem;
      }

      .header-actions {
        flex-direction: column;
        gap: 8px;
      }

      .admin-login-btn {
        width: 100%;
        font-size: 0.9rem;
        padding: 12px 16px;
      }

      .icon-action-btn {
        width: 40px;
        height: 40px;
        padding: 8px;
      }

      .icon-action-btn i {
        font-size: 1rem;
      }

      .create-event-btn {
        width: 100%;
        font-size: 0.9rem;
        padding: 12px 16px;
      }

      main {
        padding: 15px;
      }

      .view-toggle {
        flex-direction: column;
        gap: 8px;
      }

      .view-btn {
        width: 100%;
        text-align: center;
      }

      .events-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .event-card {
        padding: 15px;
      }

      .event-card h3 {
        font-size: 1.1rem;
      }

      .event-meta {
        font-size: 0.85rem;
      }

      .response-buttons {
        flex-direction: column;
        gap: 8px;
      }

      .response-btn {
        width: 100%;
        padding: 12px;
        font-size: 1rem;
      }

      .tally-stats {
        flex-direction: column;
        gap: 10px;
      }

      .tally-stat {
        width: 100%;
      }

      .modal-content {
        margin: 5% auto;
        padding: 20px;
        width: 95% !important;
        max-width: 95% !important;
      }

      .modal-header h2 {
        font-size: 1.2rem;
      }

      .admin-actions {
        flex-direction: column;
        gap: 8px;
      }

      .admin-btn {
        width: 100%;
      }

      .attendance-grid-container {
        font-size: 0.75rem;
      }

      .attendance-grid th,
      .attendance-grid td {
        padding: 4px 6px;
        font-size: 0.75rem;
      }

      .attendance-grid th:first-child {
        min-width: 150px;
        width: 150px;
        max-width: 150px;
      }

      .attendance-grid td:first-child {
        min-width: 150px;
        width: 150px;
        max-width: 150px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 5px;
      }

      .container {
        max-width: 100%;
        width: 100%;
        border-radius: 0;
      }

      header {
        padding: 12px 10px;
      }

      .header-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 6px;
      }

      header h1 {
        font-size: 1.3rem;
      }

      .header-actions {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 6px;
      }

      .admin-login-btn {
        font-size: 0.8rem;
        padding: 6px 12px;
      }

      .icon-action-btn {
        width: 36px;
        height: 36px;
        padding: 6px;
      }

      .icon-action-btn i {
        font-size: 0.95rem;
      }

      .create-event-btn {
        font-size: 0.8rem;
        padding: 6px 12px;
      }

      main {
        padding: 10px;
      }

      .modal-content {
        margin: 2% auto;
        padding: 15px;
        width: 98% !important;
        max-width: 98% !important;
      }

      .attendance-grid th,
      .attendance-grid td {
        padding: 3px 4px;
        font-size: 0.7rem;
      }

      .attendance-grid th:first-child {
        min-width: 120px;
        width: 120px;
        max-width: 120px;
      }

      .attendance-grid td:first-child {
        min-width: 120px;
        width: 120px;
        max-width: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-top">
        <h1>UnionBoard</h1>
        <div class="header-actions">
          <button class="admin-login-btn" onclick="showAdminLoginModal()" id="admin-login-btn" style="display: inline-block;">
            ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
          </button>
          <div class="header-action-group" style="display: none;">
            <button class="sync-all-btn icon-action-btn" onclick="syncAllEvents()" id="sync-all-btn" title="åŒæœŸ">
              <i class="fas fa-rotate"></i>
            </button>
            <button class="admin-logout-btn icon-action-btn" onclick="logoutAdmin()" id="admin-logout-btn" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">
              <i class="fas fa-right-from-bracket"></i>
            </button>
          </div>
        </div>
      </div>
      <p>TMU ç·´ç¿’äºˆå®šãƒ»å‡ºæ¬ ç®¡ç†ã‚¢ãƒ—ãƒª</p>
    </header>

    <main>
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>

      <div id="error" class="error" style="display: none;"></div>

      <div id="events-container" style="display: none;">
        <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
        <div class="view-toggle">
          <button class="view-btn active" onclick="switchView('grid')" id="grid-view-btn">ğŸ“‹ è¡¨å½¢å¼</button>
          <button class="view-btn" onclick="switchView('card')" id="card-view-btn">ğŸ“„ ã‚«ãƒ¼ãƒ‰å½¢å¼</button>
        </div>
        
        <!-- è¡¨å½¢å¼è¡¨ç¤º -->
        <div id="grid-view" style="display: block;">
          <div class="grid-controls" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <button class="member-register-btn" onclick="showMemberRegisterModal()" style="padding: 10px 20px; background: #00796B; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">+ ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²</button>
            <button class="admin-feature primary-btn create-event-btn" onclick="openCreateEventModal()" id="create-event-btn" style="display: none; padding: 10px 20px; background: #00796B; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">æ–°è¦ä½œæˆ</button>
          </div>
          <!-- è¡¨ç¤ºæœŸé–“ã¨å‡¡ä¾‹ -->
          <div style="margin-bottom: 30px; display: flex; flex-direction: column; gap: 12px;">
            <!-- è¡¨ç¤ºæœŸé–“è¡¨ç¤ºï¼ˆç®¡ç†è€…ã®ã¿ç·¨é›†å¯èƒ½ï¼‰ -->
            <div id="display-period-info" style="padding: 12px 16px; background: #f5f5f5; border-radius: 8px; font-size: 0.9rem; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
              <span style="font-weight: 500; color: #333;">è¡¨ç¤ºæœŸé–“:</span>
              <span id="display-period-text" style="color: #666;">å…¨æœŸé–“</span>
              <button id="display-period-edit-btn" onclick="openDisplayPeriodModal()" style="display: none; padding: 6px 12px; background: #00796B; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">æœŸé–“ã‚’è¨­å®š</button>
            </div>
            <!-- å‡¡ä¾‹ -->
            <div id="attendance-legend" style="padding: 8px 12px; background: #f8f9fa; border-radius: 6px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; font-size: 0.9rem;">
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="display: inline-block; width: 24px; height: 24px; background-color: #c8e6c9; border-radius: 4px; text-align: center; line-height: 24px; font-weight: bold;">â—‹</span>
                <span>å‡ºå¸­</span>
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="display: inline-block; width: 24px; height: 24px; background-color: #fff9c4; border-radius: 4px; text-align: center; line-height: 24px; font-weight: bold;">â–³</span>
                <span>é…åˆ»/æ—©é€€</span>
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="display: inline-block; width: 24px; height: 24px; background-color: #ffcdd2; border-radius: 4px; text-align: center; line-height: 24px; font-weight: bold;">Ã—</span>
                <span>æ¬ å¸­</span>
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="display: inline-block; width: 24px; height: 24px; background-color: #f5f5f5; border-radius: 4px; text-align: center; line-height: 24px; color: #999;">-</span>
                <span>æœªå®š</span>
              </div>
            </div>
          </div>
          <div class="attendance-grid-wrapper">
            <div id="attendance-grid-scrollbar-top" class="attendance-grid-scrollbar-top"></div>
            <div id="attendance-grid" class="attendance-grid-container">
              <!-- è¡¨å½¢å¼ã®ã‚°ãƒªãƒƒãƒ‰ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </div>
          </div>
        </div>
        
        <!-- ã‚«ãƒ¼ãƒ‰å½¢å¼è¡¨ç¤ºï¼ˆæ—¢å­˜ï¼‰ -->
        <div id="card-view" style="display: none;">
          <div id="events-grid" class="events-grid"></div>
          <div id="empty-state" class="empty-state" style="display: none;">
            <h3>ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</h3>
            <p>ä»Šå¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒç™»éŒ²ã•ã‚Œã‚‹ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>&copy; 2025 UnionBoard - Tokyo Music Union</p>
    </footer>
  </div>

  <!-- ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="event-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ</h2>
        <button class="close-btn" onclick="closeEventModal()">&times;</button>
      </div>
      <form id="event-form" onsubmit="saveEvent(event)">
        <div class="form-group">
          <label for="event-title">ã‚¿ã‚¤ãƒˆãƒ« <span style="color: red;">*</span></label>
          <input type="text" id="event-title" required maxlength="100">
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="event-all-day" onchange="toggleAllDay()">
            <span>çµ‚æ—¥</span>
          </label>
        </div>
        <div class="form-group">
          <label for="event-start">é–‹å§‹æ—¥æ™‚ <span style="color: red;">*</span></label>
          <input type="datetime-local" id="event-start" required>
          <input type="date" id="event-start-date" style="display: none;">
        </div>
        <div class="form-group">
          <label for="event-end">çµ‚äº†æ—¥æ™‚ <span style="color: red;">*</span></label>
          <input type="datetime-local" id="event-end" required>
          <input type="date" id="event-end-date" style="display: none;">
        </div>
        <div class="form-group">
          <label for="event-location">å ´æ‰€</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="text" id="event-location" style="flex: 1;">
            <button type="button" class="location-history-btn" onclick="toggleLocationHistory()" title="å ´æ‰€ã®å±¥æ­´ã‚’è¡¨ç¤º">
              ğŸ“‹
            </button>
          </div>
          <div id="location-history" class="location-history" style="display: none;">
            <div class="location-history-header">
              <span>æœ€è¿‘ä½¿ç”¨ã—ãŸå ´æ‰€</span>
              <button type="button" class="location-history-close" onclick="toggleLocationHistory()">Ã—</button>
            </div>
            <div id="location-history-list" class="location-history-list"></div>
          </div>
        </div>
        <div class="form-group">
          <label for="event-description">èª¬æ˜</label>
          <textarea id="event-description"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="form-btn secondary" onclick="closeEventModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="form-btn primary" id="save-event-btn">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <div id="delete-confirm" class="confirm-dialog">
    <div class="confirm-dialog-content">
      <h3>ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
      <p id="delete-confirm-message">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
      <div class="confirm-dialog-actions">
        <button class="confirm-btn cancel" onclick="closeDeleteConfirm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="confirm-btn danger" onclick="confirmDelete()">å‰Šé™¤</button>
      </div>
    </div>
  </div>

  <!-- ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="event-detail-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 id="event-detail-title">ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°</h2>
        <div style="display: flex; gap: 16px; align-items: center;">
          <div id="event-detail-admin-actions" style="display: none; gap: 12px;">
            <button class="admin-btn edit" id="event-detail-edit-btn" style="padding: 6px 12px; font-size: 0.9rem;">ç·¨é›†</button>
            <button class="admin-btn delete" id="event-detail-delete-btn" style="padding: 6px 12px; font-size: 0.9rem;">å‰Šé™¤</button>
          </div>
          <button class="close-btn" onclick="closeEventDetailModal()">&times;</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="event-detail-info" style="margin-bottom: 20px;">
          <!-- ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
        <div id="event-detail-comments" style="margin-bottom: 20px;">
          <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
        <div id="event-detail-breakdown" style="margin-bottom: 20px;">
          <!-- ãƒ‘ãƒ¼ãƒˆã”ã¨ã®å†…è¨³ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="member-register-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²</h2>
        <button class="close-btn" onclick="closeMemberRegisterModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" style="margin-top: 20px;">
          <label for="member-part">ãƒ‘ãƒ¼ãƒˆ</label>
          <select id="member-part" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="Fl">Fl (ãƒ•ãƒ«ãƒ¼ãƒˆ)</option>
            <option value="Ob">Ob (ã‚ªãƒ¼ãƒœã‚¨)</option>
            <option value="Cl">Cl (ã‚¯ãƒ©ãƒªãƒãƒƒãƒˆ)</option>
            <option value="Sax">Sax (ã‚µãƒƒã‚¯ã‚¹)</option>
            <option value="Hr">Hr (ãƒ›ãƒ«ãƒ³)</option>
            <option value="Tp">Tp (ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆ)</option>
            <option value="Tb">Tb (ãƒˆãƒ­ãƒ³ãƒœãƒ¼ãƒ³)</option>
            <option value="Bass">Bass (ãƒã‚¹)</option>
            <option value="Perc">Perc (æ‰“æ¥½å™¨)</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <label for="member-name">åå‰</label>
          <input type="text" id="member-name" placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ" maxlength="50" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
        </div>
        <div class="form-actions" style="margin-top: 20px;">
          <button type="button" class="form-btn cancel" onclick="closeMemberRegisterModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="form-btn primary" onclick="registerMember()">ç™»éŒ²</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="member-edit-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2>ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†</h2>
        <button class="close-btn" onclick="closeMemberEditModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="margin-top: 10px; padding: 12px; background: #f8f9fa; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 4px;">ãƒ‘ãƒ¼ãƒˆ</div>
            <div id="member-part-display" style="font-weight: bold; font-size: 1rem;">-</div>
          </div>
          <div style="margin-left: 20px; flex: 1;">
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 4px;">åå‰</div>
            <div id="member-name-display" style="font-weight: bold; font-size: 1rem;">-</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button type="button" onclick="openMemberInfoEditModal()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; white-space: nowrap;">ç·¨é›†</button>
            <button type="button" onclick="deleteMemberFromModal()" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; white-space: nowrap;">å‰Šé™¤</button>
          </div>
        </div>
        <div style="margin-top: 20px;">
          <label style="font-weight: bold; display: block; margin-bottom: 10px;">å„æ—¥ç¨‹ã®å‡ºæ¬ ã‚’é¸æŠ:</label>
          <div id="event-status-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; background-color: #ffffff;">
            <!-- å„æ—¥ç¨‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠUIãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
          </div>
        </div>
        <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px;">
          <button type="button" class="form-btn cancel" onclick="closeMemberEditModal()" style="flex: 1;">é–‰ã˜ã‚‹</button>
          <button type="button" class="form-btn primary" onclick="bulkUpdateResponsesForSelectedMember()" style="flex: 2;">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ‘ãƒ¼ãƒˆãƒ»åå‰ç·¨é›†ç”¨ï¼‰ -->
  <div id="member-info-edit-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’ç·¨é›†</h2>
        <button class="close-btn" onclick="closeMemberInfoEditModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group" style="margin-top: 20px;">
          <label for="member-info-part">ãƒ‘ãƒ¼ãƒˆ</label>
          <select id="member-info-part" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="Fl">Fl (ãƒ•ãƒ«ãƒ¼ãƒˆ)</option>
            <option value="Ob">Ob (ã‚ªãƒ¼ãƒœã‚¨)</option>
            <option value="Cl">Cl (ã‚¯ãƒ©ãƒªãƒãƒƒãƒˆ)</option>
            <option value="Sax">Sax (ã‚µãƒƒã‚¯ã‚¹)</option>
            <option value="Hr">Hr (ãƒ›ãƒ«ãƒ³)</option>
            <option value="Tp">Tp (ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆ)</option>
            <option value="Tb">Tb (ãƒˆãƒ­ãƒ³ãƒœãƒ¼ãƒ³)</option>
            <option value="Bass">Bass (ãƒã‚¹)</option>
            <option value="Perc">Perc (æ‰“æ¥½å™¨)</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <label for="member-info-name">åå‰</label>
          <input type="text" id="member-info-name" placeholder="ä¾‹: æ˜¥å" maxlength="50" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
        </div>
        <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px;">
          <button type="button" class="form-btn cancel" onclick="closeMemberInfoEditModal()" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="form-btn primary" onclick="saveMemberInfo()" style="flex: 2;">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="admin-login-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <button class="close-btn" onclick="closeAdminLoginModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <div class="form-group" style="margin-top: 20px;">
          <label for="admin-token-input">ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³</label>
          <input type="password" id="admin-token-input" placeholder="ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›" maxlength="100" autocomplete="off" onkeypress="if(event.key === 'Enter') submitAdminLogin()">
        </div>
        <div class="form-actions" style="margin-top: 20px;">
          <button type="button" class="form-btn cancel" onclick="closeAdminLoginModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="form-btn primary" onclick="submitAdminLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è¡¨ç¤ºæœŸé–“è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="display-period-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>è¡¨ç¤ºæœŸé–“ã‚’è¨­å®š</h2>
        <button class="close-btn" onclick="closeDisplayPeriodModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>è¡¨ç¤ºã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®æœŸé–“ã‚’è¨­å®šã—ã¾ã™ã€‚ç©ºæ¬„ã«ã™ã‚‹ã¨åˆ¶é™ãªã—ï¼ˆå…¨æœŸé–“ï¼‰ã«ãªã‚Šã¾ã™ã€‚</p>
        <div class="form-group" style="margin-top: 20px;">
          <label for="display-period-start">é–‹å§‹æ—¥</label>
          <input type="date" id="display-period-start" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <small style="color: #666; font-size: 0.85rem;">ç©ºæ¬„ã®å ´åˆã¯åˆ¶é™ãªã—</small>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <label for="display-period-end">çµ‚äº†æ—¥</label>
          <input type="date" id="display-period-end" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <small style="color: #666; font-size: 0.85rem;">ç©ºæ¬„ã®å ´åˆã¯åˆ¶é™ãªã—</small>
        </div>
        <div class="form-actions" style="margin-top: 20px;">
          <button type="button" class="form-btn cancel" onclick="closeDisplayPeriodModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="form-btn danger" onclick="clearDisplayPeriod()" style="background: #f44336;">åˆ¶é™ã‚’è§£é™¤</button>
          <button type="button" class="form-btn primary" onclick="saveDisplayPeriod()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
     * Phase 1.6/1.7: ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºãƒ»å‡ºæ¬ ç™»éŒ²æ©Ÿèƒ½
     */

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentEvents = [];
    let currentUserKey = ''; // ç®¡ç†è€…åˆ¤å®šç”¨ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç®¡ç†ã™ã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¯ä¿å­˜ã—ãªã„ï¼‰
    let currentAuthMode = 'anonymous';
    let isAdminUser = false; // ç®¡ç†è€…ã‹ã©ã†ã‹

    /**
     * å…¨å‡ºæ¬ ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
     * æ§‹é€ : { [eventId: string]: Response[] }
     */
    window.allResponsesCache = {};

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', () => {
      loadInitData();
    });

    /**
     * åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§èªè¨¼ãƒ¢ãƒ¼ãƒ‰ã‚’ç¢ºèª
     */
    function loadInitData() {
      return new Promise((resolve, reject) => {
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆ?admin=TOKEN å½¢å¼ï¼‰
        console.log('ğŸ” URLç¢ºèª:', {
          href: window.location.href,
          search: window.location.search,
          pathname: window.location.pathname,
          hash: window.location.hash
        });
        
        const urlParams = new URLSearchParams(window.location.search);
        const adminTokenFromUrl = urlParams.get('admin');
        
        console.log('ğŸ” URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ:', {
          searchString: window.location.search,
          adminParam: adminTokenFromUrl,
          allParams: Object.fromEntries(urlParams.entries())
        });
        
        if (adminTokenFromUrl) {
          // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒˆãƒ¼ã‚¯ãƒ³ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€è‡ªå‹•çš„ã«è¨­å®š
          console.log('ğŸ” URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œå‡º:', adminTokenFromUrl.substring(0, 10) + '...');
          localStorage.setItem('adminToken', adminTokenFromUrl);
          console.log('ğŸ’¾ localStorageã«ä¿å­˜:', localStorage.getItem('adminToken') ? 'æˆåŠŸ' : 'å¤±æ•—');
          // URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆå±¥æ­´ã«æ®‹ã•ãªã„ãŸã‚ï¼‰
          const newUrl = window.location.pathname + window.location.hash;
          window.history.replaceState({}, document.title, newUrl);
        } else {
          console.log('âš ï¸ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«adminãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        
        google.script.run
          .withSuccessHandler((data) => {
            currentAuthMode = data.config.AUTH_MODE || 'anonymous';
            initializeUser();
            
            // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ã¦memberListã«åæ˜ 
            if (data.members && Array.isArray(data.members)) {
              // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’memberListã«åæ˜ ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç®¡ç†ï¼‰
              memberList = data.members.map(m => ({
                part: m.part || '',
                name: m.name || '',
                displayName: m.displayName || (m.part + m.name),
                userKey: m.userKey
              }));
            } else {
              memberList = [];
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥ä½¿ç”¨ï¼ˆgetInitDataã§æ—¢ã«å–å¾—æ¸ˆã¿ï¼‰
            if (data.events) {
              currentEvents = data.events;
            }
            
            // å‡ºæ¬ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            if (data.responsesMap) {
              window.allResponsesCache = data.responsesMap;
              console.log('âœ… å‡ºæ¬ ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜:', {
                ã‚¤ãƒ™ãƒ³ãƒˆæ•°: Object.keys(data.responsesMap).length,
                åˆè¨ˆå‡ºæ¬ æ•°: Object.values(data.responsesMap).reduce((sum, responses) => sum + responses.length, 0)
              });
            } else {
              window.allResponsesCache = {};
            }
            
            // è¡¨ç¤ºæœŸé–“ã‚’æ›´æ–°
            updateDisplayPeriodInfo(data.config);
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºï¼ˆåˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼‰
            hideLoading();
            
            // ç®¡ç†è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰UIã‚’æ›´æ–°
            checkAdminStatus().then(() => {
              // ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤ºï¼ˆæ—¢ã«ãƒ‡ãƒ¼ã‚¿ã¯å–å¾—æ¸ˆã¿ï¼‰
              renderEvents();
              // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆã€æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
              if (adminTokenFromUrl) {
                showToast('ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸ', 'success');
              }
            });
            resolve(data);
          })
          .withFailureHandler((error) => {
            console.error('âŒ åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', error);
            console.error('âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
              message: error.message || error,
              stack: error.stack,
              toString: error.toString()
            });
            initializeUser();
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
            hideLoading();
            // ç®¡ç†è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            checkAdminStatus().then(() => {
              showError('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            });
            reject(error);
          })
          .getInitData();
      });
    }

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®åˆæœŸåŒ–ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç®¡ç†ã™ã‚‹ãŸã‚ä¸è¦ï¼‰
     */
    function initializeUser() {
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç®¡ç†ã™ã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¯ä¿å­˜ã—ãªã„
      currentUserKey = '';
    }

    /**
     * ç®¡ç†è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
     * @returns Promise<void>
     */
    function checkAdminStatus() {
      return new Promise((resolve) => {
        const adminToken = localStorage.getItem('adminToken');
        console.log('ğŸ” ç®¡ç†è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª:', {
          hasToken: !!adminToken,
          tokenPreview: adminToken ? adminToken.substring(0, 10) + '...' : 'ãªã—',
          currentUserKey: currentUserKey || 'æœªè¨­å®š'
        });
        
        if (adminToken) {
          // ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚µãƒ¼ãƒãƒ¼å´ã§æ¤œè¨¼
          google.script.run
            .withSuccessHandler((result) => {
              console.log('âœ… ç®¡ç†è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªçµæœ:', result);
              isAdminUser = result === true;
              updateAdminUI();
              resolve();
            })
            .withFailureHandler((error) => {
              console.error('âŒ ç®¡ç†è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
              isAdminUser = false;
              updateAdminUI();
              resolve();
            })
            .checkAdminStatus(currentUserKey || '', adminToken);
        } else {
          console.log('â„¹ï¸ ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
          isAdminUser = false;
          updateAdminUI();
          resolve();
        }
      });
    }

    /**
     * ç®¡ç†è€…UIã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
     */
    function updateAdminUI() {
      // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç®¡ç†ãƒœã‚¿ãƒ³
      const adminLoginBtn = document.getElementById('admin-login-btn');
      const adminLogoutBtn = document.getElementById('admin-logout-btn');
      const syncAllBtn = document.getElementById('sync-all-btn');
      const createEventBtn = document.getElementById('create-event-btn');
      const displayPeriodEditBtn = document.getElementById('display-period-edit-btn');
      
      const headerActionGroup = document.querySelector('.header-action-group');
      
      if (isAdminUser) {
        // ç®¡ç†è€…ã®å ´åˆï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã¨ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        if (adminLoginBtn) adminLoginBtn.style.display = 'none';
        if (headerActionGroup) headerActionGroup.style.display = 'flex';
        if (createEventBtn) createEventBtn.style.display = 'inline-block';
        if (displayPeriodEditBtn) displayPeriodEditBtn.style.display = 'inline-block';
      } else {
        // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã¨ç®¡ç†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        if (adminLoginBtn) adminLoginBtn.style.display = 'inline-block';
        if (headerActionGroup) headerActionGroup.style.display = 'none';
        if (createEventBtn) createEventBtn.style.display = 'none';
        if (displayPeriodEditBtn) displayPeriodEditBtn.style.display = 'none';
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã®ç®¡ç†ãƒœã‚¿ãƒ³ï¼ˆæ—¢ã«æç”»ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
      currentEvents.forEach(event => {
        const syncBtn = document.getElementById(`sync-btn-${event.id}`);
        const editBtn = document.querySelector(`#event-${event.id} .admin-btn.edit`);
        const deleteBtn = document.querySelector(`#event-${event.id} .admin-btn.delete`);
        const adminActions = document.querySelector(`#event-${event.id} .admin-actions`);
        
        if (isAdminUser) {
          if (syncBtn) syncBtn.style.display = 'inline-block';
          if (editBtn) editBtn.style.display = 'inline-block';
          if (deleteBtn) deleteBtn.style.display = 'inline-block';
          if (adminActions) adminActions.style.display = 'flex';
        } else {
          if (syncBtn) syncBtn.style.display = 'none';
          if (editBtn) editBtn.style.display = 'none';
          if (deleteBtn) deleteBtn.style.display = 'none';
          if (adminActions) adminActions.style.display = 'none';
        }
      });
    }


    /**
     * ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
     */
    function showAdminLoginModal() {
      const modal = document.getElementById('admin-login-modal');
      modal.style.display = 'block';
      // å…¥åŠ›æ¬„ã‚’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => {
        const input = document.getElementById('admin-token-input');
        if (input) input.focus();
      }, 100);
    }

    /**
     * ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeAdminLoginModal() {
      const modal = document.getElementById('admin-login-modal');
      modal.style.display = 'none';
      // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
      const input = document.getElementById('admin-token-input');
      if (input) input.value = '';
    }

    /**
     * ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Ÿè¡Œ
     */
    function submitAdminLogin() {
      const tokenInput = document.getElementById('admin-token-input');
      const token = tokenInput.value.trim();
      
      if (!token) {
        showToast('ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const loginBtn = tokenInput.closest('.modal-body').querySelector('.form-btn.primary');
      if (loginBtn) {
        loginBtn.disabled = true;
        loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
      }

      // ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
      google.script.run
        .withSuccessHandler((result) => {
          if (loginBtn) {
            loginBtn.disabled = false;
            loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
          }
          
          if (result === true) {
            // ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ã„å ´åˆã€localStorageã«ä¿å­˜
            localStorage.setItem('adminToken', token);
            isAdminUser = true;
            updateAdminUI();
            closeAdminLoginModal();
            showToast('ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸ', 'success');
            // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            loadInitData().then(() => {
              renderEvents();
            });
          } else {
            showToast('ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
            tokenInput.value = '';
            tokenInput.focus();
          }
        })
        .withFailureHandler((error) => {
          if (loginBtn) {
            loginBtn.disabled = false;
            loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
          }
          showToast('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || 'ã‚¨ãƒ©ãƒ¼'), 'error');
          tokenInput.value = '';
          tokenInput.focus();
        })
        .checkAdminStatus(currentUserKey, token);
    }

    /**
     * ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
     */
    function logoutAdmin() {
      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      if (!confirm('ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      // localStorageã‹ã‚‰ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
      localStorage.removeItem('adminToken');
      isAdminUser = false;
      updateAdminUI();
      showToast('ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success');
      // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç®¡ç†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      loadInitData().then(() => {
        renderEvents();
      });
    }

    /**
     * è¡¨ç¤ºæœŸé–“æƒ…å ±ã‚’æ›´æ–°
     */
    function updateDisplayPeriodInfo(config) {
      const periodText = document.getElementById('display-period-text');
      if (!periodText) return;

      const startDate = config.DISPLAY_START_DATE || '';
      const endDate = config.DISPLAY_END_DATE || '';

      if (!startDate && !endDate) {
        periodText.textContent = 'å…¨æœŸé–“';
      } else {
        let startStr = 'åˆ¶é™ãªã—';
        let endStr = 'åˆ¶é™ãªã—';
        
        if (startDate) {
          const start = new Date(startDate);
          startStr = `${start.getFullYear()}å¹´${start.getMonth() + 1}æœˆ${start.getDate()}æ—¥`;
        }
        
        if (endDate) {
          const end = new Date(endDate);
          endStr = `${end.getFullYear()}å¹´${end.getMonth() + 1}æœˆ${end.getDate()}æ—¥`;
        }
        
        periodText.textContent = `${startStr} ï½ ${endStr}`;
      }
    }

    /**
     * è¡¨ç¤ºæœŸé–“è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     */
    function openDisplayPeriodModal() {
      const modal = document.getElementById('display-period-modal');
      if (!modal) return;

      // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
      google.script.run
        .withSuccessHandler((data) => {
          const startInput = document.getElementById('display-period-start');
          const endInput = document.getElementById('display-period-end');
          
          if (startInput && data.config.DISPLAY_START_DATE) {
            const startDate = new Date(data.config.DISPLAY_START_DATE);
            startInput.value = formatDateForInput(startDate);
          } else if (startInput) {
            startInput.value = '';
          }
          
          if (endInput && data.config.DISPLAY_END_DATE) {
            const endDate = new Date(data.config.DISPLAY_END_DATE);
            endInput.value = formatDateForInput(endDate);
          } else if (endInput) {
            endInput.value = '';
          }
          
          modal.style.display = 'block';
        })
        .withFailureHandler((error) => {
          console.error('è¡¨ç¤ºæœŸé–“è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          showToast('è¡¨ç¤ºæœŸé–“è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .getInitData();
    }

    /**
     * è¡¨ç¤ºæœŸé–“è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeDisplayPeriodModal() {
      const modal = document.getElementById('display-period-modal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    /**
     * æ—¥ä»˜ã‚’input[type="date"]ç”¨ã®å½¢å¼ã«å¤‰æ›ï¼ˆYYYY-MM-DDï¼‰
     */
    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    /**
     * UTCæ—¥æ™‚æ–‡å­—åˆ—ã‚’JSTï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
     * @param {string} utcString - ISO 8601å½¢å¼ã®UTCæ—¥æ™‚æ–‡å­—åˆ—ï¼ˆä¾‹: "2025-11-10T00:00:00.000Z"ï¼‰
     * @returns {Date} JSTã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§è§£é‡ˆã•ã‚Œã‚‹ï¼‰
     */
    function utcToJST(utcString) {
      // new Date(utcString)ã¯æ—¢ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ï¼ˆJSTï¼‰ã§è§£é‡ˆã•ã‚Œã‚‹ãŸã‚ã€ãã®ã¾ã¾è¿”ã™
      return new Date(utcString);
    }
    
    /**
     * UTCæ—¥æ™‚æ–‡å­—åˆ—ã‹ã‚‰æ—¥ä»˜éƒ¨åˆ†ï¼ˆYYYY-MM-DDï¼‰ã‚’æŠ½å‡ºï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›ãªã—ï¼‰
     * @param {string} utcString - ISO 8601å½¢å¼ã®UTCæ—¥æ™‚æ–‡å­—åˆ—ï¼ˆä¾‹: "2025-11-19T04:00:00.000Z"ï¼‰
     * @returns {string} æ—¥ä»˜æ–‡å­—åˆ—ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
     */
    function getDateFromUTC(utcString) {
      // UTCæ–‡å­—åˆ—ã‹ã‚‰ç›´æ¥æ—¥ä»˜éƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆä¾‹: "2025-11-19T04:00:00.000Z" -> "2025-11-19"ï¼‰
      const match = utcString.match(/^(\d{4}-\d{2}-\d{2})/);
      return match ? match[1] : '';
    }

    /**
     * è¡¨ç¤ºæœŸé–“ã‚’ä¿å­˜
     */
    function saveDisplayPeriod() {
      const startInput = document.getElementById('display-period-start');
      const endInput = document.getElementById('display-period-end');
      
      if (!startInput || !endInput) {
        showToast('å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      let startDateISO = '';
      let endDateISO = '';

      if (startInput.value) {
        const startDate = new Date(startInput.value);
        startDate.setHours(0, 0, 0, 0);
        startDateISO = startDate.toISOString();
      }

      if (endInput.value) {
        const endDate = new Date(endInput.value);
        endDate.setHours(23, 59, 59, 999);
        endDateISO = endDate.toISOString();
      }

      // é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã®é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
      if (startDateISO && endDateISO) {
        const start = new Date(startDateISO);
        const end = new Date(endDateISO);
        if (start > end) {
          showToast('é–‹å§‹æ—¥ãŒçµ‚äº†æ—¥ã‚ˆã‚Šå¾Œã«ãªã£ã¦ã„ã¾ã™', 'error');
          return;
        }
      }

      const saveBtn = document.querySelector('#display-period-modal .form-btn.primary');
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'ä¿å­˜ä¸­...';
      }

      google.script.run
        .withSuccessHandler((result) => {
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
          }
          
          if (result.success) {
            closeDisplayPeriodModal();
            showToast('è¡¨ç¤ºæœŸé–“ã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
            // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            loadInitData().then(() => {
              renderEvents();
            });
          } else {
            showToast(result.error || 'è¡¨ç¤ºæœŸé–“ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        })
        .withFailureHandler((error) => {
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
          }
          console.error('è¡¨ç¤ºæœŸé–“è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
          showToast('è¡¨ç¤ºæœŸé–“ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .adminSetDisplayPeriod(startDateISO, endDateISO, currentUserKey, localStorage.getItem('adminToken'));
    }

    /**
     * è¡¨ç¤ºæœŸé–“ã®åˆ¶é™ã‚’è§£é™¤
     */
    function clearDisplayPeriod() {
      if (!confirm('è¡¨ç¤ºæœŸé–“ã®åˆ¶é™ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      const saveBtn = document.querySelector('#display-period-modal .form-btn.primary');
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'ä¿å­˜ä¸­...';
      }

      google.script.run
        .withSuccessHandler((result) => {
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
          }
          
          if (result.success) {
            closeDisplayPeriodModal();
            showToast('è¡¨ç¤ºæœŸé–“ã®åˆ¶é™ã‚’è§£é™¤ã—ã¾ã—ãŸ', 'success');
            // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            loadInitData().then(() => {
              renderEvents();
            });
          } else {
            showToast(result.error || 'è¡¨ç¤ºæœŸé–“ã®è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        })
        .withFailureHandler((error) => {
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
          }
          console.error('è¡¨ç¤ºæœŸé–“è§£é™¤ã‚¨ãƒ©ãƒ¼:', error);
          showToast('è¡¨ç¤ºæœŸé–“ã®è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .adminSetDisplayPeriod('', '', currentUserKey, localStorage.getItem('adminToken'));
    }

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
     * @deprecated loadInitData() ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
     * 
     * ã“ã®é–¢æ•°ã¯å»ƒæ­¢ã•ã‚Œã¾ã—ãŸã€‚
     * ç†ç”±: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸå‡ºæ¬ ãƒ‡ãƒ¼ã‚¿ã¨ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’ç ´æ£„ã—ã¦ã„ãŸãŸã‚ã€
     * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ›´æ–°ã•ã‚Œãšã€äºˆå®šè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å¤ã„ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚
     * 
     * ä»£ã‚ã‚Šã« loadInitData() ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
     * loadInitData() ã¯å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆ + å‡ºæ¬  + ãƒ¡ãƒ³ãƒãƒ¼ï¼‰ã‚’æ­£ã—ãæ›´æ–°ã—ã¾ã™ã€‚
     */

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°: è¡¨å½¢å¼UIç”¨
    let currentView = 'grid'; // 'grid' ã¾ãŸã¯ 'card'
    let gridData = {}; // {eventId: {memberName: status}}
    let memberList = []; // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã®ãƒªã‚¹ãƒˆ [{part: string, name: string, displayName: string, userKey: string}]
    let selectedMember = null; // é¸æŠã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ã®è¡¨ç¤ºå

    /**
     * è¡¨ç¤ºå½¢å¼ã‚’åˆ‡ã‚Šæ›¿ãˆ
     */
    function switchView(view) {
      currentView = view;
      const gridView = document.getElementById('grid-view');
      const cardView = document.getElementById('card-view');
      const gridBtn = document.getElementById('grid-view-btn');
      const cardBtn = document.getElementById('card-view-btn');

      if (view === 'grid') {
        gridView.style.display = 'block';
        cardView.style.display = 'none';
        gridBtn.classList.add('active');
        cardBtn.classList.remove('active');
        renderGrid();
      } else {
        gridView.style.display = 'none';
        cardView.style.display = 'block';
        cardBtn.classList.add('active');
        gridBtn.classList.remove('active');
        renderCardView();
      }
    }

    /**
     * ã‚«ãƒ¼ãƒ‰å½¢å¼ã‚’æç”»
     */
    function renderCardView() {
      const grid = document.getElementById('events-grid');
      const emptyState = document.getElementById('empty-state');

      grid.innerHTML = '';

      if (currentEvents.length === 0) {
        emptyState.style.display = 'block';
        grid.style.display = 'none';
      } else {
        emptyState.style.display = 'none';
        grid.style.display = 'grid';

        currentEvents.forEach(event => {
          const card = createEventCard(event);
          grid.appendChild(card);
        });
      }
    }

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’æç”»ï¼ˆè¡¨ç¤ºå½¢å¼ã«å¿œã˜ã¦ï¼‰
     */
    function renderEvents() {
      const container = document.getElementById('events-container');
      container.style.display = 'block';

      if (currentView === 'grid') {
        renderGrid();
      } else {
        renderCardView();
      }
      
      // ç®¡ç†è€…UIã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
      updateAdminUI();
    }

    /**
     * è¡¨å½¢å¼ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»
     */
    function renderGrid() {
      // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã¯æ—¢ã«loadInitDataã§å–å¾—æ¸ˆã¿
      if (memberList.length === 0) {
        loadMemberList();
      }
      
      const gridContainer = document.getElementById('attendance-grid');

      if (currentEvents.length === 0) {
        gridContainer.innerHTML = '<p style="padding: 20px; text-align: center;">ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆAPIå‘¼ã³å‡ºã—ãªã—ï¼ï¼‰
      const responsesMap = window.allResponsesCache || {};
      
      console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æç”»:', {
        ã‚¤ãƒ™ãƒ³ãƒˆæ•°: currentEvents.length,
        ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆæ•°: Object.keys(responsesMap).length
      });
      
      // allResponseså½¢å¼ã«å¤‰æ›
      const allResponses = {}; // {eventId: {displayName: status}}
      
      Object.keys(responsesMap).forEach(eventId => {
        allResponses[eventId] = {};
        responsesMap[eventId].forEach(response => {
          const member = memberList.find(m => m.userKey === response.userKey);
          if (member) {
            const displayName = getMemberDisplayName(member);
            allResponses[eventId][displayName] = response.status;
          }
        });
      });
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å³åº§ã«æç”»ï¼ˆAPIå‘¼ã³å‡ºã—ãªã—ï¼ï¼‰
      renderGridTable(allResponses);
    }

    /**
     * ã‚°ãƒªãƒƒãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®Ÿéš›ã«æç”»
     */
    function renderGridTable(allResponses) {
      const gridContainer = document.getElementById('attendance-grid');
      gridContainer.innerHTML = '';

      // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ—¥ä»˜ã®æ˜‡é †ã§ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„æ—¥ä»˜ãŒä¸Šã€è¥¿æš¦ã‚‚å«ã‚ã¦æ­£ç¢ºã«ã‚½ãƒ¼ãƒˆï¼‰
      const sortedEvents = [...currentEvents].sort((a, b) => {
        // ISO 8601å½¢å¼ã®æ–‡å­—åˆ—ã‚’ç¢ºå®Ÿã«ãƒ‘ãƒ¼ã‚¹
        const dateA = new Date(a.start);
        const dateB = new Date(b.start);
        // ç„¡åŠ¹ãªæ—¥ä»˜ã®å ´åˆã¯æœ€å¾Œã«
        if (isNaN(dateA.getTime())) return 1;
        if (isNaN(dateB.getTime())) return -1;
        return dateA.getTime() - dateB.getTime(); // æ˜‡é †
      });

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
      const table = document.createElement('table');
      table.className = 'attendance-grid';

      // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ2è¡Œæ§‹æˆï¼‰
      const thead = document.createElement('thead');
      
      // 1è¡Œç›®ï¼šã‚¤ãƒ™ãƒ³ãƒˆã€å‡¡ä¾‹ã€ãƒ‘ãƒ¼ãƒˆ
      const headerRow1 = document.createElement('tr');
      
      // æœ€åˆã®åˆ—ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆåï¼‰- 2è¡Œçµåˆ
      const dateHeader = document.createElement('th');
      dateHeader.rowSpan = 2;
      dateHeader.textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆ';
      headerRow1.appendChild(dateHeader);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‡¡ä¾‹ - 2è¡Œçµåˆï¼ˆå¹…ã‚’å›ºå®šï¼‰
      const legendHeader = document.createElement('th');
      legendHeader.rowSpan = 2;
      legendHeader.colSpan = 3;
      legendHeader.style.minWidth = '120px';
      legendHeader.style.width = '120px';
      legendHeader.style.maxWidth = '120px';
      legendHeader.innerHTML = '<div style="display: flex; gap: 10px; justify-content: center;"><span>â—‹</span><span>â–³</span><span>Ã—</span></div>';
      headerRow1.appendChild(legendHeader);

      // ãƒ¡ãƒ³ãƒãƒ¼åˆ—ï¼ˆãƒ‘ãƒ¼ãƒˆã”ã¨ã«ã‚½ãƒ¼ãƒˆï¼‰
      const sortedMembers = [...memberList].sort((a, b) => {
        const partA = typeof a === 'object' ? (a.part || '') : parseMemberName(getMemberDisplayName(a)).part;
        const partB = typeof b === 'object' ? (b.part || '') : parseMemberName(getMemberDisplayName(b)).part;
        
        // ãƒ‘ãƒ¼ãƒˆã®é †åºã‚’å®šç¾©ï¼ˆãƒ¦ãƒ¼ãƒ•ã‚©ãƒ‹ã‚¢ãƒ ã¨ãƒãƒ¥ãƒ¼ãƒã¯ãƒã‚¹ãƒ‘ãƒ¼ãƒˆã«çµ±åˆï¼‰
        const partOrder = ['Fl', 'Ob', 'Cl', 'Sax', 'Hr', 'Tp', 'Tb', 'Bass', 'Perc', 'ãã®ä»–'];
        const indexA = partOrder.indexOf(partA);
        const indexB = partOrder.indexOf(partB);
        
        // ãƒ‘ãƒ¼ãƒˆé †ã§ã‚½ãƒ¼ãƒˆï¼ˆè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€å¾Œã«ï¼‰
        if (indexA !== -1 && indexB !== -1) {
          if (indexA !== indexB) {
            return indexA - indexB;
          }
        } else if (indexA === -1 && indexB !== -1) {
          return 1;
        } else if (indexA !== -1 && indexB === -1) {
          return -1;
        }
        
        // åŒã˜ãƒ‘ãƒ¼ãƒˆå†…ã§ã¯åå‰ã§ã‚½ãƒ¼ãƒˆ
        const nameA = typeof a === 'object' ? (a.name || '') : parseMemberName(getMemberDisplayName(a)).name;
        const nameB = typeof b === 'object' ? (b.name || '') : parseMemberName(getMemberDisplayName(b)).name;
        return nameA.localeCompare(nameB, 'ja');
      });
      
      // ãƒ‘ãƒ¼ãƒˆã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const membersByPart = {};
      sortedMembers.forEach(member => {
        const displayName = getMemberDisplayName(member);
        const part = typeof member === 'object' ? (member.part || '') : parseMemberName(displayName).part;
        if (!membersByPart[part]) {
          membersByPart[part] = [];
        }
        membersByPart[part].push(member);
      });
      
      // 1è¡Œç›®ï¼šãƒ‘ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆåŒã˜ãƒ‘ãƒ¼ãƒˆã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’çµåˆï¼‰
      Object.keys(membersByPart).forEach(part => {
        const partHeader = document.createElement('th');
        partHeader.colSpan = membersByPart[part].length;
        partHeader.textContent = part || 'ãã®ä»–';
        partHeader.style.fontSize = '0.85rem';
        partHeader.style.fontWeight = 'bold';
        partHeader.style.color = '#333';
        partHeader.style.padding = '4px 6px';
        partHeader.style.lineHeight = '1.2';
        partHeader.style.backgroundColor = '#f0f0f0';
        headerRow1.appendChild(partHeader);
      });
      
      thead.appendChild(headerRow1);
      
      // 2è¡Œç›®ï¼šåå‰ï¼ˆãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
      const headerRow2 = document.createElement('tr');
      
      sortedMembers.forEach(member => {
        const displayName = getMemberDisplayName(member);
        const name = typeof member === 'object' ? (member.name || '') : parseMemberName(displayName).name;
        
        const nameHeader = document.createElement('th');
        nameHeader.style.padding = '6px 8px';
        nameHeader.style.lineHeight = '1.3';
        nameHeader.style.maxWidth = '150px';
        nameHeader.style.minWidth = '120px';
        nameHeader.style.width = '150px';
        // z-indexã‚’æ˜ç¤ºçš„ã«è¨­å®šã—ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆåˆ—ã‚ˆã‚Šä½ãã™ã‚‹
        nameHeader.style.zIndex = '9';
        
        // åå‰ã‚’ãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ«ã§è¡¨ç¤º
        const nameLink = document.createElement('a');
        nameLink.href = '#';
        nameLink.style.display = '-webkit-box';
        nameLink.style.webkitBoxOrient = 'vertical';
        nameLink.style.webkitLineClamp = '2';
        nameLink.style.overflow = 'hidden';
        nameLink.style.textOverflow = 'ellipsis';
        nameHeader.style.textAlign = 'center';
        nameLink.style.color = selectedMember === displayName ? '#667eea' : '#0066cc';
        nameLink.style.textDecoration = selectedMember === displayName ? 'underline' : 'underline';
        nameLink.style.fontSize = '0.85rem';
        nameLink.style.fontWeight = selectedMember === displayName ? 'bold' : 'normal';
        nameLink.style.cursor = 'pointer';
        nameLink.style.transition = 'all 0.2s';
        nameLink.style.wordBreak = 'break-word';
        nameLink.style.lineHeight = '1.3';
        
        // åå‰ã‚’ãã®ã¾ã¾è¡¨ç¤ºï¼ˆ2è¡Œã§è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
        nameLink.textContent = name || '';
        if (name && name.length > 20) {
          nameLink.title = name; // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§å…¨æ–‡è¡¨ç¤º
        }
        
        nameLink.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          selectMember(displayName);
        };
        
        nameLink.onmouseenter = () => {
          nameLink.style.color = '#004499';
          nameLink.style.textDecoration = 'underline';
        };
        
        nameLink.onmouseleave = () => {
          if (selectedMember === displayName) {
            nameLink.style.color = '#667eea';
            nameLink.style.fontWeight = 'bold';
          } else {
            nameLink.style.color = '#0066cc';
            nameLink.style.fontWeight = 'normal';
          }
        };
        
        // é¸æŠã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ã®ãƒªãƒ³ã‚¯ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        if (selectedMember === displayName) {
          nameLink.style.color = '#667eea';
          nameLink.style.fontWeight = 'bold';
        }
        
        nameHeader.appendChild(nameLink);
        headerRow2.appendChild(nameHeader);
      });
      
      thead.appendChild(headerRow2);
      table.appendChild(thead);

      // ãƒ‡ãƒ¼ã‚¿è¡Œ
      const tbody = document.createElement('tbody');
      sortedEvents.forEach(event => {
        const row = document.createElement('tr');
        
        // æ—¥ä»˜/ã‚¤ãƒ™ãƒ³ãƒˆåã‚»ãƒ«ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆåã€æ—¥æ™‚ã€å ´æ‰€ã‚’å…¨ã¦è¡¨ç¤ºï¼‰
        const dateCell = document.createElement('td');
        dateCell.style.verticalAlign = 'top';
        dateCell.style.padding = '6px 8px';
        
        // UTCã‚’JSTã«å¤‰æ›
        const startDate = utcToJST(event.start);
        const endDate = utcToJST(event.end);
        
        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        const dateStr = `${startDate.getFullYear()}å¹´${startDate.getMonth() + 1}æœˆ${startDate.getDate()}æ—¥(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][startDate.getDay()]})`;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’HTMLã§æ§‹ç¯‰
        const eventInfo = document.createElement('div');
        eventInfo.style.display = 'flex';
        eventInfo.style.flexDirection = 'column';
        eventInfo.style.gap = '2px';
        
        // 1è¡Œç›®ï¼šã‚¤ãƒ™ãƒ³ãƒˆå
        const titleRow = document.createElement('div');
        titleRow.style.fontSize = '0.85rem';
        titleRow.style.color = '#333';
        titleRow.style.fontWeight = '500';
        titleRow.style.whiteSpace = 'nowrap';
        titleRow.style.overflow = 'hidden';
        titleRow.style.textOverflow = 'ellipsis';
        titleRow.style.lineHeight = '1.2';
        
        const eventTitle = event.title || 'äºˆå®š';
        titleRow.textContent = eventTitle;
        if (eventTitle.length > 25) {
          titleRow.title = eventTitle; // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§å…¨æ–‡è¡¨ç¤º
          titleRow.style.cursor = 'help';
        }
        eventInfo.appendChild(titleRow);
        
        // 2è¡Œç›®ï¼šå ´æ‰€ï¼ˆæœªè¨­å®šã®å ´åˆã¯è¡¨ç¤ºã—ãªã„ï¼‰
        if (event.location) {
          const locationRow = document.createElement('div');
          locationRow.style.fontSize = '0.85rem';
          locationRow.style.color = '#666';
          locationRow.style.lineHeight = '1.2';
          locationRow.style.whiteSpace = 'nowrap';
          locationRow.style.overflow = 'hidden';
          locationRow.style.textOverflow = 'ellipsis';
          const locationText = `ğŸ“${event.location}`;
          locationRow.textContent = locationText;
          // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§å…¨æ–‡è¡¨ç¤º
          if (locationText.length > 20) {
            locationRow.title = locationText;
            locationRow.style.cursor = 'help';
          }
          eventInfo.appendChild(locationRow);
        }
        
        // 3è¡Œç›®ï¼šæ—¥ä»˜ãƒ»æ™‚åˆ»ï¼ˆ11/15(åœŸ) 13:00ï½17:00 ã¾ãŸã¯ çµ‚æ—¥ï¼‰
        const dateTimeDiv = document.createElement('div');
        dateTimeDiv.style.fontSize = '0.8rem';
        dateTimeDiv.style.color = '#666';
        dateTimeDiv.style.lineHeight = '1.2';
        
        // çµ‚æ—¥ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆevent.isAllDayãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ï¼‰
        const isAllDay = event.isAllDay === true || event.isAllDay === 'TRUE' || event.isAllDay === 1 || event.isAllDay === '1';
        
        // é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ãŒç•°ãªã‚‹æ—¥ä»˜ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆUTCæ–‡å­—åˆ—ã‹ã‚‰ç›´æ¥æ—¥ä»˜éƒ¨åˆ†ã‚’æŠ½å‡ºï¼‰
        // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã€endãŒç¿Œæ—¥ã®00:00:00ã§ã‚‚1æ—¥ã®çµ‚æ—¥ã¨ã—ã¦æ‰±ã†
        let startDateOnlyStr = getDateFromUTC(event.start);
        let endDateOnlyStr = getDateFromUTC(event.end);
        
        if (isAllDay) {
          // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã€endãŒç¿Œæ—¥ã®00:00:00ã®å ´åˆã¯å‰æ—¥ã®æ—¥ä»˜ã¨ã—ã¦æ‰±ã†
          const endDate = new Date(event.end);
          const endDateOnly = new Date(endDate.getUTCFullYear(), endDate.getUTCMonth(), endDate.getUTCDate());
          const startDateOnly = new Date(new Date(event.start).getUTCFullYear(), new Date(event.start).getUTCMonth(), new Date(event.start).getUTCDate());
          // endãŒstartã®ç¿Œæ—¥ã§ã€æ™‚åˆ»ãŒ00:00:00ã®å ´åˆã¯1æ—¥ã®çµ‚æ—¥ã¨ã—ã¦æ‰±ã†
          if (endDateOnly.getTime() - startDateOnly.getTime() === 24 * 60 * 60 * 1000 && 
              endDate.getUTCHours() === 0 && endDate.getUTCMinutes() === 0 && endDate.getUTCSeconds() === 0) {
            endDateOnlyStr = startDateOnlyStr; // åŒã˜æ—¥ã¨ã—ã¦æ‰±ã†
          }
        }
        
        const isMultiDay = startDateOnlyStr !== endDateOnlyStr;
        
        let dateStrShort;
        if (isMultiDay) {
          // è¤‡æ•°æ—¥ã®å ´åˆã¯é–‹å§‹æ—¥ï½çµ‚äº†æ—¥ã‚’è¡¨ç¤º
          const startDateDisplayStr = `${startDate.getMonth() + 1}/${startDate.getDate()}(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][startDate.getDay()]})`;
          const endDateDisplayStr = `${endDate.getMonth() + 1}/${endDate.getDate()}(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][endDate.getDay()]})`;
          dateStrShort = `${startDateDisplayStr}ï½${endDateDisplayStr}`;
        } else {
          // å˜æ—¥ã®å ´åˆã¯é–‹å§‹æ—¥ã®ã¿
          dateStrShort = `${startDate.getMonth() + 1}/${startDate.getDate()}(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][startDate.getDay()]})`;
        }
        
        let timeDisplay;
        if (isAllDay) {
          timeDisplay = 'çµ‚æ—¥';
        } else {
          // æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆJSTã§è¡¨ç¤ºï¼‰
          const startTimeStr = `${String(startDate.getHours()).padStart(2, '0')}:${String(startDate.getMinutes()).padStart(2, '0')}`;
          const endTimeStr = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
          timeDisplay = `${startTimeStr}ï½${endTimeStr}`;
        }
        dateTimeDiv.textContent = `${dateStrShort} ${timeDisplay}`;
        eventInfo.appendChild(dateTimeDiv);
        
        dateCell.appendChild(eventInfo);
        // äºˆå®šã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã—ã¦ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        dateCell.style.cursor = 'pointer';
        dateCell.onclick = () => showEventDetailModal(event.id);
        row.appendChild(dateCell);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‡¡ä¾‹ã‚»ãƒ«ï¼ˆ3ã¤ã®ã‚»ãƒ«ï¼‰- å„ã‚¤ãƒ™ãƒ³ãƒˆã®â—‹/â–³/Ã—ã®åˆè¨ˆæ•°ã‚’è¡¨ç¤º
        const statusCounts = { 'â—‹': 0, 'â–³': 0, 'Ã—': 0 };
        
        // ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã®å…¨ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é›†è¨ˆï¼ˆã‚½ãƒ¼ãƒˆæ¸ˆã¿ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ï¼‰
        sortedMembers.forEach(member => {
          const displayName = getMemberDisplayName(member);
          const serverStatus = allResponses[event.id] && allResponses[event.id][displayName];
          const gridStatus = gridData[event.id] && gridData[event.id][displayName];
          const status = gridStatus || serverStatus;
          
          if (status === 'â—‹' || status === 'â–³' || status === 'Ã—') {
            statusCounts[status]++;
          }
        });
        
        // â—‹/â–³/Ã—ã®åˆè¨ˆæ•°ã‚’è¡¨ç¤ºï¼ˆå¹…ã‚’å›ºå®šï¼‰
        ['â—‹', 'â–³', 'Ã—'].forEach(status => {
          const legendCell = document.createElement('td');
          legendCell.style.textAlign = 'center';
          legendCell.style.fontSize = '1.1rem';
          legendCell.style.fontWeight = 'bold';
          legendCell.style.verticalAlign = 'middle';
          legendCell.style.minWidth = '40px';
          legendCell.style.width = '40px';
          legendCell.style.maxWidth = '40px';
          
          const count = statusCounts[status];
          if (count > 0) {
            legendCell.textContent = `${status} ${count}`;
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸè‰²ã‚’è¨­å®š
            if (status === 'â—‹') {
              legendCell.style.color = '#4caf50';
            } else if (status === 'â–³') {
              legendCell.style.color = '#ff9800';
            } else if (status === 'Ã—') {
              legendCell.style.color = '#f44336';
            }
          } else {
            legendCell.textContent = status;
            legendCell.style.color = '#ccc';
          }
          
          row.appendChild(legendCell);
        });

        // ãƒ¡ãƒ³ãƒãƒ¼ã”ã¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚»ãƒ«ï¼ˆã‚½ãƒ¼ãƒˆæ¸ˆã¿ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ï¼‰
        sortedMembers.forEach(member => {
          const displayName = getMemberDisplayName(member);
          const statusCell = document.createElement('td');
          statusCell.className = 'status-cell status-none';
          statusCell.dataset.eventId = event.id;
          statusCell.dataset.memberName = displayName;
          // è¡¨å½¢å¼ã§ã¯ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´ã§ããªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆãƒ¡ãƒ³ãƒãƒ¼åã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰å¤‰æ›´ï¼‰
          // statusCell.onclick = () => toggleStatus(event.id, displayName);
          statusCell.style.cursor = 'default';
          statusCell.style.verticalAlign = 'middle';
          
          // é¸æŠã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ã®åˆ—ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          if (selectedMember === displayName) {
            statusCell.style.backgroundColor = '#e8f5e9';
            statusCell.style.borderLeft = '3px solid #667eea';
            statusCell.style.borderRight = '3px solid #667eea';
          }
          
          // æ—¢å­˜ã®å‡ºæ¬ æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ + gridDataï¼‰
          const serverStatus = allResponses[event.id] && allResponses[event.id][displayName];
          const gridStatus = gridData[event.id] && gridData[event.id][displayName];
          const existingStatus = gridStatus !== undefined ? gridStatus : (serverStatus !== undefined ? serverStatus : null);
          
          // ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆundefined/null ã¨ '-' ã‚’åŒºåˆ¥ï¼‰
          // serverStatusã¾ãŸã¯gridStatusãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼ˆ'-'ã‚‚å«ã‚€ï¼‰ã¯ç™»éŒ²æ¸ˆã¿ã¨ã¿ãªã™
          const hasData = serverStatus !== undefined || gridStatus !== undefined;
          
          if (hasData) {
            // ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆ
            statusCell.textContent = existingStatus || '-';
            if (existingStatus === '-' || existingStatus === null || existingStatus === undefined) {
              // ç™»éŒ²æ¸ˆã¿ã§æœªé¸æŠã®å ´åˆã¯ status-none ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ï¼ˆã‚°ãƒ¬ãƒ¼ã§è¡¨ç¤ºï¼‰
              statusCell.className = 'status-cell status-none';
            } else if (existingStatus === 'â—‹') {
              statusCell.className = 'status-cell status-attend';
            } else if (existingStatus === 'â–³') {
              statusCell.className = 'status-cell status-maybe';
            } else if (existingStatus === 'Ã—') {
              statusCell.className = 'status-cell status-absent';
            } else {
              // ãã®ä»–ã®å ´åˆã¯ status-none
              statusCell.className = 'status-cell status-none';
            }
          } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆï¼ˆæœªç™»éŒ²ï¼‰ã¯ç™½ã§è¡¨ç¤º
            statusCell.textContent = '-';
            statusCell.className = 'status-cell status-unregistered';
          }
          
          row.appendChild(statusCell);
        });

        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      gridContainer.appendChild(table);
      
      // ä¸Šéƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã«ãƒ€ãƒŸãƒ¼è¦ç´ ã‚’è¿½åŠ ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ãŸã‚ï¼‰
      const topScrollbar = document.getElementById('attendance-grid-scrollbar-top');
      if (topScrollbar) {
        const dummyDiv = document.createElement('div');
        dummyDiv.style.width = '1px';
        dummyDiv.style.height = '1px';
        topScrollbar.appendChild(dummyDiv);
      }
      
      // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã‹ã©ã†ã‹ã‚’æ¤œå‡ºã—ã¦ã€è¦–è¦šçš„ãªã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¿½åŠ 
      setTimeout(() => {
        updateScrollIndicators(gridContainer);
        // ä¸Šéƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®å¹…ã‚’æ›´æ–°
        if (topScrollbar) {
          const dummyDiv = topScrollbar.querySelector('div');
          if (dummyDiv && table.offsetWidth) {
            dummyDiv.style.width = table.offsetWidth + 'px';
          }
        }
      }, 100);
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
      gridContainer.addEventListener('scroll', () => {
        updateScrollIndicators(gridContainer);
        // ä¸Šéƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚‚åŒæœŸ
        if (topScrollbar) {
          topScrollbar.scrollLeft = gridContainer.scrollLeft;
        }
      });
      
      // ä¸Šéƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«ã‚‚åŒæœŸ
      if (topScrollbar) {
        topScrollbar.addEventListener('scroll', () => {
          gridContainer.scrollLeft = topScrollbar.scrollLeft;
          updateScrollIndicators(gridContainer);
        });
      }
      
      // ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚‚æ›´æ–°
      let resizeTimer;
      const resizeHandler = () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          updateScrollIndicators(gridContainer);
          if (topScrollbar) {
            const dummyDiv = topScrollbar.querySelector('div');
            if (dummyDiv && table.offsetWidth) {
              dummyDiv.style.width = table.offsetWidth + 'px';
            }
          }
        }, 100);
      };
      window.addEventListener('resize', resizeHandler);
    }

    /**
     * ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
     */
    function updateScrollIndicators(container) {
      const isScrollable = container.scrollWidth > container.clientWidth;
      const scrollLeft = container.scrollLeft;
      const scrollRight = container.scrollWidth - container.scrollLeft - container.clientWidth;
      const topScrollbar = document.getElementById('attendance-grid-scrollbar-top');
      
      // ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°ï¼ˆä¸€æ—¦å…¨ã¦å‰Šé™¤ï¼‰
      container.classList.remove('scrollable-left', 'scrollable-right');
      
      if (isScrollable) {
        // ä¸Šéƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’è¡¨ç¤º
        if (topScrollbar) {
          topScrollbar.classList.add('visible');
          // ä¸Šéƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®å¹…ã‚’åŒæœŸ
          const table = container.querySelector('table');
          if (table) {
            const dummyDiv = topScrollbar.querySelector('div');
            if (dummyDiv) {
              dummyDiv.style.width = table.offsetWidth + 'px';
            }
            topScrollbar.style.width = container.clientWidth + 'px';
            topScrollbar.scrollLeft = scrollLeft;
          }
        }
        
        // å·¦å´ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šå·¦ç«¯ã«ã„ãªã„æ™‚ã®ã¿è¡¨ç¤ºï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã§ã€ã‹ã¤å·¦ç«¯ã«ã„ãªã„ï¼‰
        if (scrollLeft > 5) {
          container.classList.add('scrollable-left');
        }
        
        // å³å´ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šå³ç«¯ã«ã„ãªã„æ™‚ã®ã¿è¡¨ç¤ºï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã§ã€ã‹ã¤å³ç«¯ã«ã„ãªã„ï¼‰
        if (scrollRight > 5) {
          container.classList.add('scrollable-right');
        }
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªå ´åˆã€æœ€åˆã®è¡¨ç¤ºæ™‚ã«ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º
        if (!container.dataset.hintShown && scrollLeft < 5) {
          const existingHint = container.querySelector('.scroll-hint');
          if (!existingHint) {
            const hint = document.createElement('div');
            hint.className = 'scroll-hint';
            hint.textContent = 'â† â†’ æ¨ªã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã¾ã™';
            container.style.position = 'relative';
            container.appendChild(hint);
            container.dataset.hintShown = 'true';
            
            // 3ç§’å¾Œã«å‰Šé™¤
            setTimeout(() => {
              if (hint.parentNode) {
                hint.remove();
              }
            }, 3000);
          }
        }
      } else {
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸å¯èƒ½ãªå ´åˆã¯ä¸Šéƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤º
        if (topScrollbar) {
          topScrollbar.classList.remove('visible');
        }
      }
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€ï¼ˆlocalStorageã‹ã‚‰ï¼‰
     */
    function loadMemberList() {
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’å–å¾—ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç®¡ç†ï¼‰
      google.script.run
        .withSuccessHandler((serverMembers) => {
          if (serverMembers && Array.isArray(serverMembers) && serverMembers.length > 0) {
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’memberListã«åæ˜ 
            memberList = serverMembers.map(m => ({
              part: m.part || '',
              name: m.name || '',
              displayName: m.displayName || (m.part + m.name),
              userKey: m.userKey
            }));
          } else {
            memberList = [];
          }
        })
        .withFailureHandler((error) => {
          console.error('ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          memberList = [];
        })
        .getMembersList();
    }

    /**
     * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
     */
    function getStatus(eventId, memberName) {
      if (!gridData[eventId]) return null;
      return gridData[eventId][memberName] || null;
    }

    /**
     * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆï¼ˆâ—‹ â†’ â–³ â†’ Ã— â†’ â—‹ï¼‰
     */
    function toggleStatus(eventId, memberName) {
      if (!gridData[eventId]) {
        gridData[eventId] = {};
      }
      
      const current = gridData[eventId][memberName] || null;
      const next = current === 'â—‹' ? 'â–³' : current === 'â–³' ? 'Ã—' : current === 'Ã—' ? null : 'â—‹';
      
      if (next) {
        gridData[eventId][memberName] = next;
      } else {
        delete gridData[eventId][memberName];
      }
      
      // UIã‚’æ›´æ–°
      const cell = document.querySelector(`td[data-event-id="${eventId}"][data-member-name="${memberName}"]`);
      if (cell) {
        if (next) {
          cell.textContent = next;
          cell.className = 'status-cell status-' + (next === 'â—‹' ? 'attend' : next === 'â–³' ? 'maybe' : 'absent');
        } else {
          cell.textContent = '-';
          cell.className = 'status-cell status-none';
        }
      }
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ
     */
    function selectMember(memberName) {
      selectedMember = memberName;
      // ã‚°ãƒªãƒƒãƒ‰ã‚’å†æç”»ã›ãšã«ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ç›´æ¥è¡¨ç¤º
      // renderGrid()ã‚’å‘¼ã¶ã¨ã€ã‚°ãƒªãƒƒãƒ‰ãŒå†æç”»ã•ã‚Œã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
      
      // ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      showMemberEditModal(memberName);
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«ã‚°ãƒªãƒƒãƒ‰ã‚’å†æç”»ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ›´æ–°
      setTimeout(() => {
        renderGrid();
        // åå‰ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
        updateMemberLinkStyles();
      }, 100);
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°ï¼ˆé¸æŠçŠ¶æ…‹ã«å¿œã˜ã¦ï¼‰
     */
    function updateMemberLinkStyles() {
      const nameLinks = document.querySelectorAll('#attendance-grid th a[href="#"]');
      nameLinks.forEach(link => {
        const displayName = link.textContent.trim();
        // ãƒªãƒ³ã‚¯ã®è¦ªè¦ç´ ã‹ã‚‰å®Œå…¨ãªè¡¨ç¤ºåã‚’å–å¾—
        const memberHeader = link.closest('th');
        if (memberHeader) {
          const fullDisplayName = link.title || displayName;
          if (selectedMember === fullDisplayName) {
            link.style.color = '#667eea';
            link.style.fontWeight = 'bold';
            link.style.textDecoration = 'underline';
          } else {
            link.style.color = '#0066cc';
            link.style.fontWeight = 'normal';
            link.style.textDecoration = 'underline';
          }
        }
      });
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
     */
    function showMemberEditModal(memberName) {
      const modal = document.getElementById('member-edit-modal');
      
      if (!modal) {
        console.error('ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—
      const member = memberList.find(m => getMemberDisplayName(m) === memberName);
      let currentPart = '';
      let currentName = '';
      
      if (member && typeof member === 'object') {
        currentPart = member.part || '';
        currentName = member.name || '';
      } else {
        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®äº’æ›æ€§ï¼šæ–‡å­—åˆ—å½¢å¼ã®å ´åˆã€ãƒ‘ãƒ¼ãƒˆã¨åå‰ã‚’åˆ†é›¢
        const parsed = parseMemberName(memberName);
        currentPart = parsed.part || '';
        currentName = parsed.name || '';
      }
      
      // ãƒ‘ãƒ¼ãƒˆã¨åå‰ã‚’è¡¨ç¤º
      const partDisplay = document.getElementById('member-part-display');
      const nameDisplay = document.getElementById('member-name-display');
      if (partDisplay) {
        const partLabels = {
          'Fl': 'Fl (ãƒ•ãƒ«ãƒ¼ãƒˆ)',
          'Ob': 'Ob (ã‚ªãƒ¼ãƒœã‚¨)',
          'Cl': 'Cl (ã‚¯ãƒ©ãƒªãƒãƒƒãƒˆ)',
          'Sax': 'Sax (ã‚µãƒƒã‚¯ã‚¹)',
          'Hr': 'Hr (ãƒ›ãƒ«ãƒ³)',
          'Tp': 'Tp (ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆ)',
          'Tb': 'Tb (ãƒˆãƒ­ãƒ³ãƒœãƒ¼ãƒ³)',
          'Bass': 'Bass (ãƒã‚¹)',
          'Perc': 'Perc (æ‰“æ¥½å™¨)',
          'ãã®ä»–': 'ãã®ä»–'
        };
        partDisplay.textContent = partLabels[currentPart] || currentPart || '-';
      }
      if (nameDisplay) {
        nameDisplay.textContent = currentName || '-';
      }
      
      // å„æ—¥ç¨‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠUIã‚’ç”Ÿæˆ
      renderEventStatusList(memberName);
      
      modal.style.display = 'block';
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼åã‚’ãƒ‘ãƒ¼ãƒˆã¨åå‰ã«åˆ†é›¢ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®äº’æ›æ€§ã®ãŸã‚ï¼‰
     */
    function parseMemberName(displayName) {
      // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã®äº’æ›æ€§ã®ãŸã‚ã€`.`ä»˜ãã¨`.`ãªã—ã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯
      // ãƒ¦ãƒ¼ãƒ•ã‚©ãƒ‹ã‚¢ãƒ ï¼ˆEuï¼‰ã¨ãƒãƒ¥ãƒ¼ãƒï¼ˆTubaï¼‰ã¯ãƒã‚¹ãƒ‘ãƒ¼ãƒˆï¼ˆBassï¼‰ã«çµ±åˆ
      const parts = ['Fl', 'Ob', 'Cl', 'Sax', 'Hr', 'Tp', 'Tb', 'Bass', 'Perc', 'ãã®ä»–'];
      const partsWithDot = ['Fl.', 'Ob.', 'Cl.', 'Sax.', 'Hr.', 'Tp', 'Tb.', 'Bass', 'Tuba', 'Perc.', 'ãã®ä»–'];
      
      // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®äº’æ›æ€§ï¼šãƒ¦ãƒ¼ãƒ•ã‚©ãƒ‹ã‚¢ãƒ ã¨ãƒãƒ¥ãƒ¼ãƒã‚’ãƒã‚¹ãƒ‘ãƒ¼ãƒˆã«å¤‰æ›
      if (displayName.startsWith('Eu') || displayName.startsWith('Eu.') || 
          displayName.startsWith('Tuba') || displayName.startsWith('Tuba.')) {
        let name = displayName;
        if (displayName.startsWith('Eu.')) {
          name = 'Bass' + displayName.substring(3);
        } else if (displayName.startsWith('Eu')) {
          name = 'Bass' + displayName.substring(2);
        } else if (displayName.startsWith('Tuba.')) {
          name = 'Bass' + displayName.substring(5);
        } else if (displayName.startsWith('Tuba')) {
          name = 'Bass' + displayName.substring(4);
        }
        return {
          part: 'Bass',
          name: name.substring(4) // 'Bass'ã‚’é™¤ã„ãŸéƒ¨åˆ†
        };
      }
      
      // ã¾ãš`.`ãªã—ã§ãƒã‚§ãƒƒã‚¯
      for (let i = 0; i < parts.length; i++) {
        const part = parts[i];
        const partWithDot = partsWithDot[i];
        if (partWithDot && displayName.startsWith(partWithDot)) {
          return {
            part: part, // `.`ãªã—ã§è¿”ã™
            name: displayName.substring(partWithDot.length)
          };
        }
        if (displayName.startsWith(part)) {
          return {
            part: part,
            name: displayName.substring(part.length)
          };
        }
      }
      return { part: '', name: displayName };
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‹ã‚‰è¡¨ç¤ºåã‚’ç”Ÿæˆ
     */
    function getMemberDisplayName(member) {
      if (typeof member === 'string') {
        return member; // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®äº’æ›æ€§
      }
      return (member.part || '') + (member.name || '');
    }

    /**
     * å„æ—¥ç¨‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠUIã‚’ç”Ÿæˆ
     */
    function renderEventStatusList(memberName) {
      const container = document.getElementById('event-status-list');
      
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯èª­ã¿è¾¼ã¿è¡¨ç¤º
      if (!window.allResponsesCache || Object.keys(window.allResponsesCache).length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666; background-color: #f8f9fa; border-radius: 6px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯ã€ãƒãƒƒãƒAPIã§å–å¾—
        google.script.run
          .withSuccessHandler((result) => {
            if (result.success && result.responsesMap) {
              window.allResponsesCache = result.responsesMap;
              // å†å¸°çš„ã«å‘¼ã³å‡ºã—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹çŠ¶æ…‹ã§ï¼‰
              renderEventStatusList(memberName);
            } else {
              container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
          })
          .withFailureHandler((error) => {
            console.error('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
          })
          .getAllEventsWithResponses();
        
        return;
      }

      if (currentEvents.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666; background-color: #f8f9fa; border-radius: 6px; font-weight: 500;">ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—:', memberName);

      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå‡ºæ¬ ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼ˆAPIå‘¼ã³å‡ºã—ãªã—ï¼ï¼‰
      const responsesMap = window.allResponsesCache;
      const eventStatusMap = {}; // {eventId: {status, comment}}
      
      // é¸æŠã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ã®userKeyã‚’å–å¾—
      const selectedMemberObj = memberList.find(m => getMemberDisplayName(m) === memberName);
      if (!selectedMemberObj) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      // å„ã‚¤ãƒ™ãƒ³ãƒˆã®å‡ºæ¬ æƒ…å ±ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
      currentEvents.forEach(event => {
        if (responsesMap[event.id]) {
          const memberResponse = responsesMap[event.id].find(r => r.userKey === selectedMemberObj.userKey);
          if (memberResponse) {
            eventStatusMap[event.id] = {
              status: memberResponse.status,
              comment: memberResponse.comment || ''
            };
            
            // userKeyã‚’memberListã«åæ˜ ï¼ˆåˆå›ã®ã¿ï¼‰
            if (!selectedMemberObj.userKey) {
              selectedMemberObj.userKey = memberResponse.userKey;
            }
          }
        }
      });
      
      // UIã‚’å³åº§ã«æç”»ï¼ˆAPIå‘¼ã³å‡ºã—ãªã—ï¼ï¼‰
      renderEventStatusListUI(memberName, eventStatusMap);
    }

    /**
     * å„æ—¥ç¨‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠUIã‚’å®Ÿéš›ã«æç”»
     */
    function renderEventStatusListUI(memberName, eventStatusMap) {
      const container = document.getElementById('event-status-list');
      container.innerHTML = '';

      // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ—¥ä»˜æ˜‡é †ã§ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„æ—¥ä»˜ãŒä¸Šã€è¥¿æš¦ã‚‚å«ã‚ã¦æ­£ç¢ºã«ã‚½ãƒ¼ãƒˆï¼‰
      const sortedEvents = [...currentEvents].sort((a, b) => {
        // ISO 8601å½¢å¼ã®æ–‡å­—åˆ—ã‚’ç¢ºå®Ÿã«ãƒ‘ãƒ¼ã‚¹
        const dateA = new Date(a.start);
        const dateB = new Date(b.start);
        // ç„¡åŠ¹ãªæ—¥ä»˜ã®å ´åˆã¯æœ€å¾Œã«
        if (isNaN(dateA.getTime())) return 1;
        if (isNaN(dateB.getTime())) return -1;
        return dateA.getTime() - dateB.getTime(); // æ˜‡é †
      });

      sortedEvents.forEach(event => {
        const eventRow = document.createElement('div');
        eventRow.style.padding = '8px 12px';
        eventRow.style.borderBottom = '1px solid #e0e0e0';
        eventRow.style.display = 'flex';
        eventRow.style.flexDirection = 'column';
        eventRow.style.gap = '6px';
        eventRow.style.backgroundColor = '#ffffff';

        // ä¸Šéƒ¨ï¼šæ—¥ä»˜/ã‚¤ãƒ™ãƒ³ãƒˆåã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ
        const topRow = document.createElement('div');
        topRow.style.display = 'flex';
        topRow.style.alignItems = 'center';
        topRow.style.gap = '15px';

        // æ—¥ä»˜/ã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆ2è¡Œè¡¨ç¤ºï¼š1è¡Œç›®ã«æ—¥ä»˜ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆåãƒ»å ´æ‰€ã€2è¡Œç›®ã«æ™‚é–“ï¼‰
        const dateLabelContainer = document.createElement('div');
        dateLabelContainer.style.flex = '1';
        dateLabelContainer.style.minWidth = '200px';
        dateLabelContainer.style.display = 'flex';
        dateLabelContainer.style.flexDirection = 'column';
        dateLabelContainer.style.gap = '2px';
        
        // UTCã‚’JSTã«å¤‰æ›
        const startDate = utcToJST(event.start);
        const endDate = utcToJST(event.end);
        const dateStr = `${startDate.getMonth() + 1}/${startDate.getDate()}(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][startDate.getDay()]})`;
        const eventTitle = event.title || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰';
        
        // çµ‚æ—¥ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆevent.isAllDayãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ï¼‰
        const isAllDay = event.isAllDay === true || event.isAllDay === 'TRUE' || event.isAllDay === 1 || event.isAllDay === '1';
        
        let timeDisplay;
        if (isAllDay) {
          timeDisplay = 'çµ‚æ—¥';
        } else {
          // æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆJSTã§è¡¨ç¤ºï¼‰
          const startTimeStr = `${String(startDate.getHours()).padStart(2, '0')}:${String(startDate.getMinutes()).padStart(2, '0')}`;
          const endTimeStr = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
          timeDisplay = `${startTimeStr}ï½${endTimeStr}`;
        }
        
        // 1è¡Œç›®ï¼šã‚¤ãƒ™ãƒ³ãƒˆå
        const firstLine = document.createElement('div');
        firstLine.style.fontWeight = 'bold';
        firstLine.style.fontSize = '0.9rem';
        firstLine.style.lineHeight = '1.2';
        firstLine.style.whiteSpace = 'nowrap';
        firstLine.style.overflow = 'hidden';
        firstLine.style.textOverflow = 'ellipsis';
        firstLine.textContent = eventTitle;
        if (eventTitle.length > 40) {
          firstLine.title = eventTitle;
          firstLine.style.cursor = 'help';
        }
        dateLabelContainer.appendChild(firstLine);
        
        // 2è¡Œç›®ï¼šå ´æ‰€ï¼ˆæœªè¨­å®šã®å ´åˆã¯è¡¨ç¤ºã—ãªã„ï¼‰
        if (event.location) {
          const secondLine = document.createElement('div');
          secondLine.style.fontSize = '0.85rem';
          secondLine.style.color = '#666';
          secondLine.style.lineHeight = '1.2';
          secondLine.textContent = `ğŸ“${event.location}`;
          dateLabelContainer.appendChild(secondLine);
        }
        
        // 3è¡Œç›®ï¼šæ—¥ä»˜ãƒ»æ™‚åˆ»
        const thirdLine = document.createElement('div');
        thirdLine.style.fontSize = '0.8rem';
        thirdLine.style.color = '#666';
        thirdLine.style.lineHeight = '1.2';
        thirdLine.textContent = `${dateStr} ${timeDisplay}`;
        dateLabelContainer.appendChild(thirdLine);
        
        topRow.appendChild(dateLabelContainer);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠãƒœã‚¿ãƒ³
        const statusGroup = document.createElement('div');
        statusGroup.style.display = 'flex';
        statusGroup.style.gap = '6px';
        statusGroup.dataset.eventId = event.id;
        statusGroup.dataset.memberName = memberName;

        const statuses = [
          { value: 'â—‹', label: 'â—‹', class: 'attend' },
          { value: 'â–³', label: 'â–³', class: 'maybe' },
          { value: 'Ã—', label: 'Ã—', class: 'absent' },
          { value: null, label: 'æœªå®š', class: 'none' }
        ];

        // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ + gridDataï¼‰
        const existingData = eventStatusMap[event.id];
        const existingStatus = existingData ? existingData.status : null;
        const gridStatus = getStatus(event.id, memberName);
        // gridStatusã¾ãŸã¯existingStatusã‚’å–å¾—ã—ã€'-'ã®å ´åˆã¯nullã«å¤‰æ›ï¼ˆã€Œæœªå®šã€ã¨ã—ã¦æ‰±ã†ï¼‰
        let currentStatus = gridStatus || existingStatus;
        if (currentStatus === '-') {
          currentStatus = null;
        }
        
        statuses.forEach(status => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'response-btn ' + (status.class === 'none' ? 'cancel' : status.class);
          btn.textContent = status.label;
          btn.dataset.status = status.value === null ? 'none' : status.value;
          
          // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          // currentStatusãŒnullï¼ˆ'-'ã¯æ—¢ã«nullã«å¤‰æ›æ¸ˆã¿ï¼‰ã®å ´åˆã€ã€Œæœªå®šã€ãƒœã‚¿ãƒ³ï¼ˆvalue: nullï¼‰ã‚’activeã«ã™ã‚‹
          if ((status.value === null && currentStatus === null) || status.value === currentStatus) {
            btn.classList.add('active');
          }
          
          btn.onclick = () => {
            // ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’ç¢ºå®Ÿã«å–å¾—ï¼ˆstatusGroupã®datasetã‹ã‚‰ï¼‰
            const targetEventId = statusGroup.dataset.eventId || event.id;
            
            // ä»–ã®ãƒœã‚¿ãƒ³ã®activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            statusGroup.querySelectorAll('.response-btn').forEach(b => b.classList.remove('active'));
            // ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒœã‚¿ãƒ³ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            btn.classList.add('active');
            
            // gridDataã‚’æ›´æ–°ï¼ˆç¢ºå®Ÿã«æ­£ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’ä½¿ç”¨ï¼‰
            if (!gridData[targetEventId]) {
              gridData[targetEventId] = {};
            }
            if (status.value === null) {
              // æœªé¸æŠã®å ´åˆã¯'-'ã¨ã—ã¦ä¿å­˜ï¼ˆã‚µãƒ¼ãƒãƒ¼ã«æœªé¸æŠã¨ã—ã¦ä¿å­˜ã™ã‚‹ãŸã‚ï¼‰
              gridData[targetEventId][memberName] = '-';
            } else {
              gridData[targetEventId][memberName] = status.value;
            }
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤å¯èƒ½ï¼‰
            console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°:', {
              eventId: targetEventId,
              memberName: memberName,
              status: status.value,
              gridData: gridData[targetEventId]
            });
          };
          
          statusGroup.appendChild(btn);
        });

        topRow.appendChild(statusGroup);
        eventRow.appendChild(topRow);

        // ä¸‹éƒ¨ï¼šã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„
        const commentRow = document.createElement('div');
        commentRow.style.display = 'flex';
        commentRow.style.flexDirection = 'column';
        commentRow.style.gap = '4px';

        const commentLabel = document.createElement('label');
        commentLabel.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰';
        commentLabel.style.fontSize = '0.85rem';
        commentLabel.style.color = '#666';
        commentRow.appendChild(commentLabel);

        const commentInput = document.createElement('textarea');
        commentInput.id = `comment-${event.id}-${memberName}`;
        commentInput.className = 'comment-input';
        commentInput.placeholder = 'ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›';
        commentInput.style.width = '100%';
        commentInput.style.padding = '6px 8px';
        commentInput.style.border = '1px solid #ddd';
        commentInput.style.borderRadius = '4px';
        commentInput.style.fontSize = '0.85rem';
        commentInput.style.minHeight = '50px';
        commentInput.style.resize = 'vertical';
        
        // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¨­å®š
        if (existingData && existingData.comment) {
          commentInput.value = existingData.comment;
        }
        
        commentRow.appendChild(commentInput);
        eventRow.appendChild(commentRow);

        container.appendChild(eventRow);
      });
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeMemberEditModal() {
      const modal = document.getElementById('member-edit-modal');
      modal.style.display = 'none';
      selectedMember = null;
      renderGrid(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
    }

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
     */
    function showEventDetailModal(eventId) {
      const modal = document.getElementById('event-detail-modal');
      if (!modal) {
        console.error('ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’ä¿å­˜ï¼ˆæ›´æ–°å¾Œã«å†èª­ã¿è¾¼ã¿ã™ã‚‹ãŸã‚ï¼‰
      modal.dataset.currentEventId = eventId;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      modal.style.display = 'block';

      // ç®¡ç†è€…ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’è¨­å®š
      const adminActions = document.getElementById('event-detail-admin-actions');
      const editBtn = document.getElementById('event-detail-edit-btn');
      const deleteBtn = document.getElementById('event-detail-delete-btn');
      
      if (isAdminUser) {
        if (adminActions) {
          adminActions.style.display = 'flex';
          adminActions.style.gap = '12px';
        }
        // ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
        if (editBtn) {
          editBtn.onclick = () => {
            closeEventDetailModal();
            openEditEventModal(eventId);
          };
        }
        if (deleteBtn) {
          // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
          deleteBtn.onclick = () => {
            // ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—ã—ã¦ã‹ã‚‰å‰Šé™¤ç¢ºèªã‚’è¡¨ç¤º
            google.script.run
              .withSuccessHandler((result) => {
                if (result.success && result.event) {
                  closeEventDetailModal();
                  openDeleteConfirm(eventId, result.event.title || 'ã‚¤ãƒ™ãƒ³ãƒˆ');
                } else {
                  showToast('ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
              })
              .withFailureHandler((error) => {
                showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
              })
              .getEventWithResponses(eventId);
          };
        }
      } else {
        if (adminActions) adminActions.style.display = 'none';
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      const infoDiv = document.getElementById('event-detail-info');
      const breakdownDiv = document.getElementById('event-detail-breakdown');
      const commentsDiv = document.getElementById('event-detail-comments');
      const titleDiv = document.getElementById('event-detail-title');
      
      // åˆæœŸåŒ–
      if (infoDiv) infoDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">èª­ã¿è¾¼ã¿ä¸­...</div>';
      if (breakdownDiv) breakdownDiv.innerHTML = '';
      if (commentsDiv) commentsDiv.innerHTML = '';
      if (titleDiv) titleDiv.textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°';

      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆAPIå‘¼ã³å‡ºã—ãªã—ï¼ï¼‰
      const event = currentEvents.find(e => e.id === eventId);
      const responses = (window.allResponsesCache && window.allResponsesCache[eventId]) || [];
      
      console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã‚’è¡¨ç¤º:', {
        eventId: eventId,
        eventTitle: event?.title,
        å‡ºæ¬ æ•°: responses.length
      });
      
      if (!event) {
        if (infoDiv) infoDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        return;
      }
      
      // é›†è¨ˆå‡¦ç†ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§å®Ÿè¡Œï¼‰
      const tally = {
        attendCount: responses.filter(r => r.status === 'â—‹').length,
        maybeCount: responses.filter(r => r.status === 'â–³').length,
        absentCount: responses.filter(r => r.status === 'Ã—').length,
        undecidedCount: responses.filter(r => r.status === '-').length
      };
      
      // ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
      if (titleDiv) {
        titleDiv.textContent = event.title || 'ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°';
      }
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®memberListã‚’ä½¿ç”¨

      // ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
      if (infoDiv) {
        // UTCã‚’JSTã«å¤‰æ›
        const startDate = utcToJST(event.start);
        const endDate = utcToJST(event.end);
        
        // çµ‚æ—¥ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆevent.isAllDayãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ï¼‰
        const isAllDay = event.isAllDay === true || event.isAllDay === 'TRUE' || event.isAllDay === 1 || event.isAllDay === '1';
        
        // é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ãŒç•°ãªã‚‹æ—¥ä»˜ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆUTCæ–‡å­—åˆ—ã‹ã‚‰ç›´æ¥æ—¥ä»˜éƒ¨åˆ†ã‚’æŠ½å‡ºï¼‰
        // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã€endãŒç¿Œæ—¥ã®00:00:00ã§ã‚‚1æ—¥ã®çµ‚æ—¥ã¨ã—ã¦æ‰±ã†
        let startDateOnlyStr = getDateFromUTC(event.start);
        let endDateOnlyStr = getDateFromUTC(event.end);
        
        if (isAllDay) {
          // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã€endãŒç¿Œæ—¥ã®00:00:00ã®å ´åˆã¯å‰æ—¥ã®æ—¥ä»˜ã¨ã—ã¦æ‰±ã†
          const endDateUTC = new Date(event.end);
          const endDateOnly = new Date(endDateUTC.getUTCFullYear(), endDateUTC.getUTCMonth(), endDateUTC.getUTCDate());
          const startDateOnly = new Date(new Date(event.start).getUTCFullYear(), new Date(event.start).getUTCMonth(), new Date(event.start).getUTCDate());
          // endãŒstartã®ç¿Œæ—¥ã§ã€æ™‚åˆ»ãŒ00:00:00ã®å ´åˆã¯1æ—¥ã®çµ‚æ—¥ã¨ã—ã¦æ‰±ã†
          if (endDateOnly.getTime() - startDateOnly.getTime() === 24 * 60 * 60 * 1000 && 
              endDateUTC.getUTCHours() === 0 && endDateUTC.getUTCMinutes() === 0 && endDateUTC.getUTCSeconds() === 0) {
            endDateOnlyStr = startDateOnlyStr; // åŒã˜æ—¥ã¨ã—ã¦æ‰±ã†
          }
        }
        
        const isMultiDay = startDateOnlyStr !== endDateOnlyStr;
        
        let dateStr;
        if (isMultiDay) {
          // è¤‡æ•°æ—¥ã®å ´åˆã¯é–‹å§‹æ—¥ï½çµ‚äº†æ—¥ã‚’è¡¨ç¤º
          const startDateDisplayStr = `${startDate.getFullYear()}å¹´${startDate.getMonth() + 1}æœˆ${startDate.getDate()}æ—¥(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][startDate.getDay()]})`;
          const endDateDisplayStr = `${endDate.getFullYear()}å¹´${endDate.getMonth() + 1}æœˆ${endDate.getDate()}æ—¥(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][endDate.getDay()]})`;
          dateStr = `${startDateDisplayStr}ï½${endDateDisplayStr}`;
        } else {
          // å˜æ—¥ã®å ´åˆã¯é–‹å§‹æ—¥ã®ã¿
          dateStr = `${startDate.getFullYear()}å¹´${startDate.getMonth() + 1}æœˆ${startDate.getDate()}æ—¥(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][startDate.getDay()]})`;
        }
        
        let timeDisplay;
        if (isAllDay) {
          timeDisplay = 'çµ‚æ—¥';
        } else {
          // æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆJSTã§è¡¨ç¤ºï¼‰
          const startTimeStr = `${String(startDate.getHours()).padStart(2, '0')}:${String(startDate.getMinutes()).padStart(2, '0')}`;
          const endTimeStr = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
          timeDisplay = `${startTimeStr}ï½${endTimeStr}`;
        }

        infoDiv.innerHTML = `
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.2rem;">${event.title || 'äºˆå®š'}</h3>
            <div style="color: #666; font-size: 0.9rem; line-height: 1.8;">
              <div><strong>æ—¥ä»˜:</strong> ${dateStr}</div>
              <div><strong>æ™‚åˆ»:</strong> ${timeDisplay}</div>
              ${event.location ? `<div><strong>å ´æ‰€:</strong> ${event.location}</div>` : ''}
              ${event.description ? `<div style="margin-top: 10px;"><strong>èª¬æ˜:</strong><br>${cleanDescription(event.description).replace(/\n/g, '<br>')}</div>` : ''}
            </div>
          </div>
        `;
      }

      // å…¨ä½“ã®é›†è¨ˆï¼ˆæœªé¸æŠã‚‚å«ã‚€ï¼‰
      const totalCounts = { 'â—‹': 0, 'â–³': 0, 'Ã—': 0, '-': 0 };
      
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã”ã¨ã®ãƒ‘ãƒ¼ãƒˆå†…è¨³ã‚’é›†è¨ˆï¼ˆæœªé¸æŠã‚‚å«ã‚€ï¼‰
      const statusBreakdown = { 'â—‹': {}, 'â–³': {}, 'Ã—': {}, '-': {} }; // {status: {part: [names]}}
      
      responses.forEach(response => {
        if (response.status === 'â—‹' || response.status === 'â–³' || response.status === 'Ã—' || response.status === '-') {
          totalCounts[response.status]++;
          
          // userKeyã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—
          let part = '';
          let name = '';
          
          const member = memberList.find(m => m.userKey === response.userKey);
          
          if (member && typeof member === 'object') {
            part = member.part || '';
            name = member.name || '';
          } else {
            // ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€userKeyã‹ã‚‰æ¨æ¸¬ã‚’è©¦ã¿ã‚‹
            // userKeyãŒanon-ã§å§‹ã¾ã‚‹å ´åˆã¯åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼
            if (response.userKey && response.userKey.startsWith('anon-')) {
              const userName = response.userKey.replace('anon-', '');
              const parsed = parseMemberName(userName);
              part = parsed.part || '';
              name = parsed.name || userName;
            } else {
              // userKeyã‹ã‚‰æ¨æ¸¬ã§ããªã„å ´åˆ
              part = '';
              name = 'ä¸æ˜';
            }
          }

          // ãƒ‘ãƒ¼ãƒˆãŒç©ºã®å ´åˆã¯ã€Œãã®ä»–ã€ã¨ã—ã¦æ‰±ã†
          const partKey = part || 'ãã®ä»–';
          if (!statusBreakdown[response.status][partKey]) {
            statusBreakdown[response.status][partKey] = [];
          }
          
          statusBreakdown[response.status][partKey].push(name);
        }
      });

      // ãƒ‘ãƒ¼ãƒˆã”ã¨ã®å†…è¨³ã‚’è¡¨ç¤º
      if (breakdownDiv) {
        const partOrder = ['Fl', 'Ob', 'Cl', 'Sax', 'Hr', 'Tp', 'Tb', 'Bass', 'Perc', 'ãã®ä»–'];
        
        function sortParts(parts) {
          return parts.sort((a, b) => {
            const indexA = partOrder.indexOf(a);
            const indexB = partOrder.indexOf(b);
            if (indexA !== -1 && indexB !== -1) return indexA - indexB;
            if (indexA === -1 && indexB !== -1) return 1;
            if (indexA !== -1 && indexB === -1) return -1;
            return a.localeCompare(b, 'ja');
          });
        }

        if (responses.length === 0) {
          breakdownDiv.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">å‡ºæ¬ å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        } else {
          let html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">';
          
          // å…¨ä½“ã®é›†è¨ˆã‚’è¡¨ç¤ºï¼ˆæœªé¸æŠã‚‚å«ã‚€ï¼‰
          html += '<h3 style="margin: 0 0 15px 0; font-size: 1.1rem;">å…¨ä½“ã®é›†è¨ˆ</h3>';
          html += '<div style="margin-bottom: 20px; padding: 12px; background: white; border-radius: 6px; display: flex; gap: 20px; justify-content: center;">';
          html += `<div style="text-align: center;"><span style="color: #4caf50; font-weight: bold; font-size: 1.2rem;">â—‹</span><br><span style="font-size: 0.9rem; color: #666;">${totalCounts['â—‹']}äºº</span></div>`;
          html += `<div style="text-align: center;"><span style="color: #ff9800; font-weight: bold; font-size: 1.2rem;">â–³</span><br><span style="font-size: 0.9rem; color: #666;">${totalCounts['â–³']}äºº</span></div>`;
          html += `<div style="text-align: center;"><span style="color: #f44336; font-weight: bold; font-size: 1.2rem;">Ã—</span><br><span style="font-size: 0.9rem; color: #666;">${totalCounts['Ã—']}äºº</span></div>`;
          html += `<div style="text-align: center;"><span style="color: #999; font-weight: bold; font-size: 1.2rem;">-</span><br><span style="font-size: 0.9rem; color: #666;">${totalCounts['-']}äºº</span></div>`;
          html += '</div>';
          
          // å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã”ã¨ã®å†…è¨³ã‚’è¡¨ç¤ºï¼ˆæœªé¸æŠã‚‚å«ã‚€ï¼‰
          ['â—‹', 'â–³', 'Ã—', '-'].forEach(status => {
            const partData = statusBreakdown[status];
            const sortedParts = sortParts(Object.keys(partData));
            const statusColor = status === 'â—‹' ? '#4caf50' : status === 'â–³' ? '#ff9800' : status === 'Ã—' ? '#f44336' : '#999';
            const statusLabel = status === 'â—‹' ? 'å‡ºå¸­' : status === 'â–³' ? 'é…åˆ»/æ—©é€€' : status === 'Ã—' ? 'æ¬ å¸­' : 'æœªå®š';
            
            if (sortedParts.length === 0) {
              return; // ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å›ç­”ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            }
            
            html += `<div style="margin-bottom: 20px;">`;
            html += `<h4 style="margin: 0 0 10px 0; font-size: 1rem; color: ${statusColor}; font-weight: bold;">${status} (${statusLabel}) ã®å†…è¨³</h4>`;
            
            sortedParts.forEach(part => {
              const names = partData[part];
              if (names.length === 0) return;
              
              html += `<div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px; border-left: 4px solid ${statusColor};">`;
              html += `<div style="font-weight: bold; margin-bottom: 5px; font-size: 0.95rem;">${part || 'ãã®ä»–'} (${names.length}äºº)</div>`;
              html += `<div style="color: #666; font-size: 0.9rem;">${names.join('ã€')}</div>`;
              html += `</div>`;
            });
            
            html += `</div>`;
          });
          
          html += '</div>';
          breakdownDiv.innerHTML = html;
        }
      }

      // ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
      const comments = responses.filter(r => r.comment && r.comment.trim());
      if (commentsDiv) {
        if (comments.length === 0) {
          commentsDiv.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        } else {
          let html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px;"><h3 style="margin: 0 0 15px 0; font-size: 1.1rem;">ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h3>';
          
          comments.forEach(response => {
            // userKeyã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—
            let part = '';
            let name = '';
            
            const member = memberList.find(m => m.userKey === response.userKey);
            
            if (member && typeof member === 'object') {
              part = member.part || '';
              name = member.name || '';
            } else if (response.userKey && response.userKey.startsWith('anon-')) {
              // åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€userKeyã‹ã‚‰åå‰ã‚’æ¨æ¸¬
              const userName = response.userKey.replace('anon-', '');
              const parsed = parseMemberName(userName);
              part = parsed.part || '';
              name = parsed.name || userName;
            } else {
              // ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
              part = '';
              name = 'ä¸æ˜';
            }

            const statusColor = response.status === 'â—‹' ? '#4caf50' : response.status === 'â–³' ? '#ff9800' : response.status === 'Ã—' ? '#f44336' : '#999';
            html += `<div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid ${statusColor};">`;
            html += `<div style="font-weight: bold; margin-bottom: 5px; font-size: 0.95rem;">`;
            html += `<span style="color: ${statusColor}; margin-right: 5px;">${response.status}</span>`;
            html += `<span>${part ? part + ' ' : ''}${name}</span>`;
            html += `</div>`;
            html += `<div style="color: #333; font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap;">${response.comment.replace(/\n/g, '<br>')}</div>`;
            html += `</div>`;
          });
          
          html += '</div>';
          commentsDiv.innerHTML = html;
        }
      }

      // å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°ï¼ˆæ—¢ã«3553è¡Œç›®ã§å®£è¨€æ¸ˆã¿ï¼‰
      if (deleteBtn) {
        deleteBtn.style.display = isAdminUser ? 'inline-block' : 'none';
      }
    }

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeEventDetailModal() {
      const modal = document.getElementById('event-detail-modal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    /**
     * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼åã‚’æ›´æ–°
     */
    function updateMemberFromModal() {
      if (!selectedMember) {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }

      const oldDisplayName = selectedMember; // å¤‰æ›´å‰ã®è¡¨ç¤ºåã‚’ä¿å­˜
      const newPart = document.getElementById('edit-member-part').value.trim();
      const newName = document.getElementById('edit-member-name').value.trim();
      
      if (!newPart) {
        showToast('ãƒ‘ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      if (!newName) {
        showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const newDisplayName = newPart + newName;
      const nameChanged = newDisplayName !== oldDisplayName;

      // åå‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆ
      if (nameChanged) {
        // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‘ãƒ¼ãƒˆ+åå‰ã®çµ„ã¿åˆã‚ã›ã§ä¸€æ„æ€§ã‚’ç¢ºèªã€è‡ªåˆ†è‡ªèº«ã‚’é™¤ãï¼‰
        const oldMember = memberList.find(m => getMemberDisplayName(m) === oldDisplayName);
        const isDuplicate = memberList.some(m => {
          const mPart = typeof m === 'object' ? (m.part || '') : '';
          const mName = typeof m === 'object' ? (m.name || '') : '';
          // è‡ªåˆ†è‡ªèº«ï¼ˆuserKeyãŒåŒã˜ï¼‰ã¯é™¤å¤–
          if (oldMember && typeof m === 'object' && m.userKey === oldMember.userKey) {
            return false;
          }
          return mPart === newPart && mName === newName;
        });
        
        if (isDuplicate) {
          showToast('åŒã˜ãƒ‘ãƒ¼ãƒˆã¨åå‰ã®çµ„ã¿åˆã‚ã›ãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™', 'error');
          return;
        }

        // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        const index = memberList.findIndex(m => getMemberDisplayName(m) === oldDisplayName);
        if (index !== -1) {
          // æ—¢å­˜ã®userKeyã‚’ä¿æŒï¼ˆãƒ¡ãƒ³ãƒãƒ¼åãŒå¤‰æ›´ã•ã‚Œã¦ã‚‚userKeyã¯å¤‰ã‚ã‚‰ãªã„ï¼‰
          const existingUserKey = memberList[index].userKey;
          if (!existingUserKey) {
            console.error(`userKeyãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${oldDisplayName}`);
            showToast('ã‚¨ãƒ©ãƒ¼: userKeyãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            return;
          }
          
          memberList[index] = {
            part: newPart,
            name: newName,
            displayName: newDisplayName,
            userKey: existingUserKey // userKeyã¯å¤‰æ›´ã—ãªã„
          };
          // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç®¡ç†ã™ã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¯ä¿å­˜ã—ãªã„
          
          // ã‚µãƒ¼ãƒãƒ¼ã«ã‚‚æ›´æ–°
          google.script.run
            .withSuccessHandler((result) => {
              if (!result.success) {
                console.error('ãƒ¡ãƒ³ãƒãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', result.error);
              }
            })
            .withFailureHandler((error) => {
              console.error('ãƒ¡ãƒ³ãƒãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            })
            .updateMember(existingUserKey, newPart, newName, newDisplayName);
          
          // gridDataã‚‚æ›´æ–°
          Object.keys(gridData).forEach(eventId => {
            if (gridData[eventId][oldDisplayName] !== undefined) {
              gridData[eventId][newDisplayName] = gridData[eventId][oldDisplayName];
              delete gridData[eventId][oldDisplayName];
            }
          });
          
          selectedMember = newDisplayName;
        }
      }

      // å„æ—¥ç¨‹ã®å‡ºæ¬ ã‚’ä¸€æ‹¬æ›´æ–°ï¼ˆå„ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å«ã‚€ï¼‰
      
      // åå‰ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã¯ã€å…ˆã«ã‚°ãƒªãƒƒãƒ‰ã‚’å†æç”»ã—ã¦åå‰å¤‰æ›´ã‚’åæ˜ 
      if (nameChanged) {
        renderGrid(); // åå‰å¤‰æ›´ã‚’åæ˜ 
      }
      
      // æ›´æ–°ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼åã‚’æŒ‡å®šï¼ˆåå‰ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã¯æ–°ã—ã„åå‰ï¼‰
      bulkUpdateResponsesForSelectedMember(nameChanged ? newDisplayName : null);
      
      closeMemberEditModal();
      
      if (nameChanged) {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼åã¨å‡ºæ¬ ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
      }
    }

    /**
     * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤
     */
    function deleteMemberFromModal() {
      if (!selectedMember) {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }

      if (!confirm(`${selectedMember}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—
      const member = memberList.find(m => getMemberDisplayName(m) === selectedMember);
      if (!member || !member.userKey) {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      const userKey = member.userKey;
      
      // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç®¡ç†ã™ã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¯ä¿å­˜ã—ãªã„ï¼‰
      const index = memberList.findIndex(m => getMemberDisplayName(m) === selectedMember);
      if (index !== -1) {
        memberList.splice(index, 1);
        
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚‚å‰Šé™¤
        google.script.run
          .withSuccessHandler((result) => {
            if (result.success) {
              // gridDataã‹ã‚‰ã‚‚å‰Šé™¤
              Object.keys(gridData).forEach(eventId => {
                delete gridData[eventId][selectedMember];
              });
              
              closeMemberEditModal();
              renderGrid(); // ã‚°ãƒªãƒƒãƒ‰ã‚’å†æç”»
              showToast('ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            } else {
              showToast(result.error || 'ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«æˆ»ã™
              memberList.push(member);
            }
          })
          .withFailureHandler((error) => {
            console.error('ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            showToast('ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«æˆ»ã™
            memberList.push(member);
          })
          .deleteMemberAPI(userKey);
      }
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     */
    function openMemberInfoEditModal() {
      if (!selectedMember) {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }

      const modal = document.getElementById('member-info-edit-modal');
      if (!modal) {
        console.error('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—
      const member = memberList.find(m => getMemberDisplayName(m) === selectedMember);
      let currentPart = '';
      let currentName = '';
      
      if (member && typeof member === 'object') {
        currentPart = member.part || '';
        currentName = member.name || '';
      } else if (selectedMember) {
        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®äº’æ›æ€§ï¼šæ–‡å­—åˆ—å½¢å¼ã®å ´åˆã€ãƒ‘ãƒ¼ãƒˆã¨åå‰ã‚’åˆ†é›¢
        const parsed = parseMemberName(selectedMember);
        currentPart = parsed.part || '';
        currentName = parsed.name || '';
      } else {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      // ãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®å€¤ã‚’è¨­å®š
      const partSelect = document.getElementById('member-info-part');
      const nameInput = document.getElementById('member-info-name');
      if (partSelect) partSelect.value = currentPart;
      if (nameInput) nameInput.value = currentName;

      modal.style.display = 'block';
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeMemberInfoEditModal() {
      const modal = document.getElementById('member-info-edit-modal');
      if (modal) modal.style.display = 'none';
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’ä¿å­˜
     */
    function saveMemberInfo() {
      if (!selectedMember) {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }

      const oldDisplayName = selectedMember; // å¤‰æ›´å‰ã®è¡¨ç¤ºåã‚’ä¿å­˜
      const newPart = document.getElementById('member-info-part').value.trim();
      const newName = document.getElementById('member-info-name').value.trim();
      
      if (!newPart) {
        showToast('ãƒ‘ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      if (!newName) {
        showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const newDisplayName = newPart + newName;
      const nameChanged = newDisplayName !== oldDisplayName;

      // ã‚µãƒ¼ãƒãƒ¼ã«æ›´æ–°ã‚’é€ä¿¡ã™ã‚‹å‰ã«ã€ç¾åœ¨ã®ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆæ›´æ–°å‰ã®çŠ¶æ…‹ï¼‰
      let oldMember = memberList.find(m => getMemberDisplayName(m) === oldDisplayName);
      
      // ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ãƒ‘ãƒ¼ãƒˆã¨åå‰ã‹ã‚‰å†æ§‹ç¯‰ã‚’è©¦ã¿ã‚‹
      if (!oldMember) {
        const parsed = parseMemberName(oldDisplayName);
        // memberListã‹ã‚‰å†æ¤œç´¢
        oldMember = memberList.find(m => {
          const mPart = typeof m === 'object' ? (m.part || '') : '';
          const mName = typeof m === 'object' ? (m.name || '') : '';
          return mPart === parsed.part && mName === parsed.name;
        });
      }
      
      if (!oldMember || !oldMember.userKey) {
        console.error('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', {
          oldDisplayName: oldDisplayName,
          memberList: memberList,
          foundMember: oldMember,
          selectedMember: selectedMember
        });
        showToast('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }

      // oldMemberã®userKeyã‚’ä¿å­˜ï¼ˆå¾Œã§ä½¿ç”¨ã™ã‚‹ãŸã‚ï¼‰
      const existingUserKey = oldMember.userKey;
      
      // oldMemberã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ï¼ˆmemberListã‚’æ›´æ–°ã™ã‚‹ãŸã‚ï¼‰
      const oldMemberIndex = memberList.findIndex(m => {
        if (typeof m === 'object' && m.userKey) {
          return m.userKey === existingUserKey;
        }
        return false;
      });

      // åå‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆ
      if (nameChanged) {
        // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‘ãƒ¼ãƒˆ+åå‰ã®çµ„ã¿åˆã‚ã›ã§ä¸€æ„æ€§ã‚’ç¢ºèªã€è‡ªåˆ†è‡ªèº«ã‚’é™¤ãï¼‰
        const isDuplicate = memberList.some(m => {
          const mPart = typeof m === 'object' ? (m.part || '') : '';
          const mName = typeof m === 'object' ? (m.name || '') : '';
          // è‡ªåˆ†è‡ªèº«ï¼ˆuserKeyãŒåŒã˜ï¼‰ã¯é™¤å¤–
          if (typeof m === 'object' && m.userKey === existingUserKey) {
            return false;
          }
          return mPart === newPart && mName === newName;
        });
        
        if (isDuplicate) {
          showToast('åŒã˜ãƒ‘ãƒ¼ãƒˆã¨åå‰ã®çµ„ã¿åˆã‚ã›ãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™', 'error');
          return;
        }

        // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆuserKeyã§æ¤œç´¢ã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ï¼‰
        if (oldMemberIndex !== -1) {
          memberList[oldMemberIndex] = {
            part: newPart,
            name: newName,
            displayName: newDisplayName,
            userKey: existingUserKey // userKeyã¯å¤‰æ›´ã—ãªã„
          };
          
          // gridDataã‚‚æ›´æ–°
          Object.keys(gridData).forEach(eventId => {
            if (gridData[eventId][oldDisplayName] !== undefined) {
              gridData[eventId][newDisplayName] = gridData[eventId][oldDisplayName];
              delete gridData[eventId][oldDisplayName];
            }
          });
          
          selectedMember = newDisplayName;
        }
      } else {
        // åå‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„å ´åˆã§ã‚‚ã€ãƒ‘ãƒ¼ãƒˆãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
        if (oldMemberIndex !== -1) {
          memberList[oldMemberIndex] = {
            part: newPart,
            name: newName,
            displayName: newDisplayName,
            userKey: existingUserKey
          };
        }
      }
      
      google.script.run
        .withSuccessHandler((result) => {
          if (result.success) {
            // æ›´æ–°æˆåŠŸ
            showToast('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            
            // ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºã‚’æ›´æ–°
            const partDisplay = document.getElementById('member-part-display');
            const nameDisplay = document.getElementById('member-name-display');
            if (partDisplay) {
              const partLabels = {
                'Fl': 'Fl (ãƒ•ãƒ«ãƒ¼ãƒˆ)',
                'Ob': 'Ob (ã‚ªãƒ¼ãƒœã‚¨)',
                'Cl': 'Cl (ã‚¯ãƒ©ãƒªãƒãƒƒãƒˆ)',
                'Sax': 'Sax (ã‚µãƒƒã‚¯ã‚¹)',
                'Hr': 'Hr (ãƒ›ãƒ«ãƒ³)',
                'Tp': 'Tp (ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆ)',
                'Tb': 'Tb (ãƒˆãƒ­ãƒ³ãƒœãƒ¼ãƒ³)',
                'Bass': 'Bass (ãƒã‚¹)',
                'Perc': 'Perc (æ‰“æ¥½å™¨)',
                'ãã®ä»–': 'ãã®ä»–'
              };
              partDisplay.textContent = partLabels[newPart] || newPart || '-';
            }
            if (nameDisplay) {
              nameDisplay.textContent = newName || '-';
            }
            
            // åå‰ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã¯ã€ã‚°ãƒªãƒƒãƒ‰ã‚’å†æç”»
            if (nameChanged) {
              renderGrid();
            }
            
            // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            closeMemberInfoEditModal();
          } else {
            showToast(result.error || 'ãƒ¡ãƒ³ãƒãƒ¼æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«æˆ»ã™ï¼ˆoldMemberIndexã‚’ä½¿ç”¨ï¼‰
            if (oldMemberIndex !== -1) {
              const parsed = parseMemberName(oldDisplayName);
              memberList[oldMemberIndex] = {
                part: parsed.part || '',
                name: parsed.name || '',
                displayName: oldDisplayName,
                userKey: existingUserKey
              };
            }
          }
        })
        .withFailureHandler((error) => {
          console.error('ãƒ¡ãƒ³ãƒãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
          showToast('ãƒ¡ãƒ³ãƒãƒ¼æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«æˆ»ã™ï¼ˆoldMemberIndexã‚’ä½¿ç”¨ï¼‰
          if (oldMemberIndex !== -1) {
            const parsed = parseMemberName(oldDisplayName);
            memberList[oldMemberIndex] = {
              part: parsed.part || '',
              name: parsed.name || '',
              displayName: oldDisplayName,
              userKey: existingUserKey
            };
          }
        })
        .updateMember(
          existingUserKey,
          newPart,
          newName,
          newDisplayName
        );
    }

    /**
     * UUIDã‚’ç”Ÿæˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®crypto APIã‚’ä½¿ç”¨ï¼‰
     */
    function generateUUID() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: crypto.randomUUID()ãŒä½¿ãˆãªã„å ´åˆ
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼åã‹ã‚‰ä¸€æ„ã®userKeyã‚’å–å¾—ï¼ˆUUIDã‚’ä½¿ç”¨ï¼‰
     */
    function getMemberUserKey(memberName) {
      // memberListã‹ã‚‰userKeyã‚’å–å¾—
      const member = memberList.find(m => getMemberDisplayName(m) === memberName);
      if (member && member.userKey) {
        return member.userKey;
      }
      
      // memberListã«ãªã„ã€ã¾ãŸã¯userKeyãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ï¼ˆç™»éŒ²ã•ã‚Œã¦ã„ãªã„ãƒ¡ãƒ³ãƒãƒ¼ï¼‰
      console.error(`ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ã¾ãŸã¯userKeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“: ${memberName}`);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: UUIDã‚’ç”Ÿæˆï¼ˆãŸã ã—ã€ã“ã‚Œã¯æœ¬æ¥ç™ºç”Ÿã™ã¹ãã§ã¯ãªã„ï¼‰
      return generateUUID();
    }

    /**
     * é¸æŠä¸­ã®ãƒ¡ãƒ³ãƒãƒ¼ã®å‡ºæ¬ ã‚’ä¸€æ‹¬æ›´æ–°ï¼ˆå„æ—¥ç¨‹ã”ã¨ã«å€‹åˆ¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
     */
    function bulkUpdateResponsesForSelectedMember(updatedMemberName = null) {
      const memberName = updatedMemberName || selectedMember;
      
      if (!memberName) {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }

      // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’å–å¾—ã—ã¦ç„¡åŠ¹åŒ–
      const saveBtn = document.querySelector('button[onclick="bulkUpdateResponsesForSelectedMember()"]');
      const originalText = saveBtn ? saveBtn.textContent : 'ä¿å­˜';
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'ä¿å­˜ä¸­...';
      }

      // ã“ã®ãƒ¡ãƒ³ãƒãƒ¼å°‚ç”¨ã®userKeyã‚’ç”Ÿæˆ
      const memberUserKey = getMemberUserKey(memberName);

      // é¸æŠä¸­ã®ãƒ¡ãƒ³ãƒãƒ¼ã®å…¨æ—¥ç¨‹ã®å‡ºæ¬ ã‚’æ›´æ–°ï¼ˆgridDataã‹ã‚‰å–å¾—ï¼‰
      const updates = [];
      
      currentEvents.forEach(event => {
        // ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’ç¢ºå®Ÿã«å–å¾—
        const eventId = event.id;
        const status = gridData[eventId] && gridData[eventId][memberName];
        // å„ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ï¼ˆç¢ºå®Ÿã«æ­£ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’ä½¿ç”¨ï¼‰
        const commentInput = document.getElementById(`comment-${eventId}-${memberName}`);
        const comment = commentInput ? commentInput.value.trim() : '';
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤å¯èƒ½ï¼‰
        console.log('æ›´æ–°ãƒã‚§ãƒƒã‚¯:', {
          eventId: eventId,
          memberName: memberName,
          status: status,
          comment: comment,
          commentInputExists: !!commentInput,
          commentInputId: commentInput ? commentInput.id : 'not found'
        });
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯æ›´æ–°å¯¾è±¡ã«å«ã‚ã‚‹
        // æœªé¸æŠï¼ˆ'-'ï¼‰ã‚‚æ›´æ–°å¯¾è±¡ã«å«ã‚ã‚‹
        if (status !== undefined || comment) {
          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæœªè¨­å®šã®å ´åˆã¯"-"ï¼ˆæœªé¸æŠï¼‰ã¨ã—ã¦ä¿å­˜
          updates.push({
            eventId: eventId,
            memberName: memberName,
            memberUserKey: memberUserKey,
            status: status !== undefined ? status : '-',
            comment: comment
          });
        }
      });

      if (updates.length === 0) {
        // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = originalText;
        }
        // åå‰ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã¯ã€ã‚°ãƒªãƒƒãƒ‰ã‚’å†æç”»ã—ã¦çµ‚äº†
        if (updatedMemberName) {
          renderGrid();
        } else {
          // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const container = document.getElementById('event-status-list');
          if (container) {
            const messageDiv = document.createElement('div');
            messageDiv.style.padding = '20px';
            messageDiv.style.textAlign = 'center';
            messageDiv.style.color = '#666';
            messageDiv.style.backgroundColor = '#fff3cd';
            messageDiv.style.border = '1px solid #ffc107';
            messageDiv.style.borderRadius = '6px';
            messageDiv.style.fontWeight = '500';
            messageDiv.style.marginTop = '10px';
            messageDiv.textContent = 'æ›´æ–°ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            container.appendChild(messageDiv);
            
            // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            setTimeout(() => {
              if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
              }
            }, 3000);
          }
          showToast('æ›´æ–°ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
        }
        return;
      }

      // 1å›ã®APIå‘¼ã³å‡ºã—ã§å…¨ä»¶ä¿å­˜
      google.script.run
        .withSuccessHandler((result) => {
          // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
          }
          
          if (result.failed === 0) {
            // æ›´æ–°æˆåŠŸ
            showToast(`${result.success}ä»¶ã®å‡ºæ¬ ã‚’æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
            updates.forEach(update => {
              if (!window.allResponsesCache[update.eventId]) {
                window.allResponsesCache[update.eventId] = [];
              }
              const existingIndex = window.allResponsesCache[update.eventId]
                .findIndex(r => r.userKey === update.memberUserKey);
              
              if (existingIndex >= 0) {
                window.allResponsesCache[update.eventId][existingIndex].status = update.status;
                window.allResponsesCache[update.eventId][existingIndex].comment = update.comment || '';
                window.allResponsesCache[update.eventId][existingIndex].updatedAt = new Date().toISOString();
              } else {
                window.allResponsesCache[update.eventId].push({
                  eventId: update.eventId,
                  userKey: update.memberUserKey,
                  status: update.status,
                  comment: update.comment || '',
                  createdAt: new Date().toISOString(),
                  updatedAt: new Date().toISOString()
                });
              }
            });
            
            // æ›´æ–°å®Œäº†å¾Œã€å¤‰æ›´ã‚’ã‚¯ãƒªã‚¢
            currentEvents.forEach(event => {
              if (gridData[event.id] && gridData[event.id][memberName]) {
                delete gridData[event.id][memberName];
              }
            });
            renderGrid(); // ã‚°ãƒªãƒƒãƒ‰ã‚’å†æç”»
            
            // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯å†èª­ã¿è¾¼ã¿
            const eventDetailModal = document.getElementById('event-detail-modal');
            if (eventDetailModal && eventDetailModal.style.display !== 'none') {
              // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’å–å¾—
              const currentEventId = eventDetailModal.dataset.currentEventId;
              if (currentEventId) {
                // æ›´æ–°ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆIDã®ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å†èª­ã¿è¾¼ã¿
                const updatedEventIds = updates.map(u => u.eventId);
                if (updatedEventIds.includes(currentEventId)) {
                  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†èª­ã¿è¾¼ã¿
                  showEventDetailModal(currentEventId);
                }
              }
            }
            
            // ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            closeMemberEditModal();
          } else {
            showToast(`${result.success}ä»¶æˆåŠŸã€${result.failed}ä»¶å¤±æ•—ã—ã¾ã—ãŸ`, 'warning');
            if (result.errors && result.errors.length > 0) {
              console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', result.errors);
            }
            renderGrid(); // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å†æç”»
          }
        })
        .withFailureHandler((error) => {
          // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
          }
          showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          console.error('ãƒãƒƒãƒä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        })
        .userSubmitResponsesBatch(updates.map(u => ({
          eventId: u.eventId,
          userKey: u.memberUserKey,
          status: u.status,
          comment: u.comment
        })));
    }


    /**
     * ãƒ¡ãƒ³ãƒãƒ¼åã‚’æ›´æ–°
     */
    function updateMemberName() {
      if (!selectedMember) {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const newName = document.getElementById('selected-member-name').value.trim();
      if (!newName) {
        showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      if (newName === selectedMember) {
        showToast('åå‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'info');
        return;
      }

      if (memberList.includes(newName)) {
        showToast('ã“ã®åå‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™', 'error');
        return;
      }

      // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç®¡ç†ã™ã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¯ä¿å­˜ã—ãªã„ï¼‰
      const index = memberList.indexOf(selectedMember);
      if (index !== -1) {
        memberList[index] = newName;
        
        // gridDataã‚‚æ›´æ–°
        Object.keys(gridData).forEach(eventId => {
          if (gridData[eventId][selectedMember] !== undefined) {
            gridData[eventId][newName] = gridData[eventId][selectedMember];
            delete gridData[eventId][selectedMember];
          }
        });
        
        selectedMember = newName;
        renderGrid();
        showToast('ãƒ¡ãƒ³ãƒãƒ¼åã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
      }
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤
     */
    function deleteMember() {
      if (!selectedMember) {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      if (!confirm(`${selectedMember}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—
      const member = memberList.find(m => getMemberDisplayName(m) === selectedMember);
      if (!member || !member.userKey) {
        showToast('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      const userKey = member.userKey;
      
      // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç®¡ç†ã™ã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¯ä¿å­˜ã—ãªã„ï¼‰
      const index = memberList.findIndex(m => getMemberDisplayName(m) === selectedMember);
      if (index !== -1) {
        memberList.splice(index, 1);
        
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚‚å‰Šé™¤
        google.script.run
          .withSuccessHandler((result) => {
            if (result.success) {
              // gridDataã‹ã‚‰ã‚‚å‰Šé™¤
              Object.keys(gridData).forEach(eventId => {
                delete gridData[eventId][selectedMember];
              });
              
              selectedMember = null;
              const editPanel = document.getElementById('member-edit-panel');
              if (editPanel) editPanel.style.display = 'none';
              renderGrid();
              showToast('ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            } else {
              showToast(result.error || 'ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«æˆ»ã™
              memberList.push(member);
            }
          })
          .withFailureHandler((error) => {
            console.error('ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            showToast('ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«æˆ»ã™
            memberList.push(member);
          })
          .deleteMemberAPI(userKey);
      }
    }


    /**
     * ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
     */
    function showMemberRegisterModal() {
      const modal = document.getElementById('member-register-modal');
      modal.style.display = 'block';
      document.getElementById('member-part').value = '';
      document.getElementById('member-name').value = '';
      setTimeout(() => {
        document.getElementById('member-name').focus();
      }, 100);
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeMemberRegisterModal() {
      const modal = document.getElementById('member-register-modal');
      modal.style.display = 'none';
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç™»éŒ²
     */
    function registerMember() {
      const part = document.getElementById('member-part').value.trim();
      const name = document.getElementById('member-name').value.trim();

      if (!part) {
        showToast('ãƒ‘ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      if (!name) {
        showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const displayName = part + name;
      
      // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‘ãƒ¼ãƒˆ+åå‰ã®çµ„ã¿åˆã‚ã›ã§ä¸€æ„æ€§ã‚’ç¢ºèªï¼‰
      const isDuplicate = memberList.some(m => {
        const mPart = typeof m === 'object' ? (m.part || '') : '';
        const mName = typeof m === 'object' ? (m.name || '') : '';
        return mPart === part && mName === name;
      });
      if (isDuplicate) {
        showToast('åŒã˜ãƒ‘ãƒ¼ãƒˆã¨åå‰ã®çµ„ã¿åˆã‚ã›ãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™', 'error');
        return;
      }

      // UUIDã‚’ç”Ÿæˆã—ã¦userKeyã¨ã—ã¦ä½¿ç”¨
      const userKey = generateUUID();
      const newMember = {
        part: part,
        name: name,
        displayName: displayName,
        userKey: userKey
      };
      memberList.push(newMember);
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç®¡ç†ã™ã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¯ä¿å­˜ã—ãªã„
      
      // ã‚µãƒ¼ãƒãƒ¼ã«ã‚‚ä¿å­˜
      google.script.run
        .withSuccessHandler((result) => {
          if (result.success) {
            closeMemberRegisterModal();
            renderGrid();
            showToast('ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç™»éŒ²ã—ã¾ã—ãŸ', 'success');
          } else {
            showToast(result.error || 'ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚‚å‰Šé™¤
            const index = memberList.findIndex(m => m.userKey === userKey);
            if (index !== -1) {
              memberList.splice(index, 1);
            }
          }
        })
        .withFailureHandler((error) => {
          console.error('ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
          showToast('ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚‚å‰Šé™¤
          const index = memberList.findIndex(m => m.userKey === userKey);
          if (index !== -1) {
            memberList.splice(index, 1);
          }
        })
        .createMember(userKey, part, name, displayName);
    }

    /**
     * ä¸€æ‹¬æ›´æ–°ã‚’å®Ÿè¡Œ
     */
    function bulkUpdateResponses() {
      // gridDataã‹ã‚‰å…¨ã¦ã®å¤‰æ›´ã‚’å–å¾—
      const updates = [];
      
      Object.keys(gridData).forEach(eventId => {
        Object.keys(gridData[eventId]).forEach(memberName => {
          const status = gridData[eventId][memberName];
          updates.push({
            eventId: eventId,
            memberName: memberName,
            status: status
          });
        });
      });

      if (updates.length === 0) {
        showToast('æ›´æ–°ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
        return;
      }

      const comment = document.getElementById('grid-comment').value.trim();
      
      // å„æ›´æ–°ã‚’é †æ¬¡å®Ÿè¡Œï¼ˆç°¡æ˜“ç‰ˆï¼šå®Ÿéš›ã«ã¯ä¸€æ‹¬æ›´æ–°APIã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
      let completed = 0;
      let failed = 0;

      updates.forEach(update => {
        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä½¿ç”¨ï¼ˆå®Ÿéš›ã«ã¯ãƒ¡ãƒ³ãƒãƒ¼åã‹ã‚‰userKeyã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
        google.script.run
          .withSuccessHandler((result) => {
            completed++;
            if (completed + failed === updates.length) {
              if (failed === 0) {
                showToast(`${completed}ä»¶ã®å‡ºæ¬ ã‚’æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
                gridData = {}; // æ›´æ–°å®Œäº†å¾Œã€å¤‰æ›´ã‚’ã‚¯ãƒªã‚¢
                renderGrid();
              } else {
                showToast(`${completed}ä»¶æˆåŠŸã€${failed}ä»¶å¤±æ•—ã—ã¾ã—ãŸ`, 'error');
              }
            }
          })
          .withFailureHandler((error) => {
            failed++;
            console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            if (completed + failed === updates.length) {
              showToast(`${completed}ä»¶æˆåŠŸã€${failed}ä»¶å¤±æ•—ã—ã¾ã—ãŸ`, 'error');
            }
          })
          .userSubmitResponse(update.eventId, update.memberUserKey, update.memberName, update.status, comment);
      });
    }

    /**
     * ã‚°ãƒªãƒƒãƒ‰ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
     */
    function cancelGridEdit() {
      gridData = {};
      renderGrid();
    }

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
     */
    function createEventCard(event) {
      const card = document.createElement('div');
      card.className = 'event-card';
      card.id = `event-${event.id}`;

      const startDate = new Date(event.start);
      const endDate = new Date(event.end);

      card.innerHTML = `
        <h3>${escapeHtml(event.title)}</h3>
        <div class="event-meta">
          <div class="date">ğŸ“… ${formatDateTime(startDate)} ï½ ${formatDateTime(endDate)}</div>
          ${event.location ? `<div class="location">ğŸ“${escapeHtml(event.location)}</div>` : ''}
        </div>
        ${event.description ? `<p>${escapeHtml(cleanDescription(event.description))}</p>` : ''}
        <div class="admin-actions" style="display: none;">
          <button class="admin-btn sync" onclick="syncEvent('${event.id}')" id="sync-btn-${event.id}" style="display: none;">
            <span class="sync-icon">ğŸ”„</span> åŒæœŸ
          </button>
          <button class="admin-btn edit" onclick="openEditEventModal('${event.id}')" style="display: none;">ç·¨é›†</button>
          <button class="admin-btn delete" onclick="openDeleteConfirm('${event.id}', '${escapeHtml(event.title)}')" style="display: none;">å‰Šé™¤</button>
        </div>
        ${event.lastSynced ? `<div class="sync-status">æœ€çµ‚åŒæœŸ: ${formatDateTime(new Date(event.lastSynced))}</div>` : ''}
        <div class="tally" id="tally-${event.id}">
          <h4>é›†è¨ˆ</h4>
          <div class="tally-stats">
            <div class="tally-stat attend">
              <div class="label">å‡ºå¸­</div>
              <div class="value" id="tally-attend-${event.id}">-</div>
            </div>
            <div class="tally-stat maybe">
              <div class="label">é…åˆ»/æ—©é€€</div>
              <div class="value" id="tally-maybe-${event.id}">-</div>
            </div>
            <div class="tally-stat absent">
              <div class="label">æ¬ å¸­</div>
              <div class="value" id="tally-absent-${event.id}">-</div>
            </div>
            <div class="tally-stat">
              <div class="label">åˆè¨ˆ</div>
              <div class="value" id="tally-total-${event.id}">-</div>
            </div>
          </div>
        </div>
      `;

      // ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã—ã¦ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      card.style.cursor = 'pointer';
      card.onclick = (e) => {
        // ç®¡ç†è€…ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ãªã„
        if (e.target.closest('.admin-actions')) {
          return;
        }
        showEventDetailModal(event.id);
      };

      // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã¨é›†è¨ˆã‚’èª­ã¿è¾¼ã‚€
      loadEventDetails(event.id);

      return card;
    }

    /**
     * å‡ºæ¬ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠ
     */
    function selectResponse(eventId, status) {
      const card = document.getElementById(`event-${eventId}`);
      const buttons = card.querySelectorAll('.response-btn');
      
      buttons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(status)) {
          btn.classList.add('active');
        }
      });

      // é¸æŠã—ãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’dataå±æ€§ã«ä¿å­˜
      card.dataset.selectedStatus = status;
    }

    /**
     * å‡ºæ¬ å›ç­”ã‚’é€ä¿¡
     */
    function submitResponse(eventId) {
      const card = document.getElementById(`event-${eventId}`);
      const selectedStatus = card.dataset.selectedStatus;
      const comment = document.getElementById(`comment-${eventId}`).value.trim();

      if (!selectedStatus) {
        showToast('å‡ºæ¬ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const submitBtn = card.querySelector('.submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'é€ä¿¡ä¸­...';

      google.script.run
        .withSuccessHandler((result) => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'å‡ºæ¬ ã‚’ç™»éŒ²';
          
          if (result.success) {
            showToast('å‡ºæ¬ ã‚’ç™»éŒ²ã—ã¾ã—ãŸ', 'success');
            // é›†è¨ˆã‚’æ›´æ–°
            loadEventDetails(eventId);
          } else {
            showToast(result.error || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        })
        .withFailureHandler((error) => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'å‡ºæ¬ ã‚’ç™»éŒ²';
          showToast(error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        })
        // ã‚«ãƒ¼ãƒ‰å½¢å¼ã®ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã§ã¯ã€ãƒ¡ãƒ³ãƒãƒ¼é¸æŠæ©Ÿèƒ½ãŒãªã„ãŸã‚ã€ã“ã®é–¢æ•°ã¯ä½¿ç”¨ã—ãªã„
        // ä»£ã‚ã‚Šã«ã€è¡¨å½¢å¼ã§ãƒ¡ãƒ³ãƒãƒ¼åã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰å‡ºæ¬ ã‚’ç™»éŒ²ã™ã‚‹
        showToast('è¡¨å½¢å¼ã§ãƒ¡ãƒ³ãƒãƒ¼åã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‡ºæ¬ ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„', 'info');
    }

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã¨é›†è¨ˆã‚’èª­ã¿è¾¼ã‚€
     */
    function loadEventDetails(eventId) {
      google.script.run
        .withSuccessHandler((data) => {
          if (data.success && data.tally) {
            updateTally(eventId, data.tally);
          }
        })
        .withFailureHandler((error) => {
          console.error('Failed to load event details:', error);
        })
        .getEventWithResponses(eventId);
    }

    /**
     * é›†è¨ˆã‚’æ›´æ–°
     */
    function updateTally(eventId, tally) {
      document.getElementById(`tally-attend-${eventId}`).textContent = tally.attendCount || 0;
      document.getElementById(`tally-maybe-${eventId}`).textContent = tally.maybeCount || 0;
      document.getElementById(`tally-absent-${eventId}`).textContent = tally.absentCount || 0;
      document.getElementById(`tally-total-${eventId}`).textContent = tally.totalCount || 0;
    }

    /**
     * æ—¥æ™‚ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
     */
    function formatDateTime(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}/${month}/${day} ${hours}:${minutes}`;
    }

    /**
     * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
     */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * èª¬æ˜æ¬„ã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’é™¤å»
     * @param description èª¬æ˜æ¬„ã®ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’é™¤å»ã—ãŸèª¬æ˜æ¬„
     */
    function cleanDescription(description) {
      if (!description) {
        return '';
      }
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆID (@google.com ã§çµ‚ã‚ã‚‹æ–‡å­—åˆ—) ã‚’é™¤å»
      let cleaned = description.replace(/[a-z0-9]+@google\.com/gi, '').trim();
      
      // é€£ç¶šã™ã‚‹æ”¹è¡Œã‚„ç©ºç™½ã‚’æ•´ç†
      cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
      cleaned = cleaned.replace(/[ \t]+/g, ' ');
      
      return cleaned.trim();
    }

    /**
     * ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
     */
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    /**
     * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
     */
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('events-container').style.display = 'none';
    }

    /**
     * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
     */
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    /**
     * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
     */
    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    /**
     * ã‚¨ãƒ©ãƒ¼éè¡¨ç¤º
     */
    function hideError() {
      document.getElementById('error').style.display = 'none';
    }

    // ===== ç®¡ç†ç”»é¢æ©Ÿèƒ½ =====

    let editingEventId = null;
    let deletingEventId = null;

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     */
    function openCreateEventModal() {
      editingEventId = null;
      document.getElementById('modal-title').textContent = 'æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ';
      document.getElementById('event-form').reset();
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
      document.getElementById('event-title').value = 'ç·´ç¿’';
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šï¼ˆä»Šæ—¥ã®æ—¥ä»˜ã§13:00-17:00ï¼‰
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const startDate = new Date(today);
      startDate.setHours(13, 0, 0, 0);
      const endDate = new Date(today);
      endDate.setHours(17, 0, 0, 0);
      
      document.getElementById('event-start').value = formatDateTimeLocal(startDate);
      document.getElementById('event-end').value = formatDateTimeLocal(endDate);
      document.getElementById('event-all-day').checked = false;
      toggleAllDay();
      
      // é–‹å§‹æ—¥æ™‚ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      setupStartDateChangeHandler();
      
      document.getElementById('event-modal').style.display = 'block';
    }

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     */
    function openEditEventModal(eventId) {
      const event = currentEvents.find(e => e.id === eventId);
      if (!event) {
        showToast('ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      editingEventId = eventId;
      document.getElementById('modal-title').textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç·¨é›†';
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
      document.getElementById('event-title').value = event.title;
      
      // æ—¥æ™‚ã‚’datetime-localå½¢å¼ã«å¤‰æ›
      const startDate = new Date(event.start);
      const endDate = new Date(event.end);
      
      // çµ‚æ—¥ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆé–‹å§‹ãŒ00:00ã€çµ‚äº†ãŒ23:59ã®å ´åˆï¼‰
      const isAllDay = startDate.getHours() === 0 && 
                       startDate.getMinutes() === 0 && 
                       endDate.getHours() === 23 && 
                       endDate.getMinutes() === 59;
      
      document.getElementById('event-all-day').checked = isAllDay;
      
      // çµ‚æ—¥ã‹ã©ã†ã‹ã«é–¢ã‚ã‚‰ãšã€ä¸¡æ–¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®šï¼ˆtoggleAllDayã§ä¸Šæ›¸ãã•ã‚Œãªã„ã‚ˆã†ã«ï¼‰
      document.getElementById('event-start').value = formatDateTimeLocal(startDate);
      document.getElementById('event-end').value = formatDateTimeLocal(endDate);
      
      if (isAllDay) {
        // çµ‚æ—¥ã®å ´åˆï¼šæ—¥ä»˜ã®ã¿ã‚’è¨­å®š
        document.getElementById('event-start-date').value = formatDate(startDate);
        document.getElementById('event-end-date').value = formatDate(endDate);
      } else {
        // é€šå¸¸ã®å ´åˆï¼šæ—¥æ™‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ—¢ã«è¨­å®šæ¸ˆã¿
        // æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ç©ºã«ã—ã¦ãŠãï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        document.getElementById('event-start-date').value = '';
        document.getElementById('event-end-date').value = '';
      }
      
      document.getElementById('event-location').value = event.location || '';
      document.getElementById('event-description').value = cleanDescription(event.description || '');
      
      // çµ‚æ—¥åˆ‡ã‚Šæ›¿ãˆã‚’å®Ÿè¡Œã—ã¦è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆå€¤ã¯æ—¢ã«è¨­å®šæ¸ˆã¿ï¼‰
      toggleAllDay();
      
      // é–‹å§‹æ—¥æ™‚ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆå€¤è¨­å®šå¾Œã«å®Ÿè¡Œï¼‰
      setupStartDateChangeHandler();
      
      document.getElementById('event-modal').style.display = 'block';
    }

    /**
     * é–‹å§‹æ—¥æ™‚ã®å¤‰æ›´æ™‚ã«çµ‚äº†æ—¥æ™‚ã‚’è‡ªå‹•èª¿æ•´
     */
    function setupStartDateChangeHandler() {
      const startInput = document.getElementById('event-start');
      const endInput = document.getElementById('event-end');
      const startDateInput = document.getElementById('event-start-date');
      const endDateInput = document.getElementById('event-end-date');
      const allDayCheckbox = document.getElementById('event-all-day');
      
      // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
      const newStartInput = startInput.cloneNode(true);
      startInput.parentNode.replaceChild(newStartInput, startInput);
      const newStartDateInput = startDateInput.cloneNode(true);
      startDateInput.parentNode.replaceChild(newStartDateInput, startDateInput);
      
      // ç¾åœ¨ã®å€¤ã‚’åˆæœŸå€¤ã¨ã—ã¦ä¿å­˜
      if (newStartInput.value) {
        newStartInput.setAttribute('data-old-value', newStartInput.value);
      }
      if (newStartDateInput.value) {
        newStartDateInput.setAttribute('data-old-value', newStartDateInput.value);
      }
      
      // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—¥æ™‚å…¥åŠ›ï¼‰ã®å ´åˆ
      newStartInput.addEventListener('change', function() {
        if (allDayCheckbox.checked) return; // çµ‚æ—¥ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å‡¦ç†ã—ãªã„
        
        const oldStartValue = this.getAttribute('data-old-value');
        const oldEndValue = endInput.value;
        
        if (!oldStartValue || !oldEndValue) {
          // åˆå›è¨­å®šæ™‚ã¯å·®åˆ†ã‚’ä¿å­˜
          this.setAttribute('data-old-value', this.value);
          return;
        }
        
        const oldStart = new Date(oldStartValue);
        const oldEnd = new Date(oldEndValue);
        const newStart = new Date(this.value);
        
        // é–‹å§‹æ—¥æ™‚ã¨çµ‚äº†æ—¥æ™‚ã®å·®åˆ†ã‚’è¨ˆç®—ï¼ˆãƒŸãƒªç§’ï¼‰
        const diff = oldEnd.getTime() - oldStart.getTime();
        
        // æ–°ã—ã„çµ‚äº†æ—¥æ™‚ = æ–°ã—ã„é–‹å§‹æ—¥æ™‚ + å·®åˆ†
        const newEnd = new Date(newStart.getTime() + diff);
        
        // çµ‚äº†æ—¥æ™‚ã‚’æ›´æ–°
        endInput.value = formatDateTimeLocal(newEnd);
        
        // æ–°ã—ã„é–‹å§‹æ—¥æ™‚ã‚’ä¿å­˜
        this.setAttribute('data-old-value', this.value);
      });
      
      // çµ‚æ—¥ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—¥ä»˜å…¥åŠ›ï¼‰ã®å ´åˆ
      newStartDateInput.addEventListener('change', function() {
        if (!allDayCheckbox.checked) return; // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å‡¦ç†ã—ãªã„
        
        const oldStartValue = this.getAttribute('data-old-value');
        const oldEndValue = endDateInput.value;
        
        if (!oldStartValue || !oldEndValue) {
          // åˆå›è¨­å®šæ™‚ã¯å·®åˆ†ã‚’ä¿å­˜
          this.setAttribute('data-old-value', this.value);
          return;
        }
        
        const oldStart = new Date(oldStartValue);
        const oldEnd = new Date(oldEndValue);
        const newStart = new Date(this.value);
        
        // é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã®å·®åˆ†ã‚’è¨ˆç®—ï¼ˆæ—¥æ•°ï¼‰
        const diffDays = Math.round((oldEnd.getTime() - oldStart.getTime()) / (1000 * 60 * 60 * 24));
        
        // æ–°ã—ã„çµ‚äº†æ—¥ = æ–°ã—ã„é–‹å§‹æ—¥ + å·®åˆ†æ—¥æ•°
        const newEnd = new Date(newStart);
        newEnd.setDate(newEnd.getDate() + diffDays);
        
        // çµ‚äº†æ—¥ã‚’æ›´æ–°
        endDateInput.value = formatDate(newEnd);
        
        // æ–°ã—ã„é–‹å§‹æ—¥ã‚’ä¿å­˜
        this.setAttribute('data-old-value', this.value);
      });
    }

    /**
     * æ—¥æ™‚ã‚’datetime-localå½¢å¼ã«å¤‰æ›
     */
    function formatDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    /**
     * æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã«å¤‰æ›
     */
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    /**
     * çµ‚æ—¥åˆ‡ã‚Šæ›¿ãˆ
     */
    function toggleAllDay() {
      const allDay = document.getElementById('event-all-day').checked;
      const startDateTime = document.getElementById('event-start');
      const endDateTime = document.getElementById('event-end');
      const startDate = document.getElementById('event-start-date');
      const endDate = document.getElementById('event-end-date');
      
      if (allDay) {
        // çµ‚æ—¥ãƒ¢ãƒ¼ãƒ‰ï¼šæ—¥ä»˜ã®ã¿è¡¨ç¤º
        startDateTime.style.display = 'none';
        endDateTime.style.display = 'none';
        startDate.style.display = 'block';
        endDate.style.display = 'block';
        startDate.required = true;
        endDate.required = true;
        startDateTime.required = false;
        endDateTime.required = false;
        
        // æ—¢ã«æ—¥ä»˜ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä¸Šæ›¸ãã—ãªã„ï¼ˆç·¨é›†æ™‚ï¼‰
        if (startDate.value && endDate.value) {
          // æ—¢å­˜ã®å€¤ã‚’ä½¿ç”¨ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
          return;
        }
        
        // ç¾åœ¨ã®æ—¥æ™‚ã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—ã—ã¦è¨­å®šï¼ˆæ–°è¦ä½œæˆæ™‚ã®ã¿ï¼‰
        const currentStart = startDateTime.value ? new Date(startDateTime.value) : new Date();
        const currentEnd = endDateTime.value ? new Date(endDateTime.value) : new Date();
        startDate.value = formatDate(currentStart);
        endDate.value = formatDate(currentEnd);
      } else {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šæ—¥æ™‚è¡¨ç¤º
        startDateTime.style.display = 'block';
        endDateTime.style.display = 'block';
        startDate.style.display = 'none';
        endDate.style.display = 'none';
        startDateTime.required = true;
        endDateTime.required = true;
        startDate.required = false;
        endDate.required = false;
        
        // æ—¢ã«æ—¥æ™‚ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä¸Šæ›¸ãã—ãªã„ï¼ˆç·¨é›†æ™‚ï¼‰
        if (startDateTime.value && endDateTime.value) {
          // æ—¢å­˜ã®å€¤ã‚’ä½¿ç”¨ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
          return;
        }
        
        // æ—¥ä»˜ã‹ã‚‰æ—¥æ™‚ã«å¤‰æ›ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç·´ç¿’æ™‚é–“ï¼š13:00-17:00ï¼‰
        let targetDate;
        if (startDate.value) {
          targetDate = new Date(startDate.value);
        } else if (startDateTime.value) {
          targetDate = new Date(startDateTime.value);
        } else {
          targetDate = new Date();
        }
        
        // æ—¥ä»˜éƒ¨åˆ†ã®ã¿ã‚’å–å¾—ï¼ˆæ™‚åˆ»ã¯ãƒªã‚»ãƒƒãƒˆï¼‰
        const dateOnly = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
        
        // é–‹å§‹æ™‚åˆ»ã‚’13:00ã«è¨­å®š
        const start = new Date(dateOnly);
        start.setHours(13, 0, 0, 0);
        startDateTime.value = formatDateTimeLocal(start);
        
        // çµ‚äº†æ™‚åˆ»ã‚’17:00ã«è¨­å®š
        const end = new Date(dateOnly);
        end.setHours(17, 0, 0, 0);
        endDateTime.value = formatDateTimeLocal(end);
      }
    }

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeEventModal() {
      document.getElementById('event-modal').style.display = 'none';
      document.getElementById('location-history').style.display = 'none';
      editingEventId = null;
    }

    /**
     * å ´æ‰€å±¥æ­´ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
     */
    function toggleLocationHistory() {
      const historyDiv = document.getElementById('location-history');
      const isVisible = historyDiv.style.display !== 'none';
      
      if (isVisible) {
        historyDiv.style.display = 'none';
      } else {
        loadLocationHistory();
        historyDiv.style.display = 'block';
      }
    }

    /**
     * å ´æ‰€å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
     */
    function loadLocationHistory() {
      const historyList = document.getElementById('location-history-list');
      historyList.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      // å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å ´æ‰€ã‚’å–å¾—ï¼ˆéå»ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚‚å«ã‚€ï¼‰
      google.script.run
        .withSuccessHandler((allEvents) => {
          const locations = [];
          const locationSet = new Set();
          
          // ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å ´æ‰€ã‚’æŠ½å‡º
          allEvents.forEach(event => {
            if (event.location && event.location.trim() && !locationSet.has(event.location.trim())) {
              locationSet.add(event.location.trim());
              locations.push({
                location: event.location.trim(),
                updatedAt: event.updatedAt || event.createdAt
              });
            }
          });
          
          // æ›´æ–°æ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
          locations.sort((a, b) => {
            const dateA = new Date(a.updatedAt);
            const dateB = new Date(b.updatedAt);
            return dateB.getTime() - dateA.getTime();
          });
          
          // æœ€æ–°5ä»¶ã¾ã§è¡¨ç¤º
          const recentLocations = locations.slice(0, 5);
          
          historyList.innerHTML = '';
          
          if (recentLocations.length === 0) {
            historyList.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
          }
          
          recentLocations.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'location-history-item';
            itemDiv.textContent = item.location;
            itemDiv.onclick = () => {
              document.getElementById('event-location').value = item.location;
              toggleLocationHistory();
            };
            historyList.appendChild(itemDiv);
          });
        })
        .withFailureHandler((error) => {
          historyList.innerHTML = '<div style="padding: 15px; text-align: center; color: #f44336;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
          console.error('å ´æ‰€å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getAllEventsForLocationHistory();
    }

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜
     */
    function saveEvent(e) {
      e.preventDefault();

      const title = document.getElementById('event-title').value.trim();
      const allDay = document.getElementById('event-all-day').checked;
      const location = document.getElementById('event-location').value.trim();
      const description = document.getElementById('event-description').value.trim();

      let startISO, endISO;

      if (allDay) {
        // çµ‚æ—¥ã®å ´åˆï¼šæ—¥ä»˜ã®ã¿ã‹ã‚‰æ—¥æ™‚ã‚’ç”Ÿæˆï¼ˆé–‹å§‹ã¯00:00ã€çµ‚äº†ã¯23:59ï¼‰
        const startDate = document.getElementById('event-start-date').value;
        const endDate = document.getElementById('event-end-date').value;
        
        if (!startDate || !endDate) {
          showToast('é–‹å§‹æ—¥ã€çµ‚äº†æ—¥ã¯å¿…é ˆã§ã™', 'error');
          return;
        }

        const start = new Date(startDate);
        start.setHours(0, 0, 0, 0);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);
        
        startISO = start.toISOString();
        endISO = end.toISOString();
      } else {
        // é€šå¸¸ã®å ´åˆï¼šæ—¥æ™‚å…¥åŠ›ã‹ã‚‰å–å¾—
        const start = document.getElementById('event-start').value;
        const end = document.getElementById('event-end').value;
        
        if (!title || !start || !end) {
          showToast('ã‚¿ã‚¤ãƒˆãƒ«ã€é–‹å§‹æ—¥æ™‚ã€çµ‚äº†æ—¥æ™‚ã¯å¿…é ˆã§ã™', 'error');
          return;
        }

        // datetime-localå½¢å¼ã‚’ISO 8601å½¢å¼ã«å¤‰æ›
        startISO = new Date(start).toISOString();
        endISO = new Date(end).toISOString();
      }

      if (!title) {
        showToast('ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™', 'error');
        return;
      }

      const saveBtn = document.getElementById('save-event-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'ä¿å­˜ä¸­...';

      if (editingEventId) {
        // æ›´æ–°
        const updates = {
          title: title,
          start: startISO,
          end: endISO,
          location: location,
          description: description
        };

        google.script.run
          .withSuccessHandler((result) => {
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
            
            if (result.success) {
              showToast('ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
              closeEventModal();
              // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆå‡ºæ¬ ãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚€ï¼‰
              loadInitData().then(() => {
                renderEvents();
              });
            } else {
              showToast(result.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
          })
          .withFailureHandler((error) => {
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
            showToast(error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
          })
          .adminUpdateEvent(editingEventId, updates, currentUserKey, localStorage.getItem('adminToken'));
      } else {
        // ä½œæˆ
        google.script.run
          .withSuccessHandler((result) => {
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
            
            if (result.success) {
              showToast('ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
              closeEventModal();
              // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆå‡ºæ¬ ãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚€ï¼‰
              loadInitData().then(() => {
                renderEvents();
              });
            } else {
              showToast(result.error || 'ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
          })
          .withFailureHandler((error) => {
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
            showToast(error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
          })
          .adminCreateEvent({
            title: title,
            start: startISO,
            end: endISO,
            location: location,
            description: description
          }, currentUserKey, localStorage.getItem('adminToken'));
      }
    }

    /**
     * å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
     */
    function openDeleteConfirm(eventId, eventTitle) {
      deletingEventId = eventId;
      document.getElementById('delete-confirm-message').textContent = 
        `ã€Œ${eventTitle}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
      document.getElementById('delete-confirm').style.display = 'block';
    }

    /**
     * å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
     */
    function closeDeleteConfirm() {
      document.getElementById('delete-confirm').style.display = 'none';
      deletingEventId = null;
    }

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
     */
    function confirmDelete() {
      if (!deletingEventId) {
        return;
      }

      const deleteBtn = document.querySelector('.confirm-btn.danger');
      deleteBtn.disabled = true;
      deleteBtn.textContent = 'å‰Šé™¤ä¸­...';

      google.script.run
        .withSuccessHandler((result) => {
          deleteBtn.disabled = false;
          deleteBtn.textContent = 'å‰Šé™¤';
          
          if (result.success) {
            showToast('ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            closeDeleteConfirm();
            // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆå‡ºæ¬ ãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚€ï¼‰
            loadInitData().then(() => {
              renderEvents();
            });
          } else {
            showToast(result.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        })
        .withFailureHandler((error) => {
          deleteBtn.disabled = false;
          deleteBtn.textContent = 'å‰Šé™¤';
          showToast(error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        })
        .adminDeleteEvent(deletingEventId, currentUserKey, localStorage.getItem('adminToken'));
    }

    /**
     * å€‹åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆåŒæœŸ
     */
    function syncEvent(eventId) {
      const syncBtn = document.getElementById(`sync-btn-${eventId}`);
      if (!syncBtn) {
        return;
      }

      syncBtn.disabled = true;
      showFullscreenLoader('ã‚¤ãƒ™ãƒ³ãƒˆã‚’åŒæœŸä¸­...');

      google.script.run
        .withSuccessHandler((result) => {
          syncBtn.disabled = false;
          hideFullscreenLoader();
          
          if (result.success) {
            showToast('ã‚¤ãƒ™ãƒ³ãƒˆã‚’åŒæœŸã—ã¾ã—ãŸ', 'success');
            // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            loadInitData().then(() => {
              renderEvents();
            });
          } else {
            showToast(result.error || 'åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        })
        .withFailureHandler((error) => {
          syncBtn.disabled = false;
          hideFullscreenLoader();
          showToast(error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        })
        .syncEvent(eventId, currentUserKey, localStorage.getItem('adminToken'));
    }

    /**
     * å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆãŠæƒé™¤ç”¨ï¼‰
     * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã€localStorageã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
     */
    function cleanupAllData() {
      if (!isAdminUser) {
        showToast('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™', 'error');
        return;
      }

      if (!confirm('âš ï¸ è­¦å‘Š: å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nå‰Šé™¤å¯¾è±¡:\n- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å…¨ã‚¤ãƒ™ãƒ³ãƒˆ\n- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆEvents, Responses, AuditLogï¼‰\n- ãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageï¼ˆãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆãªã©ï¼‰\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
      }

      showFullscreenLoader('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ä¸­...');

      google.script.run
        .withSuccessHandler((result) => {
          hideFullscreenLoader();
          
          if (result.success) {
            // localStorageã‚‚ã‚¯ãƒªã‚¢
            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç®¡ç†ã™ã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã¯å‰Šé™¤ã—ãªã„
            
            // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
            memberList = [];
            gridData = {};
            selectedMember = null;
            
            showToast(
              `å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†:\nã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: ${result.calendarDeleted}ä»¶\nEvents: ${result.eventsDeleted}ä»¶\nResponses: ${result.responsesDeleted}ä»¶\nAuditLog: ${result.auditLogDeleted}ä»¶`,
              'success'
            );
            
            // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            loadInitData().then(() => {
              renderEvents();
              renderGrid();
            });
          } else {
            let errorMsg = 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ';
            if (result.errors && result.errors.length > 0) {
              errorMsg += ': ' + result.errors.join(', ');
            }
            showToast(errorMsg, 'error');
          }
        })
        .withFailureHandler((error) => {
          hideFullscreenLoader();
          showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
        })
        .adminCleanupAllData(currentUserKey, localStorage.getItem('adminToken'));
    }

    /**
     * å…¨ã‚¤ãƒ™ãƒ³ãƒˆä¸€æ‹¬åŒæœŸ
     */
    function syncAllEvents() {
      const syncAllBtn = document.getElementById('sync-all-btn');
      if (!syncAllBtn) {
        return;
      }

      syncAllBtn.disabled = true;
      // ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ã®å ´åˆã€ã‚¢ã‚¤ã‚³ãƒ³ã«ã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      const icon = syncAllBtn.querySelector('i');
      if (icon) {
        icon.classList.add('spinning');
      }
      showFullscreenLoader('å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’åŒæœŸä¸­...');

      google.script.run
        .withSuccessHandler((result) => {
          syncAllBtn.disabled = false;
          // ã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
          if (icon) {
            icon.classList.remove('spinning');
          }
          hideFullscreenLoader();
          
          if (result.success > 0 || result.failed === 0) {
            showToast(`åŒæœŸå®Œäº†: æˆåŠŸ ${result.success}ä»¶${result.failed > 0 ? `, å¤±æ•— ${result.failed}ä»¶` : ''}`, 'success');
            // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            loadInitData().then(() => {
              renderEvents();
            });
          } else {
            showToast(`åŒæœŸå¤±æ•—: ${result.errors.join(', ')}`, 'error');
          }
        })
        .withFailureHandler((error) => {
          syncAllBtn.disabled = false;
          // ã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
          if (icon) {
            icon.classList.remove('spinning');
          }
          hideFullscreenLoader();
          showToast(error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        })
        .syncAllEvents(currentUserKey, localStorage.getItem('adminToken'));
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.onclick = function(event) {
      const eventModal = document.getElementById('event-modal');
      const confirmDialog = document.getElementById('delete-confirm');
      const adminLoginModal = document.getElementById('admin-login-modal');
      const memberEditModal = document.getElementById('member-edit-modal');
      
      if (event.target === eventModal) {
        closeEventModal();
      }
      if (event.target === confirmDialog) {
        closeDeleteConfirm();
      }
      if (event.target === adminLoginModal) {
        closeAdminLoginModal();
      }
      if (event.target === memberEditModal) {
        closeMemberEditModal();
      }
      const eventDetailModal = document.getElementById('event-detail-modal');
      if (event.target === eventDetailModal) {
        closeEventDetailModal();
      }
    };

    /**
     * å…¨ç”»é¢ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’è¡¨ç¤º
     */
    function showFullscreenLoader(text = 'å‡¦ç†ä¸­...') {
      const loader = document.getElementById('fullscreen-loader');
      const loaderText = document.getElementById('loader-text');
      if (loader && loaderText) {
        loaderText.textContent = text;
        loader.classList.add('active');
      }
    }

    /**
     * å…¨ç”»é¢ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’éè¡¨ç¤º
     */
    function hideFullscreenLoader() {
      const loader = document.getElementById('fullscreen-loader');
      if (loader) {
        loader.classList.remove('active');
      }
    }
  </script>

  <!-- å…¨ç”»é¢ãƒ­ãƒ¼ãƒ€ãƒ¼ -->
  <div id="fullscreen-loader" class="fullscreen-loader">
    <div class="loader-spinner"></div>
    <div class="loader-text" id="loader-text">å‡¦ç†ä¸­...</div>
  </div>
</body>
</html>
