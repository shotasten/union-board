# 出欠管理Webアプリ 仕様書

**バージョン**: 2.0  
**最終更新**: 2025-11-12  
**対象**: 吹奏楽団向け出欠管理システム

---

## 📋 目次

1. [概要](#概要)
2. [システム構成](#システム構成)
3. [機能仕様](#機能仕様)
4. [データモデル](#データモデル)
5. [認証・セキュリティ](#認証セキュリティ)
6. [カレンダー連携](#カレンダー連携)
7. [UI/UX](#uiux)
8. [技術仕様](#技術仕様)
9. [運用仕様](#運用仕様)
10. [変更履歴](#変更履歴)

---

## 概要

### 目的

吹奏楽団のイベント（練習、演奏会など）の出欠管理を効率化するWebアプリケーション。

### 主要機能

- ✅ イベント管理（管理者：作成・編集・削除）
- ✅ 出欠登録（ユーザー：○/△/× + コメント）
- ✅ 出欠集計表示（リアルタイム）
- ✅ パート別メンバー管理
- ✅ Googleカレンダー連携（双方向同期）
  - 出欠状況を自動反映
  - コメントをカレンダーに同期
  - リアルタイム同期
- ✅ 表示期間管理（年度単位の管理）
- ✅ 定期同期機能（cron対応）
- ✅ 匿名認証（管理者トークン）
- ✅ パフォーマンス最適化（バッチ処理）

### 想定ユーザー

- **管理者**: 団長、幹事（イベント管理権限）
- **一般ユーザー**: 団員（出欠登録のみ）

### 規模対応

- **メンバー数**: 40-50人
- **年度内イベント**: 30-40件
- **最大出欠データ**: 約2,000件/年度

---

## システム構成

### アーキテクチャ

```
┌─────────────────────────────────────┐
│         ユーザー（ブラウザ）         │
│     - Chrome, Safari, Firefox       │
│     - デスクトップ & モバイル        │
└─────────────────────────────────────┘
                 ↓ HTTPS
┌─────────────────────────────────────┐
│   Google Apps Script (GAS)          │
│   - バックエンドロジック（TypeScript）│
│   - HTML Service（フロントエンド）   │
└─────────────────────────────────────┘
         ↓                    ↓
┌──────────────────┐  ┌──────────────────┐
│ Google Spreadsheet│  │ Google Calendar  │
│ - データストレージ │  │ - イベント表示   │
│ - 4シート構成     │  │ - 双方向同期     │
└──────────────────┘  └──────────────────┘
```

### 技術スタック

| レイヤー | 技術 |
|---------|------|
| **開発言語** | TypeScript (clasp) |
| **フロントエンド** | Vanilla JavaScript, CSS |
| **バックエンド** | Google Apps Script |
| **データベース** | Google Spreadsheet（4シート） |
| **認証** | 匿名認証（管理者トークン） |
| **カレンダー** | Google Calendar API |

---

## 機能仕様

### 1. イベント管理機能

#### 1.1 イベント作成

**権限**: 管理者のみ

**入力項目**:
- タイトル（必須、最大100文字）
- 開始日時（必須）
- 終了日時（必須）
- 終日フラグ（オプション）
- 場所（任意、最大200文字）
- 説明（任意、最大1000文字）

**動作**:
1. 入力バリデーション
2. Eventsシートに保存
3. UUID生成（イベントID）
4. Googleカレンダーに自動作成（`upsertCalendarEvent()`）
5. 成功メッセージ表示

**カレンダー同期**:
- 作成と同時にカレンダーイベント作成
- `calendarEventId` をEventsシートに保存

#### 1.2 イベント編集

**権限**: 管理者のみ

**機能**:
- 既存イベント情報の変更
- 終日⇔時間指定の切り替え対応
- カレンダーイベントも自動更新

**カレンダー同期**:
- 編集と同時にカレンダーイベント更新
- 終日⇔時間指定の変更時は、カレンダーイベントを削除して再作成

#### 1.3 イベント削除

**権限**: 管理者のみ

**方式**: 論理削除（status = 'deleted'）

**動作**:
1. 削除確認ダイアログ
2. statusを'deleted'に変更
3. カレンダーイベントを削除（`deleteEvent()`）
4. 既存の出欠データは保持（監査目的）

### 2. 出欠登録機能

#### 2.1 出欠入力

**権限**: 全ユーザー

**入力項目**:
- 出欠ステータス: ○（参加）/ △（未定）/ ×（欠席）
- コメント（任意、最大500文字）
- 表示名（初回のみ、以降は保持）

**表示名の形式**:
- 推奨: 「パート名 + 名前」（例: Fl田中、Tp佐藤）
- パート一覧: Fl, Ob, Cl, Sax, Hr, Tp, Tb, Bass, Perc, その他

**動作**:
1. ユーザー認証チェック（匿名モード）
2. レート制限チェック（1分に5回まで）
3. Responsesシートに保存/更新（`submitResponse()`）
4. Membersシートに自動登録（`upsertMember()`）
5. 集計を再計算して即座に反映
6. カレンダー説明欄を更新（`syncCalendarDescriptionForEvent()`）

**カレンダー同期**:
- 出欠登録・コメント更新時に即座に同期
- 該当イベントのみ同期（高速）

#### 2.2 出欠変更

**権限**: 本人のみ（自分の出欠のみ変更可）

**動作**:
- 既存のレコードを上書き（updatedAt更新）
- カレンダー説明欄も自動更新

#### 2.3 一括登録

**機能**: 複数のイベントをまとめて登録

**処理方式**:
- バッチ処理により高速化
- 1回のシート読み取り + インデックス構築 + バッチ更新
- N回のAPI呼び出し → 1回に削減（約93%削減）

**動作**:
1. `userSubmitResponsesBatch()` を呼び出し
2. Responsesシートを1回読み取り
3. 既存データのインデックス構築
4. 更新・追加をまとめて実行
5. 各イベントのカレンダー説明欄を更新

### 3. 集計表示機能

#### 3.1 イベント一覧

**表示内容**:
- イベントタイトル
- 日時、場所
- 出欠サマリー（○: 30人、△: 5人、×: 2人）
- 自分の出欠状態（ハイライト表示）

**フィルタ**:
- 表示期間（DISPLAY_START_DATE ～ DISPLAY_END_DATE）
- 過去・未来問わず、表示期間内の全イベントを表示

**ソート**:
- デフォルト: 開始日時の昇順

#### 3.2 イベント詳細

**表示内容**:
1. **イベント情報**: 日時、場所、説明
2. **コメント一覧**: 各メンバーのコメント（パート表示）
3. **パート別内訳**: パートごとの出欠状況

**プライバシー配慮**:
- 表示名のみ表示（メールアドレス・本名なし）
- 管理者でも個人情報は見えない

### 4. メンバー管理機能

#### 4.1 メンバー登録

**自動登録**:
- 初回出欠登録時に自動でMembersシートに登録
- 表示名から「パート」と「名前」を自動判別

**パート一覧**:
```
Fl, Ob, Cl, Sax, Hr, Tp, Tb, Bass (Eu/Tuba), Perc, その他
```

**パース処理**:
- `parseMemberNameFromString()` 関数で自動判別
- 例: "Fl田中" → part: "Fl", name: "田中"

#### 4.2 メンバー情報の管理

**更新**:
- `upsertMember()` 関数でCREATE or UPDATE
- userKey で既存メンバーを識別

**表示名の変更**:
- Membersシートで直接編集
- 次回の出欠登録時に反映

### 5. 表示期間管理機能

#### 5.1 表示期間の設定

**設定項目**:
- `DISPLAY_START_DATE`: 表示開始日（ISO 8601形式）
- `DISPLAY_END_DATE`: 表示終了日（ISO 8601形式）

**例**:
```
DISPLAY_START_DATE: 2025-04-01
DISPLAY_END_DATE: 2026-03-31
```

**設定方法**:
1. Configシートで直接編集
2. 管理者画面から設定（未実装）

#### 5.2 表示期間の効果

**アプリ画面**:
- 表示期間内のイベントのみ表示（`getEvents('all')`）
- 過去・未来問わず、期間内であれば全て表示

**カレンダー同期**:
- イベント同期ボタン: 表示期間のみ同期（`syncAll(true)`）
- 定期同期（cron）: 表示期間のみ同期（`scheduledSync()`）
- 個別のイベント操作: 表示期間に関わらず同期

**パフォーマンス**:
- 表示期間外のイベントを除外することで処理時間短縮
- カレンダーAPI呼び出し回数を削減

### 6. 管理者機能

#### 6.1 管理画面アクセス

**匿名モード**:
- 管理者トークン付きURL（例: `?admin=abc123`）でアクセス
- トークンが一致すれば管理機能が表示
- トークンはlocalStorageに保存

**管理者トークン**:
- Configシートの `ADMIN_TOKEN` に保存
- 32文字のランダム文字列
- `testConfig()` 関数で確認可能

#### 6.2 カレンダー同期

**機能**:
- イベント同期ボタン（ヘッダーの 🔄）
- 表示期間内のイベントを一括同期
- カレンダー → アプリ、アプリ → カレンダー の双方向

**同期方向**:
- アプリ → カレンダー: イベント作成・更新・出欠登録時に自動
- カレンダー → アプリ: 手動実行 or トリガー（15分ごと推奨）

#### 6.3 全データ削除

**権限**: 管理者のみ

**機能**:
- 全イベント、出欠データ、メンバーデータを削除
- カレンダーイベントも削除

**注意**:
- 復元不可
- 実行前に必ずバックアップを取る

---

## データモデル

### スプレッドシート構成

全4シート構成：

1. **Events** - イベント情報
2. **Members** - メンバー情報（パート別）
3. **Responses** - 出欠情報
4. **Config** - 設定情報

**削除されたシート**:
- Sessions（ログイン機能が不要なため）
- AuditLog（監査ログ機能が不要なため）
- UserPreferences（個人設定が不要なため）

### 1. Events シート

| カラム | 型 | 説明 | 例 |
|--------|----|----|-----|
| id | string | イベントID（UUID） | `08801d82-ebf1...` |
| title | string | タイトル | `練習` |
| start | ISO 8601 | 開始日時 | `2025-12-10T14:00:00+09:00` |
| end | ISO 8601 | 終了日時 | `2025-12-10T17:00:00+09:00` |
| isAllDay | boolean | 終日フラグ | `TRUE` / `FALSE` |
| location | string | 場所 | `市民ホール` |
| description | string | 説明 | `今年最後の練習です` |
| calendarEventId | string | カレンダーイベントID | `8gfpgvlk...` |
| notesHash | string | 説明欄ハッシュ | `hash-xyz...` |
| status | string | ステータス | `active` / `deleted` |
| createdAt | ISO 8601 | 作成日時 | `2025-11-06T09:00:00+09:00` |
| updatedAt | ISO 8601 | 更新日時 | `2025-11-06T10:00:00+09:00` |
| lastSynced | ISO 8601 | 最終同期日時 | `2025-11-06T10:30:00+09:00` |

**インデックス**: id（ユニーク）

**終日イベント**:
- `isAllDay = TRUE` の場合、日付のみで時刻は無視
- カレンダーAPIの `allDay` イベントとして登録

### 2. Members シート

| カラム | 型 | 説明 | 例 |
|--------|----|----|-----|
| userKey | string | ユーザー識別子 | `anon-Fl田中` |
| part | string | パート | `Fl` |
| name | string | 名前 | `田中` |
| displayName | string | 表示名 | `Fl田中` |
| createdAt | ISO 8601 | 登録日時 | `2025-11-06T10:00:00+09:00` |
| updatedAt | ISO 8601 | 更新日時 | `2025-11-06T15:30:00+09:00` |

**インデックス**: userKey（ユニーク）

**パート一覧**:
```
Fl, Ob, Cl, Sax, Hr, Tp, Tb, Bass, Perc, その他
```

**自動登録**:
- 初回出欠登録時に自動で登録
- 表示名から `parseMemberNameFromString()` でパート・名前を抽出

### 3. Responses シート

| カラム | 型 | 説明 | 例 |
|--------|----|----|-----|
| eventId | string | イベントID | `08801d82-ebf1...` |
| userKey | string | ユーザー識別子 | `anon-Fl田中` |
| status | string | 出欠ステータス | `○` / `△` / `×` |
| comment | string | コメント | `よろしくお願いします` |
| createdAt | ISO 8601 | 初回登録日時 | `2025-11-06T10:00:00+09:00` |
| updatedAt | ISO 8601 | 更新日時 | `2025-11-06T15:30:00+09:00` |

**複合キー**: (eventId, userKey)

**出欠ステータス**:
- `○`: 参加
- `△`: 未定
- `×`: 欠席

### 4. Config シート

| key | value | 説明 |
|-----|-------|------|
| AUTH_MODE | `anonymous` | 認証モード（固定） |
| ADMIN_TOKEN | `abc123...` | 管理者トークン（32文字） |
| CALENDAR_ID | `xxx@group.calendar.google.com` | 連携カレンダーID |
| TIMEZONE | `Asia/Tokyo` | タイムゾーン |
| DISPLAY_START_DATE | `2025-04-01` | 表示開始日 |
| DISPLAY_END_DATE | `2026-03-31` | 表示終了日 |

**設定方法**:
- Configシートで直接編集
- `setConfig(key, value)` 関数で更新

---

## 認証・セキュリティ

### 認証方式

#### 匿名モード

**フロー**:
1. ユーザーがURL直接アクセス
2. 表示名入力（初回のみ）
3. 即座に利用開始

**ユーザー識別子**:
- `userKey`: `anon-{表示名}`
- ブラウザのlocalStorageに保存（再訪時に復元）

**管理者判定**:
- URL パラメータ `?admin=xxx` で判定
- トークンはConfigシートの `ADMIN_TOKEN` と照合

### セッション管理

**匿名モード**:
- セッション管理なし
- localStorageでuserKeyを保存

### プライバシー保護

#### 最小情報保存原則

| 情報種別 | 保存場所 | 保存有無 |
|---------|---------|---------|
| **メールアドレス** | - | ❌ 保存しない |
| **本名** | - | ❌ 保存しない |
| **表示名（任意）** | Members, Responses | ✅ 保存（ユーザー入力） |
| **userKey** | Members, Responses | ✅ 保存（匿名識別子） |

### セキュリティ対策

| 脅威 | 対策 |
|-----|------|
| **XSS攻撃** | `textContent`使用、innerHTML禁止 |
| **SQLインジェクション** | N/A（Spreadsheet API使用） |
| **CSRF** | 管理者トークンで検証 |
| **なりすまし** | 匿名識別子（userKey） |
| **ボット攻撃** | レート制限（5回/分） |
| **セッション乗っ取り** | HTTPS必須 |
| **情報漏洩** | 個人情報最小化 |

### レート制限（匿名モードのみ）

```typescript
制限内容:
- 同一userKeyで1分以内に5回まで
- 超過時は60秒のクールダウン

実装:
- CacheService でカウント管理
- キー: `rate_limit:{userKey}`
```

---

## カレンダー連携

### 専用カレンダーのセットアップ

#### 初回セットアップ時

**専用カレンダーを作成する理由**:
1. アプリ管理イベントのみを格納（手動追加と分離）
2. 複数管理者での共同編集が容易
3. 開発・本番環境の分離が可能
4. 削除・再作成が簡単

**セットアップ処理**:
```typescript
/**
 * 楽団専用カレンダーを作成
 * - 初回デプロイ時に1回だけ実行
 * - 作成したカレンダーIDをConfigシートに保存
 */
function setupBandCalendar(): string {
  const calendar = CalendarApp.createCalendar('吹奏楽団 イベントカレンダー');
  const calendarId = calendar.getId();
  
  Logger.log(`専用カレンダー作成成功: ${calendarId}`);
  
  // Configシートに保存
  setConfig('CALENDAR_ID', calendarId);
  
  return calendarId;
}
```

### 同期方向

#### 1. アプリ → カレンダー（自動）

**トリガー**:
- イベント作成時（`createEvent()`）
- イベント更新時（`updateEvent()`）
- イベント削除時（`deleteEvent()`）
- 出欠登録時（`submitResponse()`）
- コメント更新時（`submitResponse()`）

**処理内容**:
1. `calendarEventId` の有無をチェック
2. 存在しない → `Calendar.Events.insert()`
3. 存在する → `Calendar.Events.update()`
4. 説明欄に出欠サマリー + コメントを埋め込み
5. `notesHash` を保存（無限ループ防止）

**関数**:
- `upsertCalendarEvent()`: イベント情報を同期
- `syncCalendarDescriptionForEvent()`: 説明欄のみ同期

**出欠サマリー形式**:
```
（ユーザーが入力した説明）

【出欠状況】
○ 参加: 30人
△ 未定: 5人
× 欠席: 2人
合計: 37人

【コメント】
○ [Fl] 田中: よろしくお願いします
△ [Tp] 佐藤: 遅刻します
× [Cl] 山田: 欠席します
（コメントなし）

最終更新: 2025-11-12 15:30
```

#### 2. カレンダー → アプリ（手動 or トリガー）

**トリガー**:
- 管理画面の「同期」ボタン（手動）
- 時間主導トリガー（15分ごと、設定可能）

**処理内容**:
1. カレンダーから全イベント取得（`pullFromCalendar()`）
2. Eventsシートと比較
3. 新規イベント → Eventsシートに追加
4. 更新されたイベント → Eventsシートを更新
5. 削除されたイベント → status = 'deleted'

**競合解決**:
- `lastSynced` とカレンダーの `updated` を比較
- より新しい方を採用（Last-Write-Wins）
- `notesHash` で説明欄の変更検知

### 同期範囲の制御

#### 表示期間フィルタ

**機能**:
- `syncAll(limitToDisplayPeriod: boolean)` パラメータで制御
- `true`: 表示期間（DISPLAY_START_DATE ～ DISPLAY_END_DATE）のみ
- `false`: デフォルト期間（30日前～1年後）

**表示期間が未指定の場合**:
- `DISPLAY_START_DATE` と `DISPLAY_END_DATE` が両方とも空の場合、デフォルト期間が適用されます
- **デフォルト期間**: 現在日時から **30日前** ～ **1年後**
- この期間は `pullFromCalendar()` 関数内で自動的に設定されます
- 例: 2025年11月12日 14:36:16 の場合 → 2025年10月13日 14:36:16 ～ 2026年11月12日 14:36:16

**適用箇所**:
| 呼び出し元 | `limitToDisplayPeriod` | 理由 |
|-----------|----------------------|------|
| **イベント同期ボタン** | `true` | ユーザーが見ている範囲のみ同期 |
| **定期同期（cron）** | `true` | 不要な範囲を同期しない |
| **手動呼び出し** | `false`（デフォルト） | デバッグ・特殊運用 |

#### notesHash の仕組み

```typescript
// 無限ループ防止策

1. アプリがカレンダー説明欄を更新
2. 説明欄のハッシュ値を計算（SHA256）
3. notesHash に保存
4. 次回同期時、ハッシュ値が一致 → 更新スキップ
5. ハッシュ値が異なる → カレンダー側で手動変更 → 取り込み
```

#### エラーハンドリング

```typescript
個別イベント同期失敗:
- エラーログに記録
- 他のイベントは続行

重大エラー（認証切れなど）:
- 全体同期を即座に中断
- 管理者に通知（ログに記録）
```

### 定期同期（cron）

#### 設定方法

**関数**: `scheduledSync()`

**トリガー設定**:
1. GASエディタの「トリガー」タブ
2. 「トリガーを追加」
3. 実行する関数: `scheduledSync`
4. イベントソース: 時間主導型
5. 時間ベースのトリガー: 15分おき（推奨）

**処理内容**:
```typescript
function scheduledSync(): void {
  // 表示期間のみを同期
  const result = syncAll(true);
  Logger.log(`✅ 定期同期完了: 成功 ${result.success}件, 失敗 ${result.failed}件`);
}
```

**ログ出力**:
```
=== 定期同期開始（表示期間のみ） ===
=== 全イベント同期開始 ===
📅 表示期間に制限: 2025-04-01T00:00:00.000Z ～ 2026-03-31T23:59:59.999Z
=== カレンダー → アプリ同期開始 ===
✅ カレンダーイベント取得: 15件
📋 カレンダー → アプリ同期完了: 成功 15件, 失敗 0件
=== アプリ → カレンダー説明欄同期開始 ===
📋 説明欄同期対象イベント数: 15件
📋 説明欄同期完了: 成功 15件, 失敗 0件
✅ 定期同期完了: 成功 30件, 失敗 0件
```

---

## UI/UX

### 画面構成

#### 1. ユーザー画面（全員アクセス可）

**ヘッダー**:
- アプリタイトル
- 管理者ログインボタン（未ログイン時）
- 同期ボタン + ログアウトボタン（ログイン時）

**イベント一覧**:
- カード形式で表示
- 各カードに出欠入力フォーム内蔵
- 集計サマリーをリアルタイム表示

**フィルタ**:
- 表示期間（DISPLAY_START_DATE ～ DISPLAY_END_DATE）

#### 2. イベント詳細モーダル

**表示順序**:
1. **イベント情報**: タイトル、日時、場所、説明
2. **コメント一覧**: パート・名前・コメント
3. **パート別内訳**: パートごとの出欠状況

**管理者機能**（ログイン時のみ）:
- 編集ボタン
- 削除ボタン

#### 3. 管理画面（管理者のみ）

**追加ボタン**:
- 「新しいイベントを作成」

**イベントカード**:
- 「編集」「削除」ボタン

**グローバル機能**:
- 「同期」ボタン（🔄）
- 「ログアウト」ボタン

### デザイン方針

**コンセプト**: シンプル & モダン

**カラースキーム**:
- プライマリ: #2196F3（青）
- セカンダリ: #FF9800（オレンジ）
- 成功: #4CAF50（緑）
- 警告: #FFC107（黄）
- エラー: #F44336（赤）

**レスポンシブ対応**:
- デスクトップ: 3カラムレイアウト
- タブレット: 2カラム
- モバイル: 1カラム

**アクセシビリティ**:
- コントラスト比 4.5:1 以上
- キーボード操作対応
- aria-label 設定

### インタラクション

**ローディング状態**:
- `google.script.run` 実行中はスピナー表示
- ボタンを無効化（二重送信防止）

**エラー通知**:
- Toast通知（画面右上、3秒表示）
- エラー内容を分かりやすく表示

**成功通知**:
- Toast通知（緑色）
- 「出欠を登録しました」など

**リアルタイム更新**:
- 出欠登録後、即座に集計を再表示
- カレンダーにも即座に反映
- 他のユーザーの更新は反映されない（ページリロードが必要）

---

## 技術仕様

### 開発環境

#### ツール

- **clasp**: GASのローカル開発・デプロイ
- **TypeScript**: 型安全な開発
- **Git**: バージョン管理

#### プロジェクト構造

```
/workspace
├── src/
│   ├── server/
│   │   ├── main.ts           # エントリーポイント、API関数
│   │   ├── events.ts         # イベントCRUD
│   │   ├── responses.ts      # 出欠管理
│   │   ├── members.ts        # メンバー管理
│   │   ├── calendar.ts       # カレンダー連携
│   │   ├── calendar-helper.ts# カレンダーヘルパー
│   │   ├── auth.ts           # 認証処理
│   │   └── utils.ts          # ユーティリティ
│   ├── client/
│   │   └── index.html        # メインHTML（CSS、JS含む）
│   └── types/
│       └── models.ts         # 型定義
├── docs/
│   ├── 仕様書.md             # 本ドキュメント
│   ├── 運用マニュアル.md     # 運用手順
│   ├── セットアップ手順.md   # 初回セットアップ
│   ├── scheduled_sync_setup.md # 定期同期設定
│   └── performance/          # パフォーマンス資料
├── .clasp.json               # clasp設定
├── tsconfig.json             # TypeScript設定
├── appsscript.json           # GAS設定
└── README.md                 # プロジェクト概要
```

### コーディング規約

**TypeScript**:
- 関数・変数名: camelCase
- クラス名: PascalCase
- 定数: UPPER_SNAKE_CASE

**コメント**:
- 日本語で記述
- 関数にはJSDoc形式のコメント
- 「なぜこうしているか」を重視

**エラーハンドリング**:
- try-catch で包む
- Logger.log() でエラー記録
- ユーザーにはフレンドリーなメッセージ

### パフォーマンス最適化

**Spreadsheet アクセス**:
- バッチ読み込み（`getDataRange()`使用）
- 書き込みもバッチ化
- 不要な読み書きを削減

**最適化実績**:
| 項目 | 改善前 | 改善後 | 改善率 |
|-----|-------|-------|--------|
| 初回読み込み | 13-14秒 | 2-3秒 | 約85%改善 |
| API呼び出し | 14回 | 1回 | 約93%削減 |

**バッチ処理**:
- 一括登録機能（`userSubmitResponsesBatch()`）
- 1回のシート読み取り + インデックス構築 + バッチ更新

**表示期間フィルタ**:
- 表示期間外のイベントを除外
- 同期対象を制限して処理時間短縮
- カレンダーAPI呼び出し回数を削減

**カレンダーAPI**:
- exponential backoff でリトライ
- クォータ消費を最小化

### スコープ設定

```json
{
  "oauthScopes": [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/calendar"
  ]
}
```

**最小権限原則**: 必要最小限のスコープのみ

**スコープ説明**:
- `spreadsheets`: データストレージ
- `calendar`: カレンダーイベントの作成・更新・削除

---

## 運用仕様

### デプロイ

#### 初回デプロイ手順

1. claspでGASプロジェクト作成
2. TypeScript コンパイル
3. GASにデプロイ
4. Spreadsheet 自動作成・初期化（`initializeSpreadsheet()`）
5. Script Properties 設定
6. Webアプリとして公開
7. トリガー設定（定期同期）

#### Webアプリ設定

- **実行ユーザー**: 自分
- **アクセス権限**: 全員（匿名ユーザーを含む）
- **URL**: 固定（バージョン管理なし）

### トリガー設定

| トリガー名 | 種類 | 頻度 | 実行関数 |
|-----------|------|------|---------|
| カレンダー同期 | 時間主導 | 15分ごと（推奨） | `scheduledSync()` |

### バックアップ

**手動バックアップ**:
- Spreadsheet の「ファイル > コピーを作成」
- 定期的にバックアップを取ることを推奨

**バックアップ対象**:
- Events シート
- Members シート
- Responses シート
- Config シート

### モニタリング

**ログ確認**:
- GASエディタの「実行数」タブ
- エラー発生時はメール通知（GAS標準機能）

**クォータ管理**:
- Calendar API: 1,000,000 リクエスト/日
- UrlFetch: 20,000 リクエスト/日
- 通常使用では問題なし

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025-11-06 | 初版作成 |
| 1.1 | 2025-11-06 | 専用カレンダー作成仕様追加 |
| 2.0 | 2025-11-12 | **大幅アップデート** |
|  |  | - メンバー管理機能追加（Membersシート） |
|  |  | - カレンダー同期強化（リアルタイム、コメント表示） |
|  |  | - 表示期間管理機能追加 |
|  |  | - 定期同期機能追加（cron対応） |
|  |  | - パフォーマンス最適化（バッチ処理） |
|  |  | - イベント詳細画面の並び順変更 |
|  |  | - 過去のイベント表示対応 |
|  |  | - Sessions/AuditLog/UserPreferencesシート削除 |

---

**文書作成者**: AI Assistant  
**承認者**: プロジェクトオーナー  
**次回レビュー**: 次回大規模アップデート時
