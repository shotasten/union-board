# 出欠管理Webアプリ 仕様書

**バージョン**: 1.0  
**最終更新**: 2025-11-06  
**対象**: 吹奏楽団向け出欠管理システム

---

## 📋 目次

1. [概要](#概要)
2. [システム構成](#システム構成)
3. [機能仕様](#機能仕様)
4. [データモデル](#データモデル)
5. [認証・セキュリティ](#認証セキュリティ)
6. [カレンダー連携](#カレンダー連携)
7. [UI/UX](#uiux)
8. [技術仕様](#技術仕様)
9. [運用仕様](#運用仕様)

---

## 概要

### 目的

吹奏楽団のイベント（練習、演奏会など）の出欠管理を効率化するWebアプリケーション。

### 主要機能

- ✅ イベント管理（管理者：作成・編集・削除）
- ✅ 出欠登録（ユーザー：○/△/× + コメント）
- ✅ 出欠集計表示（リアルタイム）
- ✅ Googleカレンダー連携（双方向同期）
- ✅ 柔軟な認証方式（Google認証 / 匿名）

### 想定ユーザー

- **管理者**: 団長、幹事（イベント管理権限）
- **一般ユーザー**: 団員（出欠登録のみ）

---

## システム構成

### アーキテクチャ

```
┌─────────────────────────────────────┐
│         ユーザー（ブラウザ）         │
│     - Chrome, Safari, Firefox       │
│     - デスクトップ & モバイル        │
└─────────────────────────────────────┘
                 ↓ HTTPS
┌─────────────────────────────────────┐
│   Google Apps Script (GAS)          │
│   - バックエンドロジック（TypeScript）│
│   - HTML Service（フロントエンド）   │
└─────────────────────────────────────┘
         ↓                    ↓
┌──────────────────┐  ┌──────────────────┐
│ Google Spreadsheet│  │ Google Calendar  │
│ - データストレージ │  │ - イベント表示   │
│ - 5シート構成     │  │ - 双方向同期     │
└──────────────────┘  └──────────────────┘
```

### 技術スタック

| レイヤー | 技術 |
|---------|------|
| **開発言語** | TypeScript (clasp) |
| **フロントエンド** | Vanilla JavaScript, CSS |
| **バックエンド** | Google Apps Script |
| **データベース** | Google Spreadsheet |
| **認証** | Google Identity Services / 匿名 |
| **キャッシュ** | CacheService + Spreadsheet (2層) |
| **カレンダー** | Google Calendar API |

---

## 機能仕様

### 1. イベント管理機能

#### 1.1 イベント作成

**権限**: 管理者のみ

**入力項目**:
- タイトル（必須、最大100文字）
- 開始日時（必須）
- 終了日時（必須）
- 場所（任意、最大200文字）
- カレンダー同期（ON/OFF）

**動作**:
1. 入力バリデーション
2. Eventsシートに保存
3. UUID生成（イベントID）
4. カレンダー同期がONの場合、Googleカレンダーに自動反映
5. 成功メッセージ表示

#### 1.2 イベント編集

**権限**: 管理者のみ

**機能**:
- 既存イベント情報の変更
- 楽観的ロック（バージョン番号チェック）
- カレンダーイベントも自動更新

#### 1.3 イベント削除

**権限**: 管理者のみ

**方式**: 論理削除（status = 'deleted'）

**動作**:
1. 削除確認ダイアログ
2. statusを'deleted'に変更
3. カレンダーイベントは削除 or 保持（設定可能）
4. 既存の出欠データは保持（監査目的）

### 2. 出欠登録機能

#### 2.1 出欠入力

**権限**: 全ユーザー

**入力項目**:
- 出欠ステータス: ○（参加）/ △（未定）/ ×（欠席）
- コメント（任意、最大500文字）
- 表示名（初回のみ、以降は保持）

**動作**:
1. ユーザー認証チェック
2. レート制限チェック（匿名モード時）
3. Responsesシートに保存/更新
4. 集計を再計算して即座に反映
5. カレンダー説明欄を更新（バックグラウンド）

#### 2.2 出欠変更

**権限**: 本人のみ（自分の出欠のみ変更可）

**動作**:
- 既存のレコードを上書き（updatedAt更新）
- 変更履歴はAuditLogシートに記録（オプション）

### 3. 集計表示機能

#### 3.1 イベント一覧

**表示内容**:
- イベントタイトル
- 日時、場所
- 出欠サマリー（○: 30人、△: 5人、×: 2人）
- 自分の出欠状態（ハイライト表示）

**ソート**:
- デフォルト: 開始日時の昇順
- 切り替え可能: 作成日時、タイトル

**フィルタ**:
- 今後のイベント（デフォルト）
- 過去のイベント
- 全て

#### 3.2 出欠詳細

**表示内容**:
- 各ユーザーの出欠状態
- 表示名、ステータス、コメント
- 更新日時

**プライバシー配慮**:
- 表示名のみ表示（メールアドレス・本名なし）
- 管理者でも個人情報は見えない

### 4. 管理者機能

#### 4.1 管理画面アクセス

**Google認証モード**:
- ConfigシートのADMIN_EMAILSに登録されたメールアドレスで自動判定
- 通常URLでアクセス、ログイン後に管理機能が表示

**匿名モード**:
- 管理者トークン付きURL（例: `?adminToken=abc123`）でアクセス
- トークンが一致すれば管理機能が表示

#### 4.2 カレンダー同期

**機能**:
- 個別イベントの手動同期ボタン
- 全イベント一括同期ボタン
- 同期状態表示（最終同期日時）

**同期方向**:
- アプリ → カレンダー: イベント作成・更新時に自動
- カレンダー → アプリ: 手動実行 or トリガー（1時間ごと）

---

## データモデル

### スプレッドシート構成

全5シート構成：

1. **Events** - イベント情報
2. **Responses** - 出欠情報
3. **Sessions** - セッション管理
4. **Config** - 設定情報
5. **AuditLog** - 監査ログ（オプション）

### 1. Events シート

| カラム | 型 | 説明 | 例 |
|--------|----|----|-----|
| id | string | イベントID（UUID） | `evt-abc123...` |
| title | string | タイトル | `定期演奏会` |
| start | ISO 8601 | 開始日時 | `2025-12-10T14:00:00+09:00` |
| end | ISO 8601 | 終了日時 | `2025-12-10T17:00:00+09:00` |
| location | string | 場所 | `市民ホール` |
| calendarId | string | カレンダーID | `primary` |
| calendarEventId | string | カレンダーイベントID | `abc123def456` |
| lastSynced | ISO 8601 | 最終同期日時 | `2025-11-06T10:30:00+09:00` |
| notesHash | string | 説明欄ハッシュ | `hash-xyz...` |
| status | string | ステータス | `active` / `archived` / `deleted` |
| createdBy | string | 作成者（ハッシュ） | `hash-a7f3k9...` |
| createdAt | ISO 8601 | 作成日時 | `2025-11-06T09:00:00+09:00` |
| updatedAt | ISO 8601 | 更新日時 | `2025-11-06T10:00:00+09:00` |
| version | number | バージョン番号 | `1` |

**インデックス**: id（ユニーク）

### 2. Responses シート

| カラム | 型 | 説明 | 例 |
|--------|----|----|-----|
| eventId | string | イベントID | `evt-abc123...` |
| userKey | string | ユーザー識別子（ハッシュ） | `hash-a7f3k9...` / `anon-田中` |
| userName | string | 表示名（任意） | `田中` |
| status | string | 出欠ステータス | `○` / `△` / `×` |
| comment | string | コメント | `よろしくお願いします` |
| createdAt | ISO 8601 | 初回登録日時 | `2025-11-06T10:00:00+09:00` |
| updatedAt | ISO 8601 | 更新日時 | `2025-11-06T15:30:00+09:00` |

**複合キー**: (eventId, userKey)

### 3. Sessions シート

| カラム | 型 | 説明 | 例 |
|--------|----|----|-----|
| sessionId | string | セッションID（UUID） | `sess-abc123...` |
| userHash | string | ユーザーハッシュ | `hash-a7f3k9...` |
| createdAt | ISO 8601 | 作成日時 | `2025-11-06T10:00:00+09:00` |
| lastAccessAt | ISO 8601 | 最終アクセス日時 | `2025-11-06T15:30:00+09:00` |
| status | string | ステータス | `active` / `expired` |

**自動クリーンアップ**: lastAccessAtが30日以上前のレコードを削除（日次トリガー）

### 4. Config シート

| key | value | 説明 |
|-----|-------|------|
| AUTH_MODE | `google` / `anonymous` | 認証モード |
| ADMIN_EMAILS | `admin1@example.com,admin2@example.com` | 管理者メールアドレス（カンマ区切り） |
| CALENDAR_ID | `primary` | 連携カレンダーID |
| SYNC_INTERVAL_HOURS | `6` | 同期間隔（時間） |
| SESSION_EXPIRE_DAYS | `30` | セッション有効期間（日） |
| CACHE_EXPIRE_HOURS | `6` | Cache保持時間（時間） |
| TIMEZONE | `Asia/Tokyo` | タイムゾーン |
| RECAPTCHA_SITE_KEY | `6Lc...` | reCAPTCHA Site Key（匿名モード時） |

### 5. AuditLog シート（オプション）

| カラム | 型 | 説明 |
|--------|----|----|
| timestamp | ISO 8601 | 実行日時 |
| userKey | string | 実行ユーザー |
| action | string | アクション種別 |
| eventId | string | 対象イベントID |
| details | JSON | 詳細情報 |

---

## 認証・セキュリティ

### 認証方式

#### A. Google認証モード

**フロー**:
1. ユーザーが「Googleでログイン」ボタンをクリック
2. Google Identity Services でOAuth認証
3. IDトークン取得（sub, email含む）
4. GAS側でtokeninfo APIで検証
5. subをハッシュ化してセッション作成
6. セッションIDをクライアントに返却

**ユーザー識別子**:
- `userKey`: `hash-{SHA256(sub + salt)}`（16文字）
- メールアドレス・本名は保存しない

**管理者判定**:
- ConfigシートのADMIN_EMAILSに登録されたメールアドレスと照合

#### B. 匿名モード

**フロー**:
1. ユーザーがURL直接アクセス
2. ニックネーム入力（任意）
3. 即座に利用開始

**ユーザー識別子**:
- `userKey`: `anon-{ニックネーム}`
- ブラウザのlocalStorageに保存（再訪時に復元）

**管理者判定**:
- URL パラメータ `?adminToken=xxx` で判定
- トークンはScript Propertiesに保存

### セッション管理（Google認証モードのみ）

#### 2層キャッシュ方式

**Layer 1: CacheService（高速）**
- 保持期間: 6時間（GAS上限）
- 用途: 頻繁なアクセスの高速化（10ms以下）

**Layer 2: Spreadsheet（永続）**
- 保持期間: 30日（設定可能）
- 用途: 長期セッション管理
- 自動延長: 操作のたびにlastAccessAt更新

**認証フロー**:
```typescript
1. Cache.get(sessionId) → Hit? → 即座に認証OK
2. Cache Miss → Spreadsheet検索
3. 見つかった? → 有効期限チェック（30日）
4. 有効 → Cache再登録 & lastAccessAt更新
5. 無効 → 再ログイン要求
```

### プライバシー保護

#### 最小情報保存原則

| 情報種別 | 保存場所 | 保存有無 |
|---------|---------|---------|
| **管理者メアド** | Configシート | ✅ 保存（必要最小限） |
| **一般ユーザーメアド** | - | ❌ 保存しない |
| **本名** | - | ❌ 保存しない |
| **Google sub** | - | ❌ ハッシュ化後のみ保存 |
| **ユーザーハッシュ** | Sessions, Responses | ✅ 保存（一方向暗号化） |
| **表示名（任意）** | Responses | ✅ 保存（ユーザー入力） |

#### ハッシュ化仕様

```typescript
hash = SHA256(sub + salt)
salt = 初回生成時にランダム作成、固定値として保存

特徴:
- 一方向暗号化（復元不可）
- 同じsubなら同じハッシュ（識別可能）
- saltで強化（レインボーテーブル攻撃防止）
```

### セキュリティ対策

| 脅威 | 対策 |
|-----|------|
| **XSS攻撃** | `textContent`使用、innerHTML禁止 |
| **SQLインジェクション** | N/A（Spreadsheet API使用） |
| **CSRF** | セッショントークンでリクエスト検証 |
| **なりすまし** | Google認証 or reCAPTCHA（匿名時） |
| **ボット攻撃** | reCAPTCHA v3（匿名時）、レート制限 |
| **セッション乗っ取り** | HTTPS必須、30日自動期限切れ |
| **情報漏洩** | 個人情報最小化、ハッシュ化 |

### レート制限（匿名モードのみ）

```typescript
制限内容:
- 同一userKeyで1分以内に5回まで
- 超過時は60秒のクールダウン

実装:
- CacheService でカウント管理
- キー: `rate_limit:{userKey}`
```

---

## カレンダー連携

### 同期方向

#### 1. アプリ → カレンダー（自動）

**トリガー**:
- イベント作成時
- イベント更新時

**処理内容**:
1. calendarEventId の有無をチェック
2. 存在しない → Calendar.Events.insert()
3. 存在する → Calendar.Events.update()
4. 説明欄に出欠サマリーを埋め込み
5. notesHash を保存（無限ループ防止）

**出欠サマリー形式**:
```
【出欠状況】
○ 参加: 30人
△ 未定: 5人
× 欠席: 2人
合計: 37人

最終更新: 2025-11-06 15:30
```

#### 2. カレンダー → アプリ（手動 or トリガー）

**トリガー**:
- 管理画面の「同期」ボタン
- 時間主導トリガー（6時間ごと、設定可能）

**処理内容**:
1. カレンダーから全イベント取得
2. Eventsシートと比較
3. 新規イベント → Eventsシートに追加
4. 更新されたイベント → Eventsシートを更新
5. 削除されたイベント → status = 'deleted'

**競合解決**:
- lastSynced とカレンダーの updated を比較
- より新しい方を採用（Last-Write-Wins）
- notesHash で説明欄の変更検知

### 同期制御

#### notesHash の仕組み

```typescript
// 無限ループ防止策

1. アプリがカレンダー説明欄を更新
2. 説明欄のハッシュ値を計算
3. notesHash に保存
4. 次回同期時、ハッシュ値が一致 → 更新スキップ
5. ハッシュ値が異なる → カレンダー側で手動変更 → 取り込み
```

#### エラーハンドリング

```typescript
個別イベント同期失敗:
- エラーログに記録
- 他のイベントは続行

重大エラー（認証切れなど）:
- 全体同期を即座に中断
- 管理者に通知（ログに記録）
```

---

## UI/UX

### 画面構成

#### 1. ユーザー画面（全員アクセス可）

**ヘッダー**:
- アプリタイトル
- ログイン状態表示（Google認証時）
- ログアウトボタン（Google認証時）

**イベント一覧**:
- カード形式で表示
- 各カードに出欠入力フォーム内蔵
- 集計サマリーをリアルタイム表示

**フィルタ**:
- 「今後のイベント」「過去のイベント」「全て」

#### 2. 管理画面（管理者のみ）

**追加ボタン**:
- 「新しいイベントを作成」

**イベントカード**:
- 「編集」「削除」ボタン
- 「カレンダー同期」ボタン
- 同期状態表示（最終同期日時）

**グローバル機能**:
- 「全イベントを同期」ボタン

#### 3. ログイン画面（Google認証モード時）

**初回アクセス**:
- 「Googleでログイン」ボタン（大きく目立つ）
- アプリ説明文

**初回ログイン後**:
- 表示名設定画面
- 「後から変更できます」の案内

### デザイン方針

**コンセプト**: シンプル & モダン

**カラースキーム**:
- プライマリ: #2196F3（青）
- セカンダリ: #FF9800（オレンジ）
- 成功: #4CAF50（緑）
- 警告: #FFC107（黄）
- エラー: #F44336（赤）

**レスポンシブ対応**:
- デスクトップ: 3カラムレイアウト
- タブレット: 2カラム
- モバイル: 1カラム

**アクセシビリティ**:
- コントラスト比 4.5:1 以上
- キーボード操作対応
- aria-label 設定

### インタラクション

**ローディング状態**:
- `google.script.run` 実行中はスピナー表示
- ボタンを無効化（二重送信防止）

**エラー通知**:
- Toast通知（画面右上、3秒表示）
- エラー内容を分かりやすく表示

**成功通知**:
- Toast通知（緑色）
- 「出欠を登録しました」など

**リアルタイム更新**:
- 出欠登録後、即座に集計を再表示
- 他のユーザーの更新は反映されない（ページリロードが必要）

---

## 技術仕様

### 開発環境

#### ツール

- **clasp**: GASのローカル開発・デプロイ
- **TypeScript**: 型安全な開発
- **Git**: バージョン管理

#### プロジェクト構造

```
/workspace
├── src/
│   ├── server/
│   │   ├── main.ts          # doGet, エントリーポイント
│   │   ├── events.ts        # イベントCRUD
│   │   ├── responses.ts     # 出欠管理
│   │   ├── calendar.ts      # カレンダー連携
│   │   ├── auth.ts          # 認証処理
│   │   └── utils.ts         # ユーティリティ
│   ├── client/
│   │   ├── index.html       # メインHTML
│   │   ├── styles.css       # スタイル
│   │   └── app.js           # フロントエンドロジック
│   └── types/
│       └── models.ts        # 型定義
├── docs/
│   ├── 仕様書.md            # 本ドキュメント
│   └── 作業計画書.md        # 作業計画
├── .clasp.json              # clasp設定
├── tsconfig.json            # TypeScript設定
├── appsscript.json          # GAS設定
└── README.md                # プロジェクト概要
```

### コーディング規約

**TypeScript**:
- ESLint + Prettier使用
- 関数・変数名: camelCase
- クラス名: PascalCase
- 定数: UPPER_SNAKE_CASE

**コメント**:
- 日本語で記述
- 関数にはJSDoc形式のコメント
- 「なぜこうしているか」を重視

**エラーハンドリング**:
- try-catch で包む
- Logger.log() でエラー記録
- ユーザーにはフレンドリーなメッセージ

### パフォーマンス最適化

**Spreadsheet アクセス**:
- バッチ読み込み（getDataRange()使用）
- 書き込みもバッチ化
- 不要な読み書きを削減

**キャッシュ戦略**:
- CacheService を最大限活用
- Spreadsheet を補助キャッシュとして利用
- 頻繁にアクセスするデータは Cache に保存

**カレンダーAPI**:
- exponential backoff でリトライ
- クォータ消費を最小化

### スコープ設定

```json
{
  "oauthScopes": [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/calendar"
  ]
}
```

**最小権限原則**: 必要最小限のスコープのみ

---

## 運用仕様

### デプロイ

#### 初回デプロイ手順

1. claspでGASプロジェクト作成
2. TypeScript コンパイル
3. GASにデプロイ
4. Spreadsheet 自動作成・初期化
5. Script Properties 設定
6. Webアプリとして公開
7. トリガー設定

#### Webアプリ設定

- **実行ユーザー**: 自分
- **アクセス権限**: 全員（匿名ユーザーを含む）
- **URL**: 固定（バージョン管理なし）

### トリガー設定

| トリガー名 | 種類 | 頻度 | 実行関数 |
|-----------|------|------|---------|
| カレンダー同期 | 時間主導 | 6時間ごと | `syncAll()` |
| セッションクリーンアップ | 時間主導 | 1日1回（深夜2時） | `cleanupOldSessions()` |

### バックアップ

**自動バックアップ**:
- トリガーで週1回実行
- Events, Responses シートをコピー
- バックアップシート名: `Events_backup_20251106_020000`

**手動バックアップ**:
- Spreadsheet の「ファイル > コピーを作成」

### モニタリング

**ログ確認**:
- GASエディタの「実行数」タブ
- エラー発生時はメール通知（GAS標準機能）

**クォータ管理**:
- Calendar API: 1,000,000 リクエスト/日
- UrlFetch: 20,000 リクエスト/日
- 通常使用では問題なし

### トラブルシューティング

#### よくある問題

**問題1**: セッションが切れる

**原因**: CacheService が揮発性
**対処**: Spreadsheet から自動復元（仕様通り）

**問題2**: カレンダー同期が遅い

**原因**: API呼び出しが多い
**対処**: 同期間隔を延長（Configシートで調整）

**問題3**: 出欠が重複登録される

**原因**: 二重送信
**対処**: フロントエンドでボタン無効化実装済み

### データ移行

**設定変更**:
- Configシートを直接編集
- 再デプロイ不要

**認証モード切り替え**:
1. Configシート: AUTH_MODE を変更
2. 匿名 → Google: ADMIN_EMAILS を設定
3. Google → 匿名: 管理者トークンを確認

### セキュリティ対応

**定期的な確認事項**:
- [ ] 管理者リストの更新
- [ ] 不要なセッションの削除
- [ ] AuditLog の確認（疑わしいアクティビティ）
- [ ] Script Properties のバックアップ

---

## 付録

### 用語集

| 用語 | 説明 |
|-----|------|
| **GAS** | Google Apps Script |
| **clasp** | Command Line Apps Script Projects（CLIツール） |
| **userKey** | ユーザー識別子（ハッシュ化されたID） |
| **userHash** | Google subをハッシュ化したもの |
| **sessionId** | セッション識別子（UUID） |
| **sub** | Google認証のユニークID |
| **IDトークン** | Google認証のトークン |
| **tokeninfo API** | Googleのトークン検証API |

### 参考資料

- [Google Apps Script 公式ドキュメント](https://developers.google.com/apps-script)
- [Google Calendar API リファレンス](https://developers.google.com/calendar/api)
- [Google Identity Services](https://developers.google.com/identity/gsi/web)
- [clasp ドキュメント](https://github.com/google/clasp)

### 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025-11-06 | 初版作成 |

---

**文書作成者**: AI Assistant  
**承認者**: プロジェクトオーナー  
**次回レビュー**: Phase 1 完了時
