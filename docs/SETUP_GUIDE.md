# セットアップ手順（完全版）

出欠管理アプリを他のアカウントで1から導入・運用するための完全な手順書です。

## 前提条件

- Node.js v14以上がインストールされていること
- 運用するGoogleアカウントを持っていること
- Google Apps Script APIが有効化されていること

## ステップ1: リポジトリのクローン

```bash
git clone https://github.com/shotasten/union-board.git
cd union-board
```

## ステップ2: 依存関係のインストール

```bash
npm install
```

## ステップ3: Google Apps Script APIの有効化

1. **運用するGoogleアカウントで** [Google Apps Script 設定ページ](https://script.google.com/home/usersettings)にアクセス
2. 「Google Apps Script API」を有効化
   - チェックボックスをオンにして保存

## ステップ4: clasp認証

```bash
clasp login
```

ブラウザが開くので、**運用するGoogleアカウントで**ログインして権限を許可してください。

**重要**: この時点で使用するアカウントが、以降のすべての操作で使用されます。

## ステップ5: GASプロジェクトの作成

```bash
clasp create --type standalone --title "出欠管理アプリ" --rootDir ./dist
```

**実行結果の確認**:
- `.clasp.json` ファイルが自動生成されます
- `scriptId` が記載されているので、このIDをメモしておきます

**注意**: 既存のプロジェクトを使用する場合は、このステップをスキップして `.clasp.json` の `scriptId` を既存のプロジェクトIDに変更してください。

## ステップ6: ビルドとプッシュ

```bash
# TypeScriptをコンパイル
npm run build

# GASにプッシュ（--force で強制プッシュ）
npm run push
```

**確認事項**:
- エラーが発生していないか確認
- GASエディタでファイルが正しくアップロードされているか確認

**注意**: `npm run push` は `--force` フラグを使用して強制プッシュします。これにより、clasp の変更検出の問題を回避し、確実にコードが更新されます。

## ステップ7: Spreadsheet初期化

1. GASエディタを開く: `https://script.google.com/home/projects/<SCRIPT_ID>/edit`
   - `<SCRIPT_ID>` は `.clasp.json` の `scriptId` です
2. `utils.gs` を選択
3. 関数選択で `initializeSpreadsheet` を選択
4. 「実行」をクリック
5. 実行ログを確認し、以下が表示されることを確認：
   - ✅ Eventsシート作成完了
   - ✅ Responsesシート作成完了
   - ✅ Configシート作成完了
   - ✅ Membersシート作成完了
   - Spreadsheet URL（このURLをメモしておきます）

**エラーが発生した場合**:
- 実行ログのエラーメッセージを確認
- 必要に応じて再実行

## ステップ8: カレンダー初期設定

1. GASエディタで `calendar.gs` を選択
2. 関数選択で `setupBandCalendar` を選択
3. 「実行」をクリック
4. 実行ログを確認し、以下が表示されることを確認：
   - ✅ 専用カレンダー作成成功
   - ✅ CALENDAR_IDをConfigシートに保存

**注意**: このステップで「Tokyo Music Union イベントカレンダー」という名前のカレンダーが作成されます。Googleカレンダーで確認できます。

## ステップ9: 管理者トークンの取得

1. GASエディタで `utils.gs` を選択
2. 関数選択で `getAllConfig` を選択
3. 「実行」をクリック
4. 実行ログから `ADMIN_TOKEN` の値をコピー
   - 例: `ADMIN_TOKEN: eBZDfWShdv0VV767gcH5OfcpChGvDesv`
5. **このトークンを安全な場所に保存**（管理者機能を使用する際に必要です）

**注意**: `getAllConfig` が存在しない場合は、`getConfig('ADMIN_TOKEN', '')` を実行してトークンを取得してください。

## ステップ10: Webアプリとしてデプロイ

1. GASエディタで「デプロイ」→「新しいデプロイ」をクリック
2. 歯車アイコン（⚙️）をクリックして「種類の選択」を開く
3. 種類: 「ウェブアプリ」を選択
4. 説明: 適切な説明を入力（例: "初回デプロイ"）
5. 次のユーザーとして実行: 「自分」を選択
6. アクセス権限: **「全員（匿名ユーザーを含む）」を選択**（重要）
7. **バージョン: 「新規」を選択**（重要：コード更新時に新しいバージョンが作成されます）
8. 「デプロイ」をクリック
9. **デプロイURLをコピーして保存**（このURLがアプリのアクセス先です）

**コード更新時のデプロイ手順**:
1. `npm run push` でコードをプッシュ
2. GASエディタで「デプロイ」→ 既存のデプロイメントを選択 → 「編集」
3. 「バージョン」を「新規」に変更
4. 「デプロイ」をクリック

**重要**: アクセス権限を「全員（匿名ユーザーを含む）」に設定しないと、他のユーザーがアクセスできません。

## ステップ11: 動作確認

1. **デプロイURLにアクセス**（別のブラウザやシークレットモードで確認することを推奨）
2. Google Apps Scriptの警告バナーが表示される場合は「閉じる」をクリック
3. 表示名設定画面が表示されることを確認
4. 表示名を入力して「保存」をクリック
5. イベント一覧が表示されることを確認（初期状態では空）

## ステップ12: 管理者トークンの設定（Webアプリ側）

1. デプロイURLにアクセス
2. ブラウザの開発者ツールを開く（F12キー）
3. 「Console」タブを選択
4. 以下のコマンドを実行（`YOUR_ADMIN_TOKEN` をステップ9で取得したトークンに置き換え）：

```javascript
localStorage.setItem('adminToken', 'YOUR_ADMIN_TOKEN');
```

5. ページをリロード
6. ヘッダーに「+ 新しいイベントを作成」ボタンが表示されることを確認

**確認方法**:
- ブラウザコンソールで `localStorage.getItem('adminToken')` を実行して、トークンが設定されているか確認できます

## ステップ13: 最終確認

以下の機能が正常に動作することを確認してください：

1. **イベント作成**
   - 「+ 新しいイベントを作成」ボタンをクリック
   - イベント情報を入力して保存
   - イベントが一覧に表示されることを確認

2. **出欠登録**
   - イベントカードの「○ 出席」「△ 遅刻/早退」「× 欠席」ボタンをクリック
   - コメントを入力して送信
   - 出欠集計が更新されることを確認

3. **カレンダー同期**
   - イベントカードの「同期」ボタンをクリック
   - Googleカレンダーでイベントが作成されていることを確認

## トラブルシューティング

### clasp認証エラー

**症状**: `clasp login` でエラーが発生する

**対処法**:
- `clasp login` を再実行
- Google Apps Script APIが有効化されているか確認
- 別のブラウザで試す

### デプロイエラー

**症状**: `npm run push` でエラーが発生する、またはコードが更新されない

**対処法**:
- `npm run build` が成功しているか確認
- GASエディタでファイルが正しくアップロードされているか確認
- `.clasp.json` の `scriptId` が正しいか確認
- `npm run push` は `--force` フラグを使用しているため、変更検出の問題は発生しません

### Spreadsheet初期化エラー

**症状**: `initializeSpreadsheet` の実行でエラーが発生する

**対処法**:
- 実行ログのエラーメッセージを確認
- Spreadsheetへのアクセス権限を確認
- 必要に応じて再実行

### Webアプリが表示されない

**症状**: デプロイURLにアクセスしても「ページが見つかりません」と表示される

**対処法**:
- デプロイ設定で「アクセス権限」が「全員（匿名ユーザーを含む）」になっているか確認
- デプロイURLが正しいか確認
- デプロイが完了しているか確認（デプロイには数秒かかる場合があります）

### 管理者機能が使えない

**症状**: 「+ 新しいイベントを作成」ボタンが表示されない

**対処法**:
- ブラウザコンソールで `localStorage.getItem('adminToken')` を実行して、トークンが設定されているか確認
- ステップ12を再実行
- 管理者トークンが正しいか確認（ステップ9で取得したトークンと一致しているか）

## 次のステップ

セットアップが完了したら、[運用マニュアル](OPERATION_MANUAL.md)を参照して、アプリの使用方法を確認してください。

## 重要な情報の保存

セットアップ完了後、以下の情報を安全な場所に保存してください：

- **GASプロジェクトID** (`.clasp.json` の `scriptId`)
- **Spreadsheet URL** (ステップ7で取得)
- **デプロイURL** (ステップ10で取得)
- **管理者トークン** (ステップ9で取得)

これらの情報は、今後の運用やトラブルシューティングで必要になります。

