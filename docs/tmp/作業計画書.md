# 出欠管理Webアプリ 作業計画書

**プロジェクト名**: 吹奏楽団向け出欠管理システム  
**作成日**: 2025-11-06  
**想定期間**: 約2-3週間  
**作業方式**: 自律的に進行、Phase完了時に報告

---

## 📋 目次

1. [開発方針（必読・厳守）](#開発方針必読厳守)
2. [プロジェクト概要](#プロジェクト概要)
3. [作業フェーズ](#作業フェーズ)
4. [Phase 0: 環境セットアップ](#phase-0-環境セットアップ)
5. [Phase 1: MVP実装](#phase-1-mvp実装)
6. [Phase 2: カレンダー連携](#phase-2-カレンダー連携)
7. [Phase 3: 認証・セキュリティ](#phase-3-認証セキュリティ)
8. [Phase 4: テスト・デプロイ](#phase-4-テストデプロイ)
9. [リスク管理](#リスク管理)
10. [成果物一覧](#成果物一覧)

---

## 開発方針（必読・厳守）

### 🚨 最重要原則

この開発プロジェクトでは、以下の原則を**絶対に守る**こと。

---

### 1. テスト駆動開発の徹底

#### ✅ 必須事項

**実装を進めたら、必ず以下を実施**:

- [ ] **動作確認用のテストコードを実装**
- [ ] **意図した動作が行えるかを確認**
- [ ] **意図した実装になっているかを検証**

#### 📝 具体的な手順

```
1. 機能を実装
   ↓
2. テスト関数を作成（例: testCreateEvent(), testSubmitResponse()）
   ↓
3. テストを実行
   ↓
4. 結果を確認・記録
   ↓
5. すべてのテストが通るまで修正
   ↓
6. 次の機能へ
```

#### 🔍 確認項目

各実装後、以下を確認すること:

- [ ] **正常系**: 意図した入力で意図した結果が得られるか
- [ ] **異常系**: エラー入力で適切にエラーハンドリングされるか
- [ ] **境界値**: 最小値、最大値、空文字、nullなどで動作するか
- [ ] **統合**: 他の機能との連携が正しく動作するか

---

### 2. 問題解決への真摯な姿勢

#### 🚫 禁止事項

**動作確認に失敗した場合、絶対にやってはいけないこと**:

- ❌ 仕様を簡単な方に変更する
- ❌ 問題を無視して先に進む
- ❌ 動作しない機能を「とりあえず」残す
- ❌ エラーを握りつぶす
- ❌ 「たぶん動く」で済ませる

#### ✅ 必須行動

**動作確認に失敗した場合、必ず以下を実施**:

```
1. 問題に真摯に向き合う
   ↓
2. 原因を徹底的に調査
   - ログ出力を増やす
   - デバッグコードを追加
   - 関連コードを確認
   - ドキュメントを読み返す
   ↓
3. 解決策を模索
   - 複数の解決方法を検討
   - 参考資料を調査
   - 段階的に問題を切り分け
   ↓
4. 解決を目指す
   - 仮説を立てる
   - 検証する
   - 修正する
   - 再テスト
   ↓
5. 解決するまで繰り返す
```

#### ⚠️ どうしても解決できない場合

以下の状況になった場合のみ、作業を一時停止してユーザーに報告:

- [ ] **3時間以上調査しても原因が特定できない**
- [ ] **技術的な制約・限界に直面した**
- [ ] **仕様の根本的な見直しが必要と判断した**
- [ ] **外部サービス（Google API等）の仕様変更が疑われる**
- [ ] **重要な設計判断が必要（複数の選択肢がある）**

**この場合の対応**:

```
1. 作業を一時停止
2. 【Question】タグで以下を報告:
   - 何をしようとしたか
   - 何が起きたか（エラーメッセージ、ログ）
   - どう調査したか
   - どこまで分かったか
   - 何が分からないか
   - 提案する解決策（あれば）
3. 【Answer】タグで回答を待つ
4. 回答を受けて作業再開
```

---

### 3. 品質保証の基準

#### 最低限の品質基準

各機能は以下を満たすまで「完成」とは言えない:

- [ ] **動作する**: 基本機能が正常に動作する
- [ ] **テスト済み**: テストコードで検証済み
- [ ] **エラーハンドリング**: 異常系に対応している
- [ ] **ログ出力**: 問題発生時に追跡可能
- [ ] **コメント記載**: 「なぜこうしているか」が明確

#### コード品質チェックリスト

```typescript
// ❌ 悪い例
function createEvent(data) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Events');
  sheet.appendRow([data.title, data.start]);
}

// ✅ 良い例
/**
 * イベントを作成
 * @param data イベントデータ
 * @returns イベントID（成功時）、null（失敗時）
 */
function createEvent(data: EventInput): string | null {
  try {
    // バリデーション
    if (!data.title || data.title.length > 100) {
      Logger.log('エラー: タイトルが不正');
      return null;
    }
    
    // イベント作成処理
    const sheet = getEventsSheet();
    const eventId = Utilities.getUuid();
    sheet.appendRow([eventId, data.title, data.start, data.end]);
    
    Logger.log(`イベント作成成功: ${eventId}`);
    return eventId;
    
  } catch (error) {
    Logger.log(`エラー: イベント作成失敗 - ${error.message}`);
    return null;
  }
}

// テスト関数
function testCreateEvent() {
  // 正常系
  const eventId = createEvent({
    title: 'テストイベント',
    start: '2025-12-10T14:00:00+09:00',
    end: '2025-12-10T17:00:00+09:00'
  });
  console.assert(eventId !== null, 'イベント作成に成功すること');
  
  // 異常系
  const invalidId = createEvent({ title: '' });
  console.assert(invalidId === null, '空タイトルはエラーになること');
  
  Logger.log('✅ testCreateEvent: すべてのテストが成功');
}
```

---

### 4. 進捗報告の義務

#### Phase完了時の報告内容

各Phase完了時、以下を必ず報告（承認は不要、自律的に次へ進む）:

1. **実装内容**
   - 何を実装したか
   - 使用した技術・手法

2. **テスト結果**
   - どのようなテストを実施したか
   - すべて成功したか
   - 失敗した場合はどう解決したか

3. **問題と解決**
   - 直面した問題
   - 解決方法
   - 学んだこと

4. **次のステップ**
   - 次に何をするか
   - 懸念点はあるか（重大な場合は質問）

#### 質問が必要なケース

以下の場合のみ、作業を停止して質問:

- 仕様が不明確で複数の解釈がある
- 重要な設計判断が必要
- 解決できない技術的問題
- 想定外の制約に直面

---

### 5. この方針を守るための仕組み

#### 各作業項目に追加するチェックリスト

すべての作業項目に以下を追加:

```
実装完了基準:
- [ ] 実装完了
- [ ] テストコード作成
- [ ] テスト実行・成功
- [ ] エラーハンドリング確認
- [ ] ログ出力確認
- [ ] コメント記載
- [ ] 動作確認済み
```

#### Phase完了前の最終確認

```
Phase完了前チェック:
- [ ] すべての機能が動作する
- [ ] すべてのテストが成功する
- [ ] エラーが握りつぶされていない
- [ ] 未解決の問題がない
- [ ] ドキュメントが更新されている
```

---

## ⚠️ この方針に違反した場合

もし以下のような状況が発生した場合、**即座に作業を停止**:

- テストなしで次の機能に進もうとした
- 失敗したテストを無視した
- 仕様を勝手に簡略化した
- 問題を先送りにした

**必ず立ち止まって、この方針を読み返すこと。**

---

## プロジェクト概要

### 目的

Google Apps Script（GAS）とHTML Serviceを使用し、吹奏楽団向けの出欠管理Webアプリを構築する。

### 主要要件

- ✅ イベント管理（管理者：作成・編集・削除）
- ✅ 出欠登録（ユーザー：○/△/× + コメント）
- ✅ 出欠集計表示（リアルタイム）
- ✅ Googleカレンダー連携（双方向同期）
- ✅ 柔軟な認証方式（Google認証 / 匿名の両対応）

### 技術スタック

- **言語**: TypeScript (clasp使用)
- **フロントエンド**: Vanilla JavaScript + CSS
- **バックエンド**: Google Apps Script
- **ストレージ**: Google Spreadsheet
- **認証**: Google Identity Services / 匿名
- **タイムゾーン**: Asia/Tokyo

### 成功基準

- [ ] MVP機能が動作（イベント作成、出欠登録、集計表示）
- [ ] カレンダー双方向同期が正常動作
- [ ] 認証モード切り替えが設定のみで可能
- [ ] プライバシー保護（個人情報最小化）
- [ ] レスポンシブ対応（モバイル利用可能）

---

## 作業フェーズ

全体を4つのPhaseに分割し、各Phase完了後に承認を求める。

| Phase | 内容 | 想定期間 | 依存関係 |
|-------|------|---------|---------|
| **Phase 0** | 環境セットアップ | 1日 | なし |
| **Phase 1** | MVP実装 | 5-7日 | Phase 0 |
| **Phase 2** | カレンダー連携 | 3-4日 | Phase 1 |
| **Phase 3** | 認証・セキュリティ | 3-4日 | Phase 1 |
| **Phase 4** | テスト・デプロイ | 2-3日 | Phase 2, 3 |

**合計想定期間**: 14-19日（約2-3週間）

---

## Phase 0: 環境セットアップ

### 目的

ローカル開発環境を構築し、GASプロジェクトの基盤を整える。

### 作業項目

#### 0.1 clasp インストール・初期化

**タスク**:
- [ ] Node.js のバージョン確認（v14以上）
- [ ] `npm install -g @google/clasp` 実行
- [ ] `clasp login` でGoogle認証
- [ ] `clasp create --type standalone --title "出欠管理アプリ"` 実行

**成果物**:
- `.clasp.json` ファイル作成
- GASプロジェクトがGoogleドライブに作成される

**所要時間**: 30分

---

#### 0.2 TypeScript 設定

**タスク**:
- [ ] `tsconfig.json` 作成
- [ ] `@types/google-apps-script` インストール
- [ ] コンパイラオプション設定

**tsconfig.json の内容**:
```json
{
  "compilerOptions": {
    "target": "ES2019",
    "module": "None",
    "lib": ["ES2019"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules"]
}
```

**成果物**:
- `tsconfig.json`
- `package.json`（dependencies含む）

**所要時間**: 30分

---

#### 0.3 プロジェクト構造作成

**タスク**:
- [ ] ディレクトリ構造を作成
- [ ] サンプルファイル作成（動作確認用）

**ディレクトリ構造**:
```
/workspace
├── src/
│   ├── server/
│   │   ├── main.ts          # エントリーポイント
│   │   ├── events.ts        # イベント管理
│   │   ├── responses.ts     # 出欠管理
│   │   ├── calendar.ts      # カレンダー連携
│   │   ├── auth.ts          # 認証処理
│   │   └── utils.ts         # ユーティリティ
│   ├── client/
│   │   ├── index.html       # メインHTML
│   │   ├── styles.css       # スタイル
│   │   └── app.js           # フロントエンド
│   └── types/
│       └── models.ts        # 型定義
├── docs/
│   ├── 仕様書.md
│   └── 作業計画書.md
├── .clasp.json
├── tsconfig.json
├── appsscript.json
├── package.json
└── README.md
```

**成果物**:
- 全ディレクトリ・ファイル作成
- `main.ts` に `doGet()` サンプル実装

**所要時間**: 30分

---

#### 0.4 初回デプロイ動作確認

**タスク**:
- [ ] `tsc` でコンパイル
- [ ] `clasp push` でGASにデプロイ
- [ ] GASエディタで動作確認
- [ ] テストWebアプリを公開

**動作確認**:
- ブラウザでWebアプリURLにアクセス
- 「Hello, World!」が表示されることを確認

**成果物**:
- デプロイ可能な状態
- WebアプリURL取得

**所要時間**: 30分

---

### Phase 0 完了条件

- [x] claspでローカル開発環境が整っている
- [x] TypeScriptがコンパイル可能
- [x] GASへのデプロイが成功している
- [x] Webアプリとしてアクセスできる

### Phase 0 完了時の対応

**完了条件を満たしたら**: 完了報告をして、Phase 1 に自動的に進む

---

## Phase 1: MVP実装

### 目的

コア機能（イベント管理、出欠登録、集計表示）を実装する。認証は後回し（匿名モード前提）。

### 作業項目

#### 1.1 Spreadsheet 初期化

**タスク**:
- [ ] Spreadsheet作成スクリプト実装
- [ ] 5シート作成（Events, Responses, Sessions, Config, AuditLog）
- [ ] ヘッダー行追加
- [ ] Config初期値設定

**Config初期値**:
```
AUTH_MODE: anonymous
CALENDAR_ID: primary
SESSION_EXPIRE_DAYS: 30
CACHE_EXPIRE_HOURS: 6
TIMEZONE: Asia/Tokyo
```

**実装ファイル**: `src/server/utils.ts`

**関数**:
```typescript
function initializeSpreadsheet(): void
function getOrCreateSpreadsheet(): GoogleAppsScript.Spreadsheet.Spreadsheet
```

**所要時間**: 2時間

---

#### 1.2 型定義作成

**タスク**:
- [ ] `types/models.ts` に全インターフェース定義

**型定義**:
```typescript
interface Event { ... }
interface Response { ... }
interface EventTally { ... }
interface Config { ... }
interface Session { ... }
```

**所要時間**: 1時間

---

#### 1.3 イベントCRUD実装

**タスク**:
- [ ] イベント作成関数
- [ ] イベント取得関数（全件、単件）
- [ ] イベント更新関数
- [ ] イベント削除関数（論理削除）

**実装ファイル**: `src/server/events.ts`

**関数**:
```typescript
function createEvent(title, start, end, location): string
function getEvents(filter?: 'upcoming' | 'past' | 'all'): Event[]
function getEventById(eventId: string): Event | null
function updateEvent(eventId: string, updates: Partial<Event>): boolean
function deleteEvent(eventId: string): boolean
```

**バリデーション**:
- タイトル: 必須、最大100文字
- 開始日時 < 終了日時
- 日時はISO 8601形式

**所要時間**: 4時間

---

#### 1.4 出欠登録実装

**タスク**:
- [ ] 出欠登録/更新関数
- [ ] 出欠取得関数（イベント別、ユーザー別）
- [ ] 出欠集計関数

**実装ファイル**: `src/server/responses.ts`

**関数**:
```typescript
function submitResponse(eventId, userKey, userName, status, comment): boolean
function getResponses(eventId: string): Response[]
function getResponseByUser(eventId: string, userKey: string): Response | null
function tallyResponses(eventId: string): EventTally
```

**ビジネスロジック**:
- 同一(eventId, userKey)は上書き
- updatedAt自動更新

**所要時間**: 3時間

---

#### 1.5 サーバーサイドAPI実装

**タスク**:
- [ ] `doGet()` エントリーポイント実装
- [ ] 各種API関数実装

**実装ファイル**: `src/server/main.ts`

**API一覧**:
```typescript
function doGet(e): GoogleAppsScript.HTML.HtmlOutput
function getInitData(): { events: Event[], config: Config }
function adminCreateEvent(eventData): { success: boolean, eventId?: string }
function adminUpdateEvent(eventId, updates): { success: boolean }
function adminDeleteEvent(eventId): { success: boolean }
function userSubmitResponse(eventId, userKey, userName, status, comment): { success: boolean }
function getEventWithResponses(eventId): { event: Event, responses: Response[], tally: EventTally }
```

**エラーハンドリング**:
- try-catchで包む
- エラー時は `{ success: false, error: "..." }` 返却

**所要時間**: 4時間

---

#### 1.6 フロントエンド実装（HTML/CSS）

**タスク**:
- [ ] `index.html` 作成（基本レイアウト）
- [ ] `styles.css` 作成（レスポンシブデザイン）

**画面要素**:
- ヘッダー（タイトル）
- イベント一覧（カード形式）
- 各カードに出欠入力フォーム
- 集計サマリー表示

**レスポンシブ**:
- デスクトップ: 3カラム
- タブレット: 2カラム
- モバイル: 1カラム

**所要時間**: 5時間

---

#### 1.7 フロントエンド実装（JavaScript）

**タスク**:
- [ ] `app.js` 作成
- [ ] イベント一覧表示処理
- [ ] 出欠登録処理
- [ ] リアルタイム集計更新

**実装ファイル**: `src/client/app.js`

**主要関数**:
```javascript
function loadEvents()
function renderEventCard(event)
function submitResponse(eventId, status, comment)
function updateTally(eventId)
function showToast(message, type)
function showSpinner() / hideSpinner()
```

**google.script.run 使用**:
```javascript
google.script.run
  .withSuccessHandler(onSuccess)
  .withFailureHandler(onFailure)
  .getInitData();
```

**所要時間**: 6時間

---

#### 1.8 管理画面実装（基本）

**タスク**:
- [ ] イベント作成フォーム
- [ ] イベント編集フォーム
- [ ] 削除確認ダイアログ

**画面追加**:
- 「新しいイベントを作成」ボタン
- モーダルでフォーム表示
- 保存後にリロード

**所要時間**: 4時間

---

### Phase 1 完了条件

- [x] Spreadsheetが正しく初期化される
- [x] イベント作成・編集・削除が動作する
- [x] ユーザーが出欠登録できる
- [x] 集計がリアルタイムで更新される
- [x] レスポンシブデザインが機能する
- [x] 管理画面からイベント管理ができる

### Phase 1 テスト項目

- [ ] イベント作成 → Spreadsheetに保存されるか
- [ ] 出欠登録 → Responsesシートに保存されるか
- [ ] 集計表示 → 正しい人数が表示されるか
- [ ] イベント編集 → 既存イベントが更新されるか
- [ ] イベント削除 → status = 'deleted' になるか
- [ ] モバイル表示 → レイアウトが崩れないか

### Phase 1 完了時の対応

**完了条件を満たしたら**: 完了報告をして、Phase 2, 3 に自動的に進む

---

## Phase 2: カレンダー連携

### 目的

Googleカレンダーとの双方向同期機能と個人カレンダー共有機能を実装する。

### 作業項目

#### 2.0 専用カレンダー作成

**タスク**:
- [ ] 楽団専用カレンダー作成関数実装
- [ ] 初回セットアップ処理実装
- [ ] ConfigシートにCALENDAR_ID保存

**実装ファイル**: `src/server/calendar.ts`

**関数**:
```typescript
function setupBandCalendar(): string
function getOrCreateCalendar(): string
```

**セットアップ処理**:
```typescript
/**
 * 楽団専用カレンダーを作成
 * - 初回デプロイ時に1回だけ実行
 * - 作成したカレンダーIDをConfigシートに保存
 */
function setupBandCalendar(): string {
  const calendar = Calendar.Calendars.insert({
    summary: '吹奏楽団 イベントカレンダー',
    description: 'アプリで管理する練習・演奏会などのスケジュール',
    timeZone: 'Asia/Tokyo'
  });
  
  Logger.log(`専用カレンダー作成成功: ${calendar.id}`);
  setConfig('CALENDAR_ID', calendar.id);
  
  return calendar.id;
}
```

**テスト**:
- [ ] カレンダーが正常に作成される
- [ ] Configシートに保存される
- [ ] 管理者アカウントから閲覧可能

**所要時間**: 2時間

---

#### 2.1 アプリ → カレンダー同期

**タスク**:
- [ ] イベント作成時にカレンダー反映
- [ ] イベント更新時にカレンダー反映
- [ ] 出欠サマリーを説明欄に埋め込み

**実装ファイル**: `src/server/calendar.ts`

**関数**:
```typescript
function upsertCalendarEvent(event: Event): string | null
function buildDescription(eventId: string): string
function syncCalendarDescriptionForEvent(eventId: string): void
```

**出欠サマリー形式**:
```
【出欠状況】
○ 参加: 30人
△ 遅早: 5人
× 欠席: 2人
- 未定: 0人
合計: 37人

最終更新: 2025-11-06 15:30
```

**notesHash**:
- 説明欄のSHA256ハッシュを計算
- Eventsシートに保存（無限ループ防止）

**所要時間**: 4時間

---

#### 2.2 カレンダー → アプリ同期

**タスク**:
- [ ] カレンダーイベント取得
- [ ] Spreadsheetと比較
- [ ] 新規/更新/削除を反映

**実装ファイル**: `src/server/calendar.ts`

**関数**:
```typescript
function pullFromCalendar(calendarId: string): void
function syncAll(): { success: number, failed: number, errors: string[] }
```

**競合解決**:
- lastSynced vs カレンダーupdated を比較
- より新しい方を採用（Last-Write-Wins）

**所要時間**: 5時間

---

#### 2.3 管理画面に同期機能追加

**タスク**:
- [ ] 個別イベント同期ボタン
- [ ] 全イベント一括同期ボタン
- [ ] 同期状態表示（最終同期日時）

**UI追加**:
- 各イベントカードに「同期」ボタン
- グローバルヘッダーに「全イベント同期」ボタン
- 同期中はスピナー表示

**所要時間**: 2時間

---

#### 2.4 トリガー設定

**タスク**:
- [ ] 時間主導トリガー作成（6時間ごと）
- [ ] `syncAll()` 自動実行

**実装**:
```typescript
function setupTriggers(): void {
  // 既存トリガー削除
  ScriptApp.getProjectTriggers().forEach(trigger => {
    ScriptApp.deleteTrigger(trigger);
  });
  
  // カレンダー同期トリガー
  ScriptApp.newTrigger('syncAll')
    .timeBased()
    .everyHours(6)
    .create();
}
```

**所要時間**: 1時間

---

#### 2.5 エラーハンドリング・リトライ

**タスク**:
- [ ] exponential backoff 実装
- [ ] API呼び出し失敗時のリトライ

**実装ファイル**: `src/server/utils.ts`

**関数**:
```typescript
function callWithRetry<T>(fn: () => T, maxRetries = 3): T
```

**所要時間**: 2時間

---

#### 2.6 個人カレンダー共有機能

**タスク**:
- [ ] UserPreferencesシート作成
- [ ] カレンダー共有申請機能実装（ACL）
- [ ] カレンダー共有解除機能実装
- [ ] 管理画面：共有ユーザー管理機能
- [ ] iCalファイル生成機能（匿名モード用）

**実装ファイル**: `src/server/calendar.ts`

**関数**:
```typescript
// カレンダー共有（Google認証モード）
function requestCalendarAccess(sessionId: string): boolean
function revokeCalendarAccess(userHash: string): boolean
function listCalendarShares(): Array<SharedUser>

// iCalファイル生成（匿名モード）
function generateICalFile(eventId: string): string
function downloadICalFile(eventId: string): void
```

**実装内容**:

**1. ACLベースの共有（Google認証）**
```typescript
// ユーザーが「カレンダーに追加」ボタンをクリック
function requestCalendarAccess(sessionId: string): boolean {
  const session = getSession(sessionId);
  const email = session.email; // セッションから取得
  
  // ACLで参照権限を付与
  Calendar.Acl.insert({
    role: 'reader',
    scope: { type: 'user', value: email }
  }, calendarId);
  
  // UserPreferencesに記録（メールは保存しない）
  saveUserPreference(session.userHash, 'calendarShared', true);
  
  return true;
}
```

**2. iCalファイル生成（匿名）**
```typescript
// .icsファイルを生成してダウンロード
function generateICalFile(eventId: string): string {
  const event = getEventById(eventId);
  
  return `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
UID:${event.id}@band-app.com
DTSTART:${formatICalDate(event.start)}
DTEND:${formatICalDate(event.end)}
SUMMARY:${event.title}
LOCATION:${event.location}
END:VEVENT
END:VCALENDAR`;
}
```

**3. 管理画面：共有ユーザー管理**
- 共有中のユーザー一覧表示
- 個別に共有解除ボタン
- 退団者の権限削除

**UI追加**:
- ユーザー設定画面に「カレンダーに追加」ボタン
- イベントカードに「📅 カレンダーに追加」ボタン（匿名時はiCalダウンロード）
- 管理画面に「共有ユーザー管理」セクション

**テスト**:
- [ ] Google認証ユーザーがカレンダー共有申請できる
- [ ] Gmailに共有通知が届く
- [ ] ユーザーのGoogleカレンダーに追加される
- [ ] イベント作成・更新が自動同期される
- [ ] 共有解除が正常に動作する
- [ ] 匿名ユーザーがiCalファイルをダウンロードできる
- [ ] ダウンロードした.icsファイルをカレンダーに追加できる
- [ ] 管理画面で共有ユーザー一覧が表示される

**所要時間**: 6時間

---

### Phase 2 完了条件

- [x] 専用カレンダーが作成される
- [x] イベント作成/更新時にカレンダー反映される
- [x] カレンダーから手動同期できる
- [x] 出欠サマリーがカレンダー説明欄に表示される
- [x] トリガーで自動同期される（6時間ごと）
- [x] 同期エラーが適切にハンドリングされる
- [x] 個人カレンダー共有機能が動作する（Google認証）
- [x] iCalファイルダウンロードが動作する（匿名）
- [x] 管理画面で共有ユーザー管理ができる

### Phase 2 テスト項目

- [ ] 専用カレンダー作成 → 正常に作成されるか
- [ ] イベント作成 → カレンダーに表示されるか
- [ ] 出欠登録 → カレンダー説明欄が更新されるか
- [ ] カレンダーで直接作成 → アプリに取り込まれるか
- [ ] カレンダーで削除 → アプリでstatus='deleted'になるか
- [ ] 同期エラー → ログに記録されるか
- [ ] トリガー実行 → 正常に動作するか
- [ ] カレンダー共有申請 → ACLが正しく設定されるか
- [ ] 共有後 → ユーザーのカレンダーに表示されるか
- [ ] イベント更新 → 共有カレンダーにも反映されるか
- [ ] 共有解除 → ACLから削除されるか
- [ ] iCalダウンロード → 正しいフォーマットで生成されるか
- [ ] iCalをカレンダーに追加 → 正常に表示されるか

### Phase 2 完了時の対応

**完了条件を満たしたら**: 完了報告をして、Phase 4 に進む（Phase 3 完了待ち）

---

## Phase 3: 認証・セキュリティ

### 目的

Google認証と匿名モードの両対応、セキュリティ対策を実装する。

### 作業項目

#### 3.1 認証基盤実装

**タスク**:
- [ ] 認証モード判定処理
- [ ] ハイブリッド認証フロー実装

**実装ファイル**: `src/server/auth.ts`

**関数**:
```typescript
function getAuthMode(): 'google' | 'anonymous'
function authenticate(authInfo: any): string | null
function isAdmin(userKey: string, adminToken?: string): boolean
```

**所要時間**: 3時間

---

#### 3.2 Google認証実装

**タスク**:
- [ ] Google Identity Services 統合
- [ ] IDトークン検証
- [ ] セッション管理（2層キャッシュ）

**実装ファイル**: `src/server/auth.ts`

**関数**:
```typescript
function validateGoogleToken(idToken: string): UserInfo | null
function hashUserId(sub: string): string
function login(idToken: string): string
function logout(sessionId: string): void
```

**フロントエンド**:
- Google Identity Services ボタン追加
- IDトークン取得処理
- localStorage にsessionId保存

**所要時間**: 5時間

---

#### 3.3 セッション管理実装

**タスク**:
- [ ] 2層キャッシュ実装（Cache + Spreadsheet）
- [ ] セッション自動延長
- [ ] セッションクリーンアップ

**実装ファイル**: `src/server/auth.ts`

**関数**:
```typescript
function createSession(userHash: string): string
function getSession(sessionId: string): Session | null
function updateLastAccess(sessionId: string): void
function cleanupOldSessions(): void
```

**トリガー**:
- 日次でクリーンアップ実行（深夜2時）

**所要時間**: 4時間

---

#### 3.4 匿名モード実装

**タスク**:
- [ ] ニックネーム入力UI
- [ ] localStorage でニックネーム保持
- [ ] 管理者トークン判定

**実装ファイル**: `src/server/auth.ts`

**関数**:
```typescript
function generateAdminToken(): string
function verifyAdminToken(token: string): boolean
```

**初回デプロイ時**:
- 管理者トークン自動生成
- ログに表示

**所要時間**: 2時間

---

#### 3.5 管理者権限実装

**タスク**:
- [ ] 管理者判定処理（ハイブリッド）
- [ ] 管理画面アクセス制御

**実装**:
```typescript
function isAdmin(userKey: string, adminToken?: string): boolean {
  const config = getConfig();
  
  if (config.AUTH_MODE === 'google') {
    // Configシートのメールリストで判定
    const session = getSession(userKey); // userKeyはsessionId
    const email = getUserEmail(session.userHash);
    return config.ADMIN_EMAILS.includes(email);
  } else {
    // トークンで判定
    return verifyAdminToken(adminToken);
  }
}
```

**所要時間**: 2時間

---

#### 3.6 セキュリティ対策実装

**タスク**:
- [ ] XSS対策（textContent使用）
- [ ] レート制限実装（匿名モード）
- [ ] 入力サニタイゼーション

**実装ファイル**: `src/server/utils.ts`

**関数**:
```typescript
function sanitizeInput(input: string): string
function checkRateLimit(userKey: string, action: string): boolean
```

**レート制限**:
- 同一userKeyで1分間に5回まで
- 超過時は60秒のクールダウン

**所要時間**: 3時間

---

#### 3.7 認証UI実装

**タスク**:
- [ ] ログイン画面
- [ ] 表示名設定画面
- [ ] ログアウト機能

**画面追加**:
- Google認証時: ログイン画面
- 初回ログイン後: 表示名設定
- ヘッダー: ログアウトボタン

**所要時間**: 4時間

---

### Phase 3 完了条件

- [x] Google認証モードが動作する
- [x] 匿名モードが動作する
- [x] Configシートで切り替え可能
- [x] セッション管理が正常動作（30日維持、自動延長）
- [x] 管理者権限が正しく判定される
- [x] セキュリティ対策が実装されている

### Phase 3 テスト項目

- [ ] Google認証 → ログイン成功するか
- [ ] セッション → 6時間後も維持されるか
- [ ] セッション → 30日後に期限切れになるか
- [ ] 匿名モード → ニックネーム入力で利用できるか
- [ ] 管理者判定 → 正しく判定されるか（両モード）
- [ ] レート制限 → 連続送信を防げるか
- [ ] 認証モード切り替え → Configシート変更で切り替わるか

### Phase 3 完了時の対応

**完了条件を満たしたら**: 完了報告をして、Phase 4 に進む（Phase 2 完了待ち）

---

## Phase 4: テスト・デプロイ

### 目的

総合テスト、最適化、本番デプロイを実施する。

### 作業項目

#### 4.1 統合テスト

**タスク**:
- [ ] 全機能の動作確認
- [ ] エッジケーステスト
- [ ] エラーハンドリング確認

**テストシナリオ**:
1. 匿名モードでイベント作成・出欠登録
2. Google認証モードに切り替え
3. ログインして出欠登録
4. 管理者でイベント編集
5. カレンダー同期確認
6. セッション期限切れ確認
7. レート制限確認

**所要時間**: 4時間

---

#### 4.2 パフォーマンス最適化

**タスク**:
- [ ] Spreadsheetアクセス最適化
- [ ] キャッシュ戦略見直し
- [ ] 不要なAPI呼び出し削減

**最適化項目**:
- バッチ読み込み（getDataRange）
- バッチ書き込み（setValues）
- Cache活用度向上

**所要時間**: 3時間

---

#### 4.3 エラーハンドリング強化

**タスク**:
- [ ] 全関数にtry-catch追加
- [ ] ユーザーフレンドリーなエラーメッセージ
- [ ] ログ出力の充実

**所要時間**: 2時間

---

#### 4.4 ドキュメント整備

**タスク**:
- [ ] README.md作成
- [ ] セットアップ手順書作成
- [ ] 運用マニュアル作成

**成果物**:
- `README.md`: プロジェクト概要、セットアップ手順
- `docs/セットアップ手順.md`: 詳細なデプロイ手順
- `docs/運用マニュアル.md`: 日常運用の手順

**所要時間**: 3時間

---

#### 4.5 本番デプロイ

**タスク**:
- [ ] Webアプリとして公開
- [ ] トリガー設定
- [ ] Script Properties設定
- [ ] 管理者トークン発行（匿名モード用）

**デプロイ手順**:
1. `tsc` でコンパイル
2. `clasp push` でデプロイ
3. GASエディタでWebアプリ公開
4. アクセス権限を「全員」に設定
5. トリガー設定（`setupTriggers()`実行）
6. 初期化スクリプト実行（`initializeSpreadsheet()`）
7. 動作確認

**所要時間**: 2時間

---

#### 4.6 受け入れテスト

**タスク**:
- [ ] 実際の利用シナリオでテスト
- [ ] モバイル・デスクトップで確認
- [ ] 複数ブラウザで確認

**テスト環境**:
- Chrome, Safari, Firefox
- デスクトップ、タブレット、スマートフォン

**所要時間**: 2時間

---

### Phase 4 完了条件

- [x] 全機能が正常動作する
- [x] パフォーマンスが良好（3秒以内にページ表示）
- [x] エラーハンドリングが適切
- [x] ドキュメントが整備されている
- [x] 本番環境にデプロイされている
- [x] 受け入れテストが完了している

### Phase 4 成果物

- [ ] 本番稼働中のWebアプリ
- [ ] README.md
- [ ] セットアップ手順書
- [ ] 運用マニュアル
- [ ] テスト結果報告書

### Phase 4 完了時の対応

**完了条件を満たしたら**: 最終報告をして、プロジェクト完了

---

## リスク管理

### 想定リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|-------|-------|---------|------|
| **GASの制限（6分タイムアウト）** | 高 | 低 | 同期処理をバッチ化、exponential backoff |
| **Spreadsheetの行数制限** | 中 | 低 | 古いデータのアーカイブ機能を実装 |
| **Calendar APIクォータ超過** | 中 | 低 | 同期頻度を調整、キャッシュ活用 |
| **セッション管理の複雑さ** | 中 | 中 | 十分なテスト、ドキュメント整備 |
| **認証モード切り替えの不具合** | 高 | 中 | Phase 3で重点的にテスト |
| **モバイル表示の崩れ** | 低 | 中 | レスポンシブデザインを早期実装 |
| **個人情報漏洩** | 高 | 低 | ハッシュ化徹底、最小情報保存 |

### 依存関係

```
Phase 0 → Phase 1 → Phase 2 ↘
                  → Phase 3 → Phase 4
```

- Phase 1はPhase 0完了後
- Phase 2, 3はPhase 1完了後（並行可能）
- Phase 4はPhase 2, 3完了後

---

## バックログ（将来実装予定・未解決課題）

### Google認証（GIS）の実装問題

**問題**: GASのWebアプリでGoogle Identity Services (GIS) を使用する際、`origin_mismatch` エラーが発生し、実装が困難

**詳細**:
- GASのWebアプリは動的な `script.googleusercontent.com` サブドメインで実行される
- OAuth 2.0 Client IDの設定で、この動的なサブドメインを事前に登録することはできない
- ポップアップ方式、リダイレクト方式、`allowed_parent_origin` 設定など、複数のアプローチを試したが解決できず

**エラー内容**:
```
エラー 400: origin_mismatch
リクエストの詳細: origin=https://n-hopzlj2jdpxh5uuktj3b3lnbrah32vvkvge23ji-0lu-script.googleusercontent.com
```

**対応**:
- 現時点では匿名モードのみを使用
- Google認証機能は実装済みだが、GASのWebアプリ環境では動作しない
- 将来的な解決策:
  - GASのWebアプリ以外の環境（例: Firebase Hosting、Cloud Run）への移行を検討
  - または、GASの組み込み認証機能（`ScriptApp.getOAuthToken()`）の活用を検討
  - または、カスタム認証システムの実装を検討

**影響範囲**:
- Phase 3.2（Google認証実装）: 実装済みだが動作しない
- Phase 3.3（セッション管理実装）: 実装済み、匿名モードでは動作する
- Phase 3.5（管理者権限実装）: 匿名モード用の管理者トークンで動作

**現在の状態**: 匿名モードのみで運用可能

---

## 成果物一覧

### コード

- [ ] `src/server/*.ts` - バックエンドロジック（TypeScript）
- [ ] `src/client/*.html` - フロントエンド（HTML）
- [ ] `src/client/*.css` - スタイル
- [ ] `src/client/*.js` - フロントエンドロジック
- [ ] `src/types/*.ts` - 型定義

### ドキュメント

- [x] `docs/仕様書.md` - 詳細仕様（v1.1）
- [x] `docs/作業計画書.md` - 本ドキュメント（v1.3）
- [ ] `docs/セットアップ手順.md` - デプロイ手順
- [ ] `docs/運用マニュアル.md` - 日常運用
- [ ] `README.md` - プロジェクト概要

### 設定ファイル

- [ ] `.clasp.json` - clasp設定
- [ ] `tsconfig.json` - TypeScript設定
- [ ] `appsscript.json` - GAS設定（スコープ追加）
- [ ] `package.json` - 依存関係

### その他

- [ ] Spreadsheet（初期化済み）
- [ ] WebアプリURL
- [ ] 管理者トークン（匿名モード用）
- [ ] テスト結果報告書

---

## 進行フロー

### Phase完了時の確認事項

各Phase完了時に以下を自動確認し、自律的に次へ進む：

1. **完了条件を満たしているか**
   - チェックリストを確認
   - すべての項目が✅になっているか

2. **テストが通っているか**
   - テスト項目を実行
   - すべて合格しているか

3. **ドキュメントが更新されているか**
   - コード変更に伴うドキュメント更新
   - コメントの充実

4. **次のPhaseに進む準備ができているか**
   - 依存関係の解消
   - 環境の準備

### Phase完了後のアクション

- 完了報告をユーザーに提示
- 次のPhaseの作業を自動的に開始
- 重大な問題・判断が必要な場合のみ質問

---

## 補足事項

### 作業時の注意点

1. **自律的な進行**
   - 各Phase完了後、完了報告をして自動的に次へ進む
   - ユーザーの承認待ちはしない
   - 重大な問題・判断のみ質問

2. **質問が必要なケース**
   - 仕様が不明確で複数の解釈がある場合
   - 重要な設計判断が必要な場合
   - 3時間以上解決できない技術的問題
   - 【Question】タグで質問、【Answer】タグで回答を待つ

3. **仕様変更の報告**
   - 実装中に仕様変更が必要な場合は報告
   - 理由と代替案を提示
   - 軽微な変更は自己判断で実装後に報告

4. **コミット**
   - 自動処理に任せる（Background Agent環境）
   - 機能単位で変更をまとめる

### スケジュール調整

想定期間はあくまで目安。以下の場合は調整可能：

- 技術的な困難に直面
- 仕様変更が発生
- テストで重大な問題発見
- その他予期せぬ事態

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025-11-06 | 初版作成 |
| 1.1 | 2025-11-06 | 開発方針セクション追加（テスト駆動開発の徹底、品質保証基準） |
| 1.2 | 2025-11-06 | 作業方式を「承認待ち」→「自律的進行」に変更（Background Agent対応） |
| 1.3 | 2025-11-06 | Phase 2に個人カレンダー共有機能追加、専用カレンダー作成追加 |

---

**次のステップ**: Phase 0（環境セットアップ）を自律的に開始

**準備完了！** 🚀
