# GAS カレンダー同期 cron ジョブ セットアップガイド

## 📋 概要

Google カレンダーとアプリの双方向同期を自動化する cron ジョブのセットアップ方法です。

- **15分ごと**: 出欠更新の差分同期（カレンダー側の変更も取り込む）
- **1時間ごと**: 全体同期（新規イベント検知、確実性の確保）

---

## ✨ 実装内容

### 実装済みの関数

#### 1. `scheduledSyncResponsesToCalendar()` - 15分ごとの差分同期
- **用途**: 出欠更新を効率的に同期（双方向）
- **重複防止**: 10分以内の再実行を自動的にスキップ
- **同期方向**: 
  - ✅ アプリ → カレンダー（出欠状況の反映）
  - ✅ カレンダー → アプリ（タイトル、日時、説明欄の変更を取り込む）
- **API呼び出し**: 2-10回/実行（更新されたイベントのみ）

#### 2. `scheduledFullSync()` - 1時間ごとの全体同期
- **用途**: 表示期間内の全イベントを双方向同期
- **同期方向**:
  - ✅ カレンダー → アプリ（新規イベント検知、イベント情報の変更反映）
  - ✅ アプリ → カレンダー（出欠状況の反映）
- **API呼び出し**: 35-50回/実行（表示期間内の全イベント）
- **メリット**: 差分同期で漏れた変更も確実に反映

#### 3. `syncResponsesDiffToCalendar()`
- **用途**: 差分検知と双方向同期処理の実行
- **差分検知**: Responses シートの F列（updatedAt）を使用
- **同期対象**: 前回同期以降に更新されたイベントのみ
- **カレンダー側の変更**: `calendarEvent.getLastUpdated()` で検知して取り込む

---

## 🔧 セットアップ手順

### ステップ1: GAS エディタを開く

1. Google Drive で該当のスプレッドシートを開く
2. **拡張機能 > Apps Script** をクリック

### ステップ2: トリガーを設定

#### トリガー1: 15分ごとの差分同期（必須）

1. GAS エディタで **トリガー（時計アイコン）** をクリック
2. **トリガーを追加** をクリック
3. 以下のように設定:
   - **実行する関数を選択**: `scheduledSyncResponsesToCalendar`
   - **実行するデプロイを選択**: `Head`
   - **イベントのソースを選択**: `時間主導型`
   - **時間ベースのトリガーのタイプを選択**: `分ベースのタイマー`
   - **時間の間隔を選択（分）**: `15分ごと`
4. **保存** をクリック

#### トリガー2: 1時間ごとの全体同期（推奨）

1. GAS エディタで **トリガー（時計アイコン）** をクリック
2. **トリガーを追加** をクリック
3. 以下のように設定:
   - **実行する関数を選択**: `scheduledFullSync`
   - **実行するデプロイを選択**: `Head`
   - **イベントのソースを選択**: `時間主導型`
   - **時間ベースのトリガーのタイプを選択**: `時間ベースのタイマー`
   - **時間の間隔を選択**: `1時間ごと`
4. **保存** をクリック

> **推奨理由**: 
> - 15分ごとの差分同期で出欠更新をリアルタイムに反映
> - 1時間ごとの全体同期で新規イベント検知や同期漏れを防止
> - API使用率は約0.3%以下で、制限に全く問題なし

#### トリガー3: 5分ごとの高頻度同期（オプション、土日12:40-13:20用）

1. GAS エディタで **トリガー（時計アイコン）** をクリック
2. **トリガーを追加** をクリック
3. 以下のように設定:
   - **実行する関数を選択**: `scheduledSyncResponsesToCalendar`
   - **実行するデプロイを選択**: `Head`
   - **イベントのソースを選択**: `時間主導型`
   - **時間ベースのトリガーのタイプを選択**: `分ベースのタイマー`
   - **時間の間隔を選択（分）**: `5分ごと`
4. **保存** をクリック

> **注意**: 
> - 5分ごとのトリガーは全日実行されますが、関数内の重複防止ロジック（10分以内の再実行をスキップ）により、15分ごとのトリガーと重複しても自動的にスキップされます
> - 土日12:40-13:20のみ実行したい場合は、外部のスケジューラーやトリガー管理ツールを使用するか、関数内に時刻チェックを追加してください

---

## 🧹 リンク切れレスポンスお掃除バッチ

メンバーが削除された後に残ってしまう Responses シートのリンク切れデータを、深夜など負荷の低い時間帯にまとめて削除するトリガーを追加します。

### 実装済みの関数

- `scheduledCleanupUnlinkedResponses()`
  - **用途**: メンバーシートと突き合わせ、`Members` に存在しない `userKey` のレスポンスを一括削除
  - **動作**: シートを読み込み → リンク切れレスポンスのみ除外 → シートを書き戻し（ヘッダー装飾も復元）
  - **推奨実行タイミング**: 深夜1回（例: 03:00）

### トリガー設定手順

1. GAS エディタで **トリガー（時計アイコン）** をクリック
2. **トリガーを追加** をクリック
3. 以下のように設定:
   - **実行する関数を選択**: `scheduledCleanupUnlinkedResponses`
   - **実行するデプロイを選択**: `Head`
   - **イベントのソースを選択**: `時間主導型`
   - **時間ベースのトリガーのタイプを選択**: `日付ベースのタイマー`
   - **時間の間隔を選択**: `日付ベースのタイマー` → `午前3時～4時` など任意の深夜帯
4. **保存** をクリック

> **メモ**: レスポンス数が極端に多い場合は、一括書き戻しに数十秒かかることがあります。必ず他の定期実行（差分同期など）と時間が重ならないようにしてください。

### 手動実行用API

- `adminCleanupUnlinkedResponses(userKey?, adminToken?)`
  - 管理画面やツールからスポット実行したい場合に使用
  - 管理者認証に成功すると `deleted` / `total` 件数を返します
  - 手動でのテストや一時的な再実行に利用してください

---

## 📊 実行頻度とAPI使用量

### 推奨構成（15分ごと + 1時間ごと）

#### トリガー実行回数
- **15分ごとの差分同期**: 96回/日
- **1時間ごとの全体同期**: 24回/日
- **合計**: 120回/日

#### API呼び出し回数（通常運用時）
- **差分同期**: 2-10回/実行 × 96回/日 = **192-960回/日**
- **全体同期**: 35-50回/実行 × 24回/日 = **840-1200回/日**
- **合計**: **約1000-2200回/日**

#### API呼び出し回数（活発な使用時）
- **差分同期**: 10-20回/実行 × 96回/日 = **960-1920回/日**
- **全体同期**: 60回/実行 × 24回/日 = **1440回/日**
- **合計**: **約2400-3360回/日**

### API制限との比較

| 項目 | 値 |
|------|-----|
| Google Calendar API制限 | **1,000,000リクエスト/日** |
| 通常運用時の使用量 | 約1,000-2,200回/日 |
| 活発な使用時の使用量 | 約2,400-3,360回/日 |
| **使用率** | **0.1-0.3%** |

✅ **結論**: API制限に対して十分な余裕があり、全く問題ありません。

### 重複防止の仕組み
- `scheduledSyncResponsesToCalendar` は前回同期から10分以内の場合は自動的にスキップされます
- これにより、15分ごとと5分ごとのトリガーが同時に実行されても、重複実行を防止できます

---

## 🔍 動作確認

### ログの確認

1. GAS エディタで **実行数 > 実行ログ** をクリック
2. 以下のようなログが表示されることを確認:

#### 15分ごとの差分同期ログ

**更新がある場合:**
```
📅 [cron 15分] 同期開始: 2025-12-14T10:00:00.000Z
📊 前回同期時刻: 2025-12-14T09:45:00.000Z
🔍 差分検知: 3件のイベントに更新あり
✅ カレンダー→アプリ同期: event-1
✅ 同期成功: event-1
✅ 同期成功: event-2
✅ 同期成功: event-3
✅ [cron 15分] 同期完了: 3件同期, 0件失敗, 0件スキップ
```

**更新がない場合:**
```
📅 [cron 15分] 同期開始: 2025-12-14T10:15:00.000Z
📊 前回同期時刻: 2025-12-14T10:00:00.000Z
🔍 差分検知: 0件のイベントに更新あり
✨ 更新なし - カレンダー同期をスキップ
✅ [cron 15分] 同期完了: 0件同期, 0件失敗, 0件スキップ
```

#### 1時間ごとの全体同期ログ

```
📅 [cron 1時間ごと] 全体同期開始
✅ [cron 1時間ごと] 全体同期完了: 35件成功, 0件失敗
```

---

## 🗂️ PropertiesService のキー

### `LAST_CRON_CALENDAR_SYNC_TIMESTAMP`
- **用途**: 前回同期時刻を保存
- **形式**: ISO 8601形式（例: `2025-11-14T10:00:00.000Z`）
- **保存場所**: Script Properties

### 確認方法

GAS エディタで以下のスクリプトを実行:

```javascript
function checkLastSyncTime() {
  const properties = PropertiesService.getScriptProperties();
  const lastSync = properties.getProperty('LAST_CRON_CALENDAR_SYNC_TIMESTAMP');
  Logger.log(`前回同期時刻: ${lastSync}`);
}
```

---

## 🛠️ トラブルシューティング

### 1. トリガーが実行されない

**確認事項**:
- トリガーが正しく設定されているか確認
- GAS エディタの **実行数 > 実行ログ** でエラーを確認

**対処法**:
- トリガーを削除して再設定
- 関数名のスペルミスがないか確認

### 2. 同期が実行されない（更新なし）

**確認事項**:
- Responses シートに updatedAt が正しく記録されているか
- 前回同期時刻が正しいか（`checkLastSyncTime()` で確認）

**対処法**:
- PropertiesService をリセット:
  ```javascript
  function resetLastSyncTime() {
    const properties = PropertiesService.getScriptProperties();
    properties.deleteProperty('LAST_CRON_CALENDAR_SYNC_TIMESTAMP');
    Logger.log('前回同期時刻をリセットしました');
  }
  ```

### 3. エラーが発生する

**確認事項**:
- ログで詳細なエラーメッセージを確認
- Responses シートの F列（updatedAt）の形式が正しいか

**対処法**:
- ログに表示されたエラーメッセージを確認して修正
- 必要に応じて手動で `syncCalendarDescriptionForEvent(eventId)` を実行

---

## 📈 パフォーマンス

### API 呼び出し回数

- **更新がない場合**: Spreadsheet API 1回のみ（差分検知）
- **更新がある場合**: Spreadsheet API 1回 + Calendar API N回（N = 更新されたイベント数）

### 実行時間

- **更新がない場合**: 約1秒
- **更新がある場合**: 約1秒 + N × 2秒（N = 更新されたイベント数）

### GAS 実行時間制限

- **1回あたりの最大実行時間**: 6分
- **1日あたりの最大実行時間**: 90分

**推定使用時間**:
- 平日: 64回 × 1秒 = 約1分
- 土日: 352回 × 1秒 = 約6分
- **合計**: 約7分/日（制限90分/日の約8%）

---

## ✅ チェックリスト

- [ ] `scheduledSyncResponsesToCalendar` のトリガーを設定（15分ごと、必須）
- [ ] `scheduledFullSync` のトリガーを設定（1時間ごと、推奨）
- [ ] `scheduledSyncResponsesToCalendar` のトリガーを設定（5分ごと、オプション）
- [ ] 実行ログで動作を確認
- [ ] カレンダーに出欠が正しく同期されているか確認
- [ ] カレンダー側で変更したタイトル・日時がアプリに反映されるか確認

---

## 📝 備考

### 差分同期の処理フロー（15分ごと）

1. **差分検知**: Responses シートの F列（updatedAt）を全行スキャン
2. **前回同期時刻と比較**: updatedAt > 前回同期時刻 の行を抽出
3. **イベントID収集**: 抽出された行の eventId をユニークに集計
4. **双方向同期**:
   - カレンダーイベントを取得（`calendar.getEventById()`）
   - カレンダー側が新しい場合、アプリに反映（タイトル、日時、説明欄）
   - アプリ側の出欠をカレンダーに反映（`syncCalendarDescriptionForEvent()`）

### 全体同期の処理フロー（1時間ごと）

1. **カレンダー → アプリ**: 表示期間内の全イベントを取得（`pullFromCalendar()`）
   - 新規イベント検知
   - イベント情報の変更反映
2. **アプリ → カレンダー**: 全イベントの出欠状況を反映
3. **notesHash**: 説明欄のハッシュ値を比較して無限ループを防止

### 同期の優先順位

- **差分同期**: リアルタイム性重視（15分以内に反映）
- **全体同期**: 確実性重視（同期漏れを防止、新規イベント検知）

---

## 🔗 関連ドキュメント

- [CALENDAR_SYNC_CALL_PATHS.md](./CALENDAR_SYNC_CALL_PATHS.md) - カレンダー同期の導線一覧
- [CALENDAR_SYNC_STATUS_CHECK.md](./CALENDAR_SYNC_STATUS_CHECK.md) - カレンダー同期の状態確認

